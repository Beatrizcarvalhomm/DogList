<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doglist - Mapa</title>
    <!-- Favicon em vários tamanhos para melhor suporte -->
    <link rel="icon" href="Images/DogList-Logo.png" type="image/png" sizes="32x32">
    <link rel="icon" href="Images/DogList-Logo.png" type="image/png" sizes="96x96">
    <link rel="icon" href="Images/DogList-Logo.png" type="image/png" sizes="192x192">
    <link rel="apple-touch-icon" href="Images/DogList-Logo.png">
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #FFE4D6;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #FFE4D6;
            position: relative;
        }

        .content {
            flex: 1;
            padding: 20px;
            background-color: transparent;
            overflow-y: auto;
        }

        #map {
            flex: 1;
            width: 100%;
            background: #f0f0f0;
            z-index: 1;
            height: calc(100vh - 80px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.7);
            overflow: hidden;
            position: relative;
        }

        .map-legend {
            position: absolute;
            bottom: 140px;
            left: 20px;
            padding: 12px;
            border-radius: 12px;
            background-color: rgba(255, 255, 255, 0.85);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 180px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
        }

        .map-legend:hover {
            background-color: rgba(255, 255, 255, 0.9);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 15px;
            color: #333;
            padding: 6px 10px;
            transition: all 0.3s ease;
            border-radius: 6px;
            background-color: transparent;
        }
        
        .legend-item.clickable {
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        
        .legend-item.clickable:hover {
            background-color: rgba(255, 127, 80, 0.08);
            border-left: 3px solid rgba(255, 127, 80, 0.8);
        }

        .legend-color {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            margin-right: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .legend-text {
            font-weight: 500;
            font-size: 15px;
        }

        #legendVoceEstaAqui {
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        #legendVoceEstaAqui:hover {
            background-color: rgba(255, 127, 80, 0.08);
            border-left: 3px solid rgba(255, 127, 80, 0.8);
        }
        
        .refresh-location {
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            margin-top: 8px;
            padding-top: 12px;
        }

        .navigation {
            position: fixed;
            bottom: 20px;
            padding: 15px;
            background-color: #FFFFFF;
            border-radius: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            margin: 0 20px 20px;
            width: calc(100% - 40px);
            border-radius: 30px;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .nav-item {
            color: #FF7F50;
            text-decoration: none;
            font-size: 26px;
            padding: 18px;
            border-radius: 22px;
            transition: all 0.3s ease;
            width: 75px;
            height: 75px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            position: relative;
            z-index: 10000;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .nav-item:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FF7F50, #FF6347);
            opacity: 0;
            border-radius: 22px;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .nav-item:hover:before, .nav-item:active:before {
            opacity: 0.15;
        }

        .nav-item:hover, .nav-item:active {
            color: #FF6347;
            background-color: #fff;
            box-shadow: 0 8px 20px rgba(255, 127, 80, 0.25);
            transform: translateY(-5px);
        }

        .nav-item.active {
            color: white;
            background: linear-gradient(135deg, #FF7F50, #FF6347);
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(255, 127, 80, 0.3);
        }

        .nav-item i {
            transition: all 0.3s ease;
        }

        .nav-item:hover i {
            color: #FF6347;
        }
        
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px 25px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        .loading-indicator i {
            color: #FF7F50;
            animation: spin 1s linear infinite;
            font-size: 22px;
        }
        
        .loading-indicator span {
            font-weight: 500;
            color: #333;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Removendo estilos do banner */
        .location-banner {
            display: none !important;
        }
        
        /* Ajustes responsivos para telas menores */
        @media (max-width: 768px) {
            .map-legend {
                bottom: 130px;
                left: 20px;
                padding: 10px;
                max-width: calc(100% - 40px);
                background-color: rgba(255, 255, 255, 0.85);
                border-radius: 10px;
                min-width: 150px;
            }
            
            .legend-item {
                margin: 8px 0;
                padding: 5px 8px;
                font-size: 14px;
                background-color: transparent;
            }
            
            .legend-color {
                width: 24px;
                height: 24px;
                margin-right: 10px;
            }
            
            .legend-text {
                font-size: 14px;
            }
            
            .legend-color i {
                font-size: 14px !important;
            }
            
            .nav-item {
                width: 60px;
                height: 60px;
                font-size: 22px;
                padding: 12px;
            }
            
            .navigation {
                padding: 12px;
                margin: 0 15px 15px;
                width: calc(100% - 30px);
            }
            
            .add-dog-btn {
                bottom: 160px;
            }
        }
        
        /* Ajustes adicionais para telas muito pequenas */
        @media (max-width: 480px) {
            .map-legend {
                bottom: 120px;
                left: 15px;
                padding: 8px;
                max-width: calc(100% - 30px);
                border-radius: 8px;
                background-color: rgba(255, 255, 255, 0.85);
            }
            
            .legend-item {
                margin: 6px 0;
                padding: 4px 8px;
                font-size: 13px;
                background-color: transparent;
            }
            
            .legend-color {
                width: 22px;
                height: 22px;
                margin-right: 8px;
            }
            
            .legend-text {
                font-size: 13px;
            }
            
            .legend-color i {
                font-size: 12px !important;
            }
            
            .nav-item {
                width: 50px;
                height: 50px;
                font-size: 20px;
                padding: 10px;
                border-radius: 18px;
            }
            
            .navigation {
                padding: 10px;
                border-radius: 25px;
            }
            
            .add-dog-btn {
                bottom: 140px;
                right: 45px;
                width: 42px;
                height: 42px;
            }
        }

        .add-dog-btn {
            position: absolute;
            right: 60px;
            bottom: 160px;
            background: linear-gradient(135deg, #FF7F50, #FF6347);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 127, 80, 0.4);
            border: none;
            font-size: 20px;
            transition: all 0.3s ease;
            z-index: 1000;
            text-decoration: none;
        }
        
        .add-dog-btn:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 127, 80, 0.5);
        }
        
        .add-dog-btn:active {
            transform: scale(0.95);
        }
        
        /* Additional responsive adjustments for the add-dog button */
        @media (min-width: 769px) {
            .add-dog-btn {
                bottom: 160px;
                right: 75px;
            }
        }
        
        @media (max-width: 768px) {
            .add-dog-btn {
                bottom: 160px;
            }
        }
        
        @media (max-width: 480px) {
            .add-dog-btn {
                bottom: 140px;
                right: 45px;
                width: 42px;
                height: 42px;
            }
        }

        .header {
            background-color: #FFFFFF;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            margin: 0 20px;
            border-radius: 0 0 20px 20px;
            height: 60px;
            box-sizing: border-box;
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 20px;
                margin: 0 10px;
                height: 60px;
            }
            
            .title {
                font-size: 20px;
            }
            
            .back-button {
                left: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 0 15px;
                margin: 0 8px;
                height: 50px;
            }
            
            .title {
                font-size: 18px;
            }
            
            .back-button {
                font-size: 22px;
                width: 35px;
                height: 35px;
                left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="map"></div>
        <div class="loading-indicator" id="loadingIndicator">
            <i class="fas fa-spinner"></i>
            <span>Carregando...</span>
        </div>

        <a href="add-dog.html" class="add-dog-btn">
            <i class="fas fa-plus"></i>
        </a>

        <div class="map-legend">
            <div class="legend-item clickable" id="legendVoceEstaAqui" onclick="centerMapOnUserLocation()">
                <div class="legend-color" style="background-color: #007bff;"></div>
                <span class="legend-text">Você está aqui</span>
            </div>
            <div class="legend-item" id="legendProcurados">
                <div class="legend-color" style="background-color: #e74c3c;"></div>
                <span class="legend-text">Procurados</span>
            </div>
            <div class="legend-item" id="legendEncontrados">
                <div class="legend-color" style="background-color: #27ae60;"></div>
                <span class="legend-text">Encontrados</span>
            </div>
            <div class="legend-item clickable" id="legendAbrigos" onclick="toggleSheltersVisibility()">
                <div class="legend-color" style="background-color: #ff9800;"></div>
                <span class="legend-text">Abrigos Temporários</span>
            </div>
            <div class="legend-item clickable refresh-location" onclick="refreshUserLocation()">
                <div class="legend-color" style="background-color: #ffffff; display: flex; justify-content: center; align-items: center;">
                    <i class="fas fa-sync-alt" style="color: #FF7F50;"></i>
                </div>
                <span class="legend-text">Atualizar localização</span>
            </div>
        </div>

        <nav class="navigation">
            <a href="search.html" class="nav-item"><i class="fas fa-search"></i></a>
            <a href="account.html" class="nav-item"><i class="fas fa-user"></i></a>
            <a href="clinics.html" class="nav-item"><i class="fas fa-hospital"></i></a>
        </nav>
    </div>

    <!-- Font Awesome (carregado de novo para garantir) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <script>
        // Verificar se está logado
        if (!localStorage.getItem('loggedIn')) {
            window.location.href = 'index.html';
        }
        
        // Variáveis globais
        let map;
        let userMarker;
        let petMarkers = [];
        let shelterMarkers = [];
        let infoWindow;
        let geocoder;
        let currentOpenInfoWindow = null;
        
        // Variável para controlar visibilidade
        let showingOnlyShelters = false;
        
        function initMap() {
            try {
                console.log("Iniciando função initMap");
                document.getElementById('loadingIndicator').style.display = 'flex';
                
                // Verificar se o elemento map existe
                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    console.error("Elemento 'map' não encontrado no DOM!");
                    return;
                }
                
                // Mostrar dimensões do mapa para debug
                console.log("Dimensões do mapa:", mapElement.offsetWidth, "x", mapElement.offsetHeight);
            
                // Carregar mapa
                map = new google.maps.Map(mapElement, {
                    center: { lat: -23.550520, lng: -46.633308 }, // São Paulo
                    zoom: 12,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                        position: google.maps.ControlPosition.TOP_RIGHT
                    },
                    fullscreenControl: true,
                    fullscreenControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP
                    },
                    streetViewControl: true,
                    streetViewControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP
                    },
                    zoomControl: true,
                    zoomControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP
                    }
                });
                
                // Verificar se o mapa foi inicializado corretamente
                if (!map) {
                    console.error("Falha ao inicializar o mapa. O objeto do mapa é indefinido.");
                    return;
                }
                
                console.log("Mapa inicializado com sucesso!");
                
                // Criar infowindow para uso global
                infoWindow = new google.maps.InfoWindow({
                    maxWidth: 300,
                    disableAutoPan: false
                });
                
                // Inicializar o tema de mapa padrão
                const savedMapType = localStorage.getItem('mapType') || 'roadmap';
                map.setMapTypeId(savedMapType);
                
                // Tentar obter localização salva
                const savedLocation = getSavedLocation();
                if (savedLocation) {
                    console.log("Localização salva encontrada:", savedLocation);
                    // Centralizar mapa na localização salva
                    map.setCenter(savedLocation);
                    
                    // Adicionar marcador do usuário
                    addUserMarker(savedLocation);
                } else {
                    console.log("Nenhuma localização salva, tentando obter localização atual");
                    // Tentar obter localização do usuário
                    requestUserLocation();
                }
                
                // Evento para marcar como finalizado o carregamento do mapa
                google.maps.event.addListenerOnce(map, 'idle', function() {
                    console.log("Mapa carregado e pronto");
                    document.getElementById('loadingIndicator').style.display = 'none';
                    
                    // Carregar todos os cães
                    loadAllDogs();
                });
                
                console.log("Função initMap concluída com sucesso");
            } catch (error) {
                console.error("ERRO ao inicializar o mapa:", error);
                alert("Ocorreu um erro ao inicializar o mapa. Por favor, tente recarregar a página.");
            }
        }
        
        function getSavedLocation() {
            const savedLat = localStorage.getItem('userLocationLat');
            const savedLng = localStorage.getItem('userLocationLng');
            
            if (savedLat && savedLng) {
                return {
                    lat: parseFloat(savedLat),
                    lng: parseFloat(savedLng)
                };
            }
            
            return null;
        }
        
        function saveUserLocation(location) {
            localStorage.setItem('userLocationLat', location.lat);
            localStorage.setItem('userLocationLng', location.lng);
        }
        
        function addUserMarker(location) {
            // Remover marcador existente, se houver
            if (userMarker) {
                userMarker.setMap(null);
            }
            
            // Criar novo marcador do usuário
            userMarker = new google.maps.Marker({
                position: location,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: '#007bff',
                    fillOpacity: 0.9,
                    strokeColor: '#FFFFFF',
                    strokeWeight: 2,
                    scale: 8
                },
                title: 'Sua localização',
                zIndex: 10
            });
            
            // Adicionar evento de clique ao marcador
            userMarker.addListener('click', () => {
                showLocationPopup(userMarker);
            });

            return userMarker;
        }
        
        function addPetMarkers() {
            // Limpar marcadores existentes
            clearPetMarkers();
            
            const allDogs = JSON.parse(localStorage.getItem('allDogs') || '[]');
            console.log(`Carregando ${allDogs.length} cães:`, allDogs);
            
            if (allDogs.length === 0) {
                console.log('Nenhum cão cadastrado para exibir no mapa');
                return;
            }
            
            allDogs.forEach((dog) => {
                if (dog.location && dog.location.lat && dog.location.lng) {
                    addDogMarker(dog);
                }
            });
            
            // Também recarregar abrigos temporários
            loadTemporaryShelters();
        }
        
        function addDogMarker(dog) {
            try {
                // Verificar e normalizar a localização
                let lat, lng;
                
                if (dog.location) {
                    if (typeof dog.location === 'object') {
                        lat = parseFloat(dog.location.lat);
                        lng = parseFloat(dog.location.lng);
                    }
                } else if (dog.lat && dog.lng) {
                    lat = parseFloat(dog.lat);
                    lng = parseFloat(dog.lng);
                } else {
                    return null;
                }
                
                if (isNaN(lat) || isNaN(lng)) {
                    return null;
                }
                
                // Definir cor com base no estado do cachorro
                const pawColor = dog.estado === 'procurado' ? '#ff0000' : '#00ff00';
                
                const svgMarker = {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: pawColor,
                    fillOpacity: 1,
                    strokeWeight: 1,
                    strokeColor: '#ffffff',
                    scale: 10
                };
                
                // Criar o marcador com o ícone customizado
                const marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: showingOnlyShelters ? null : map,
                    icon: svgMarker,
                    title: dog.nome || dog.raca || 'Cachorro sem nome',
                    animation: google.maps.Animation.DROP
                });
                
                // Armazenar os dados do cão no marcador para facilitar filtragem
                marker.dogData = dog;
                
                // Adicionar o marcador ao array
                petMarkers.push(marker);
                
                return marker;
            } catch (error) {
                console.error('Erro ao criar marcador para o cão:', error);
                return null;
            }
        }
        
        function clearPetMarkers() {
            // Limpar todos os marcadores existentes
            petMarkers.forEach(marker => marker.setMap(null));
            petMarkers = [];
        }
        
        function clearShelterMarkers() {
            // Limpar marcadores de abrigos existentes
            shelterMarkers.forEach(marker => marker.setMap(null));
            shelterMarkers = [];
        }
        
        function loadAllDogs() {
            try {
                // Carregar todos os cães
                const allDogsData = localStorage.getItem('allDogs');
                if (!allDogsData) {
                    console.log('Nenhum dado de cães encontrado');
                    return;
                }
                
                // Adicionar todos os cães ao mapa
                addPetMarkers();
            } catch (error) {
                console.error('Erro ao carregar cães:', error);
            }
        }
        
        function loadTemporaryShelters() {
            try {
                const sheltersData = localStorage.getItem('shelters');
                if (!sheltersData) {
                    console.log('Nenhum abrigo temporário encontrado');
                    return;
                }
                
                const shelters = JSON.parse(sheltersData);
                console.log(`Carregando ${shelters.length} abrigos temporários`);
                
                // Adicionar marcadores de abrigo ao mapa
                addShelterMarkers(shelters);
            } catch (error) {
                console.error('Erro ao carregar abrigos temporários:', error);
            }
        }
        
        function addShelterMarkers(shelters) {
            // Limpar marcadores de abrigos existentes
            clearShelterMarkers();
            
            shelters.forEach(shelter => {
                if (shelter.location && shelter.location.lat && shelter.location.lng) {
                    // Criar marcador de abrigo
                    const marker = new google.maps.Marker({
                        position: { 
                            lat: parseFloat(shelter.location.lat), 
                            lng: parseFloat(shelter.location.lng) 
                        },
                        map: showingOnlyShelters ? map : null, // Inicialmente invisível
                        title: 'Abrigo Temporário',
                        animation: google.maps.Animation.DROP,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: '#ff9800',
                            fillOpacity: 0.9,
                            strokeColor: '#FFFFFF',
                            strokeWeight: 2,
                            scale: 10
                        }
                    });
                    
                    // Armazenar o abrigo no marcador
                    marker.shelterData = shelter;
                    
                    // Adicionar marcador ao array
                    shelterMarkers.push(marker);
                }
            });
        }
        
        // Função para alternar a visibilidade dos abrigos temporários
        function toggleSheltersVisibility() {
            const legendItem = document.getElementById('legendAbrigos');
            const legendProcurados = document.getElementById('legendProcurados');
            const legendEncontrados = document.getElementById('legendEncontrados');
            
            if (!showingOnlyShelters) {
                // Mostrar apenas abrigos (esconder cães)
                shelterMarkers.forEach(marker => marker.setMap(map));
                petMarkers.forEach(marker => marker.setMap(null));
                
                // Atualizar aparência das legendas
                legendItem.style.opacity = '1';
                legendItem.querySelector('.legend-color').style.opacity = '1';
                legendProcurados.style.opacity = '0.5';
                legendProcurados.querySelector('.legend-color').style.opacity = '0.3';
                legendEncontrados.style.opacity = '0.5';
                legendEncontrados.querySelector('.legend-color').style.opacity = '0.3';
                
                showingOnlyShelters = true;
            } else {
                // Mostrar apenas cães (esconder abrigos)
                shelterMarkers.forEach(marker => marker.setMap(null));
                petMarkers.forEach(marker => marker.setMap(map));
                
                // Atualizar aparência das legendas
                legendItem.style.opacity = '0.5';
                legendItem.querySelector('.legend-color').style.opacity = '0.3';
                legendProcurados.style.opacity = '1';
                legendProcurados.querySelector('.legend-color').style.opacity = '1';
                legendEncontrados.style.opacity = '1';
                legendEncontrados.querySelector('.legend-color').style.opacity = '1';
                
                showingOnlyShelters = false;
            }
            
            // Efeito visual de feedback
            legendItem.style.backgroundColor = 'rgba(255, 152, 0, 0.1)';
            setTimeout(() => {
                legendItem.style.backgroundColor = '';
            }, 300);
        }
        
        function centerMapOnUserLocation() {
            const savedLocation = getSavedLocation();
            
            if (savedLocation) {
                // Centralizar mapa na localização salva
                map.setCenter(savedLocation);
                
                // Se não houver marcador, adicioná-lo
                if (!userMarker) {
                    addUserMarker(savedLocation);
                } else {
                    // Animar marcador existente
                    userMarker.setAnimation(google.maps.Animation.BOUNCE);
                    setTimeout(() => {
                        userMarker.setAnimation(null);
                    }, 1400);
                }
                
                // Animar a transição com zoom mais próximo
                map.setZoom(18);
                
                // Mostrar popup de localização
                showLocationPopup(userMarker);
            } else {
                // Se não tiver localização salva, solicitar
                requestUserLocation();
            }
        }
        
        function requestUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Salvar localização para uso futuro
                        saveUserLocation(userLocation);
                        
                        // Centralizar mapa na localização do usuário
                        map.setCenter(userLocation);
                        map.setZoom(15);
                        
                        // Adicionar marcador do usuário
                        addUserMarker(userLocation);
                    },
                    (error) => {
                        console.error('Erro ao obter localização:', error);
                        alert('Não foi possível obter sua localização. Verifique as permissões do seu navegador.');
                    },
                    { timeout: 10000, maximumAge: 600000 }
                );
            } else {
                alert('Seu navegador não suporta geolocalização.');
            }
        }
        
        function refreshUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const newLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Salvar localização para uso futuro
                        saveUserLocation(newLocation);
                        
                        // Centralizar mapa na nova localização
                        map.setCenter(newLocation);
                        map.setZoom(16);

                        // Adicionar marcador do usuário na nova localização
                        addUserMarker(newLocation);
                        
                        alert('Localização atualizada com sucesso!');
                    },
                    (error) => {
                        console.error('Erro ao atualizar localização:', error);
                        alert('Não foi possível atualizar sua localização. Verifique as permissões do seu navegador.');
                    }
                );
            } else {
                alert('Seu navegador não suporta geolocalização.');
            }
        }
        
        function showLocationPopup(marker) {
            // Mostrar um popup simples
            alert('Você está aqui!');
        }
        
        // Adicionar evento de clique em cada item da legenda
        document.addEventListener('DOMContentLoaded', function() {
            // Itens da legenda
            const legendItems = document.querySelectorAll('.legend-item');
            
            legendItems.forEach(item => {
                item.addEventListener('click', function() {
                    setTimeout(() => {
                        this.blur();
                    }, 100);
                });
            });
        });
    </script>
    
    <!-- Carregue o script do Google Maps após a definição da função initMap -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYiAXh7HwQgCEudiSzPR3bUuYQ1mnS3b4&libraries=geometry&callback=initMap"></script>
</body>
</html> 