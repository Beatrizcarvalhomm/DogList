<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DogList - Adicionar Animal</title>
    <link rel="icon" href="Images/DogList-Logo.png" type="image/png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Google Maps Script -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYiAXh7HwQgCEudiSzPR3bUuYQ1mnS3b4&libraries=geometry" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background-color: #FFE4D6;
            min-height: 100vh;
            color: #333;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #FFE4D6;
        }

        .header {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 1000;
            margin: 0 20px;
            border-radius: 0 0 20px 20px;
            position: relative;
            min-height: 65px;
        }

        .back-button {
            font-size: 24px;
            text-decoration: none;
            color: #FF7F50;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            background-color: rgba(255, 255, 255, 0.9);
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1001;
        }

        .back-button:hover {
            background-color: #FFFFFF;
            transform: translateX(-3px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            letter-spacing: 0.5px;
            text-align: center;
            margin: 0 auto;
            cursor: pointer;
            transition: color 0.3s ease;
            position: relative;
            display: inline-block;
        }

        .title:hover {
            color: #333;
            text-shadow: 0 0 10px rgba(255, 127, 80, 0.3);
        }

        .title:after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 2px;
            background-color: #FF7F50;
            border-radius: 2px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .title:hover:after {
            width: 120px;
            background-color: #FF6347;
        }

        .content {
            flex: 1;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 25px 0 15px;
            color: #FF7F50;
            border-left: 4px solid #FF7F50;
            padding-left: 10px;
        }

        .photo-upload {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: 20px;
            margin: 20px auto;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px dashed #ddd;
        }

        .photo-upload:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .photo-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-upload i {
            position: absolute;
            color: #888;
            display: block;
            transition: all 0.3s ease;
        }

        .photo-upload:hover i {
            transform: scale(1.1);
            color: #FF7F50;
        }

        .photo-upload.has-image {
            border: none;
        }

        .photo-upload.has-image i {
            display: none;
        }

        .photo-hint {
            text-align: center;
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 20px;
        }

        .options-group {
            background: white;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .option-label {
            font-weight: 600;
            margin-bottom: 15px;
            display: block;
            color: #333;
        }

        .option-item {
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-item input[type="radio"] {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 50%;
            outline: none;
            transition: all 0.3s ease;
        }

        .option-item input[type="radio"]:checked {
            border: 6px solid #FF7F50;
        }

        .option-item label {
            cursor: pointer;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 15px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
            margin-bottom: 5px;
        }

        .input-field:focus {
            outline: none;
            border-color: #FF7F50;
            box-shadow: 0 0 0 3px rgba(255, 127, 80, 0.2);
        }
        
        /* Estilo para campos readonly como o contacto */
        .input-field[readonly] {
            background-color: #f0f0f0;
            color: #666;
            cursor: not-allowed;
            border-color: #ddd;
        }
        
        .input-field[readonly]:focus {
            box-shadow: none;
            border-color: #ddd;
        }

        .map-container {
            width: 100%;
            height: 300px;
            border-radius: 20px;
            overflow: hidden;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid white;
        }

        .location-info {
            margin-top: 15px;
            padding: 12px;
            background-color: white;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .location-info i {
            color: #FF7F50;
            font-size: 18px;
        }

        .use-my-location {
            background-color: #FF7F50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            justify-content: center;
        }

        .use-my-location:hover {
            background-color: #ff6b3d;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .save-button {
            width: 100%;
            padding: 15px;
            background-color: #FF7F50;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            margin-bottom: 40px;
        }

        .save-button:hover {
            background-color: #ff6b3d;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .location-search {
            margin-bottom: 15px;
            position: relative;
        }

        .location-search input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .location-search input:focus {
            outline: none;
            border-color: #FF7F50;
            box-shadow: 0 0 0 3px rgba(255, 127, 80, 0.2);
        }

        .location-suggestions, .breed-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 15px 15px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            transition: all 0.2s ease;
        }

        .suggestion-item:hover {
            background-color: #f5f5f5;
        }

        .breed-search {
            position: relative;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 5px;
            display: block;
        }

        .required-field::after {
            content: "*";
            color: #e74c3c;
            margin-left: 4px;
        }

        /* Responsiveness */
        @media (max-width: 768px) {
            .content {
                padding: 15px;
            }
            
            .photo-upload {
                width: 150px;
                height: 150px;
            }
            
            .map-container {
                height: 250px;
            }

            .header {
                padding: 20px;
                min-height: 65px;
                flex-direction: row;
                margin: 0 10px 15px 10px;
                position: relative;
            }
            
            .title {
                font-size: 18px;
                margin: 0 auto;
            }

            .back-button {
                top: 50%;
                transform: translateY(-50%);
                left: 15px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 20px;
                min-height: 65px;
                flex-direction: row;
                margin: 0 8px;
                gap: 5px;
            }
            
            .options-group {
                padding: 15px;
            }
            
            .save-button {
                padding: 12px;
            }
            
            .title {
                font-size: 20px;
            }

            .title:after {
                bottom: -6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="home.html" class="back-button">←</a>
            <span class="title">Adicionar Animal</span>
        </div>

        <div class="content">
            <form id="addDogForm">
                <h2 class="section-title">Foto do Animal</h2>
                <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                    <img id="photoPreview" alt="Preview">
                    <i class="fas fa-camera fa-2x"></i>
                    <input type="file" id="photoInput" style="display: none" accept="image/*" onchange="previewImage(this)">
                </div>
                <p class="photo-hint">Toque para adicionar uma foto (opcional)</p>

                <h2 class="section-title">Informações Básicas</h2>
                <div class="options-group">
                    <label class="option-label required-field">Estado</label>
                    <div class="option-item">
                        <input type="radio" name="estado" id="encontrado" value="encontrado" required>
                        <label for="encontrado">Encontrado</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="estado" id="procurado" value="procurado">
                        <label for="procurado">Procurado</label>
                    </div>
                </div>

                <h2 class="section-title">Localização</h2>
                <div class="input-group">
                    <div class="location-search">
                        <input type="text" id="locationSearch" placeholder="Pesquisar endereço..." autocomplete="off">
                        <div id="locationSuggestions" class="location-suggestions"></div>
                    </div>
                    <div class="map-container" id="map"></div>
                    <div class="location-info">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="locationText">Clique no mapa ou pesquise um endereço</span>
                    </div>
                    <button type="button" class="use-my-location" onclick="useMyLocation()">
                        <i class="fas fa-location-arrow"></i>
                        Usar a minha localização atual
                    </button>
                    <input type="hidden" id="latitude" required>
                    <input type="hidden" id="longitude" required>
                </div>

                <h2 class="section-title">Características</h2>
                <div class="input-group breed-search">
                    <input type="text" class="input-field" name="raca" id="breedSearch" placeholder="Raça (opcional)" minlength="2" maxlength="50" pattern="[A-Za-zÀ-ÿ\s\-]+" title="Por favor, insira uma raça válida (apenas letras, espaços e hífens)">
                    <div id="breedSuggestions" class="breed-suggestions"></div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Idade</label>
                    <div class="option-item">
                        <input type="radio" name="idade" id="idade1" value="0-5" required>
                        <label for="idade1">0-5 anos</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="idade" id="idade2" value="5-10">
                        <label for="idade2">5-10 anos</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="idade" id="idade3" value="10+">
                        <label for="idade3">+10 anos</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="idade" id="idade4" value="unknown">
                        <label for="idade4">Não sei</label>
                    </div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Sexo</label>
                    <div class="option-item">
                        <input type="radio" name="sexo" id="sexo1" value="male" required>
                        <label for="sexo1">Macho</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="sexo" id="sexo2" value="female">
                        <label for="sexo2">Fêmea</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="sexo" id="sexo3" value="unknown">
                        <label for="sexo3">Não sei</label>
                    </div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Castrado</label>
                    <div class="option-item">
                        <input type="radio" name="castrado" id="castrado1" value="yes" required>
                        <label for="castrado1">Sim</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="castrado" id="castrado2" value="no">
                        <label for="castrado2">Não</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="castrado" id="castrado3" value="unknown">
                        <label for="castrado3">Não sei</label>
                    </div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Agressividade</label>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo1" value="none" required>
                        <label for="agressivo1">Não é agressivo</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo2" value="humans">
                        <label for="agressivo2">Agressivo com pessoas</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo3" value="animals">
                        <label for="agressivo3">Agressivo com outros animais</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo4" value="both">
                        <label for="agressivo4">Agressivo com pessoas e animais</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo5" value="unknown">
                        <label for="agressivo5">Não sei</label>
                    </div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Porte</label>
                    <div class="option-item">
                        <input type="radio" name="porte" id="porte1" value="small" required>
                        <label for="porte1">Pequeno</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="porte" id="porte2" value="medium">
                        <label for="porte2">Médio</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="porte" id="porte3" value="large">
                        <label for="porte3">Grande</label>
                    </div>
                </div>

                <h2 class="section-title">Contacto</h2>
                <div class="input-group">
                    <label for="contact" class="option-label">Contacto</label>
                    <input type="tel" id="contact" name="contact" class="input-field" 
                        placeholder="O seu número de contacto" 
                        required
                        readonly
                        pattern="[2-9][0-9]{8}"
                        title="Número de telefone deve ter 9 dígitos">
                    <span id="contactError" style="color: red; display: none; font-size: 14px; margin-top: 5px;">Número de telefone deve ter exatamente 9 dígitos</span>
                </div>

                <button type="submit" class="save-button">Adicionar Animal</button>
            </form>
        </div>
    </div>

    <script>
        // Verificar se está logado
        if (!localStorage.getItem('loggedIn')) {
            window.location.href = 'index.html';
        }
        
        let map, marker;
        let lastValidLocation;
        let searchTimeout;
        let breedSearchTimeout;
        
        // Lista de raças comuns de cães em Portugal
        const commonBreeds = [
            // Raças portuguesas
            "Rafeiro Alentejano", "Cão da Serra da Estrela", "Cão de Água Português", "Podengo Português",
            "Castro Laboreiro", "Cão de Fila de São Miguel", "Barbado da Terceira", "Perdigueiro Português",
            "Cão de Gado Transmontano", "Cão do Barrocal Algarvio", "Cão de Serra de Aires",
            
            // Raças internacionais populares
            "Affenpinscher", "Airedale Terrier", "Akita", "Akita Americano", "Akita Japonês", "Alapaha Blue Blood Bulldog",
            "American Bully", "American Staffordshire Terrier", "Antigo Cão de Pastor Inglês", "Basenji",
            "Basset Hound", "Beagle", "Bearded Collie", "Beauceron", "Bedlington Terrier", "Bichon Frisé",
            "Bloodhound", "Boerboel", "Boiadeiro Australiano", "Boiadeiro Bernês", "Border Collie", "Border Terrier",
            "Boston Terrier", "Boxer", "Braco Alemão", "Braco Húngaro de Pelo Curto", "Braco Italiano", "Briard",
            "Brittany", "Buldogue Americano", "Buldogue Francês", "Buldogue Inglês", "Bull Terrier", "Bull Terrier Miniatura",
            "Bulldog Americano", "Bullmastiff", "Cairn Terrier", "Cane Corso", "Cão Chinês de Crista", "Cão de Montanha dos Pirenéus",
            "Cão de Pastor Alemão", "Cão de Pastor Australiano", "Cão de Pastor Belga", "Cão de Pastor Branco Suíço",
            "Cão de Pastor Catalão", "Cão de Pastor de Beauce", "Cão de Pastor de Brie", "Cão de Pastor de Shetland",
            "Cão de Santo Humberto", "Cão d'Água Espanhol", "Cão d'Água Português", "Cão Lobo Checoslovaco",
            "Cavalier King Charles Spaniel", "Chesapeake Bay Retriever", "Chihuahua", "Chin Japonês", "Chow Chow",
            "Cirneco do Etna", "Clumber Spaniel", "Cocker Spaniel Americano", "Cocker Spaniel Inglês", "Collie",
            "Coonhound", "Corgi Galês Cardigan", "Corgi Galês Pembroke", "Curly-Coated Retriever", "Dachshund",
            "Dálmata", "Dandie Dinmont Terrier", "Deerhound", "Dobermann", "Dogo Argentino", "Dogo Canário",
            "Dogue Alemão", "Dogue de Bordeaux", "Dogue do Tibete", "Drever", "Elkhound Norueguês", "Épagneul Bretão",
            "Eurasier", "Fila Brasileiro", "Flat-Coated Retriever", "Fox Terrier", "Foxhound Americano", "Foxhound Inglês",
            "Galgo Espanhol", "Galgo Italiano", "Galgo Persa", "Golden Retriever", "Grande Boiadeiro Suíço",
            "Grande Münsterländer", "Greyhound", "Griffon Bruxelois", "Griffon de Pelo Duro", "Harrier", "Havanese",
            "Hokkaido", "Husky Siberiano", "Irish Terrier", "Jack Russell Terrier", "Keeshond", "Kelpie Australiano",
            "Kerry Blue Terrier", "King Charles Spaniel", "Komondor", "Kuvasz", "Labradoodle", "Labrador Retriever",
            "Lagotto Romagnolo", "Lakeland Terrier", "Lancashire Heeler", "Leonberger", "Lhasa Apso", "Lulu da Pomerânia",
            "Malamute do Alasca", "Maltês", "Manchester Terrier", "Mastiff", "Mastim Espanhol", "Mastim Napolitano",
            "Mastim Tibetano", "Norwich Terrier", "Nova Scotia Duck Tolling Retriever", "Old English Sheepdog",
            "Otterhound", "Papillon", "Pastor Alemão", "Pastor Australiano", "Pastor Belga Malinois", 
            "Pastor Belga Tervuren", "Pastor Bergamasco", "Pastor Branco Suíço", "Pastor Cáucaso", 
            "Pastor da Ásia Central", "Pastor de Beauce", "Pastor dos Pirinéus", "Pequeno Cão Leão", 
            "Pequinês", "Perdigueiro Português", "Pharaoh Hound", "Pinscher Alemão", "Pinscher Miniatura",
            "Pit Bull Terrier Americano", "Podenco Ibicenco", "Podengo Português", "Pointer Inglês", "Poodle",
            "Poodle Miniatura", "Poodle Toy", "Pug", "Puli", "Pumi", "Racka", "Rottweiler", "Saluki",
            "Samoieda", "São Bernardo", "Schipperke", "Schnauzer", "Schnauzer Gigante", "Schnauzer Miniatura",
            "Scottish Terrier", "Sealyham Terrier", "Setter Gordon", "Setter Inglês", "Setter Irlandês",
            "Shar Pei", "Shiba Inu", "Shih Tzu", "Skye Terrier", "Sloughi", "Spaniel Bretão", "Spaniel do Campo",
            "Spaniel dos Campos", "Spaniel Francês", "Spaniel Japonês", "Spaniel Tibetano", "Spitz Alemão",
            "Spitz Finlandês", "Spitz Japonês", "Springer Spaniel Inglês", "Stabyhoun", "Staffordshire Bull Terrier",
            "Swedish Vallhund", "Teckel", "Terra Nova", "Terrier Brasileiro", "Terrier Checo", "Terrier Escocês",
            "Terrier Irlandês", "Terrier Japonês", "Terrier Norfolk", "Terrier Norwich", "Terrier Preto da Rússia",
            "Terrier Tibetano", "Tosa Inu", "Vizsla", "Vulpino Italiano", "Weimaraner", "Welsh Springer Spaniel",
            "Welsh Terrier", "West Highland White Terrier", "Whippet", "Xoloitzcuintle", "Yorkshire Terrier",
            
            // Cães de raça mista comuns
            "Labradoodle", "Goldendoodle", "Cockapoo", "Maltipoo", "Puggle", "Schnoodle", "Cavachon", "Pomsky", 
            "Cavapoo", "Chorkie", "Chiweenie", "Morkie", "Poochon", "Sheepadoodle", "Bernedoodle", "Aussiepoo",
            "Cão de raça mista", "SRD (Sem Raça Definida)", "Rafeiro"
        ];

        function initMap(userLat, userLng) {
            // Define uma localização padrão (Lisboa) caso não haja localização do usuário
            const defaultLocation = { lat: 38.7223, lng: -9.1393 };
            const initialLocation = userLat && userLng ? 
                { lat: userLat, lng: userLng } : defaultLocation;
            
            // Garantir que o elemento do mapa existe no DOM
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('Elemento do mapa não encontrado!');
                return;
            }
            
            // Configuração do mapa
            try {
                map = new google.maps.Map(mapElement, {
                    center: initialLocation,
                    zoom: 13,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    mapTypeControl: true,
                    zoomControl: true,
                    streetViewControl: false,
                    fullscreenControl: false
            });

                // Forçar o layout para garantir que o mapa seja renderizado corretamente
                google.maps.event.addListenerOnce(map, 'idle', function() {
                    google.maps.event.trigger(map, 'resize');
                    map.setCenter(initialLocation);
            });

                // Adicionar marcador na localização inicial se tivermos coordenadas do usuário
                if (userLat && userLng) {
                    if (marker) marker.setMap(null);
                    marker = new google.maps.Marker({
                        position: initialLocation,
                        map: map,
                        animation: google.maps.Animation.DROP
                    });
                    
                    // Preencher os campos ocultos com a localização
                    document.getElementById('latitude').value = userLat;
                    document.getElementById('longitude').value = userLng;
                    
                    // Geocodificar para obter o endereço
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ 'location': initialLocation }, function(results, status) {
                        if (status === google.maps.GeocoderStatus.OK && results[0]) {
                            document.getElementById('locationText').textContent = results[0].formatted_address;
                            document.querySelector('.location-info').style.border = '2px solid #2ecc71';
                        }
                    });
                }
                
                // Adicionar evento de clique no mapa
                map.addListener('click', function(e) {
                    const clickedLocation = e.latLng;
                
                    // Remover marcador anterior, se existir
                    if (marker) marker.setMap(null);
                    
                    // Adicionar novo marcador
                    marker = new google.maps.Marker({
                        position: clickedLocation,
                        map: map,
                        animation: google.maps.Animation.DROP
                    });
                    
                    // Geocodificar coordenadas para obter endereço
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ 'location': clickedLocation }, function(results, status) {
                        if (status === google.maps.GeocoderStatus.OK && results[0]) {
                            // Guardar endereço
                            const formattedAddress = results[0].formatted_address;
                            document.getElementById('locationText').textContent = formattedAddress;
                            
                            // Guardar coordenadas precisas
                            document.getElementById('latitude').value = clickedLocation.lat();
                            document.getElementById('longitude').value = clickedLocation.lng();
                            
                            lastValidLocation = {
                                lat: clickedLocation.lat(),
                                lng: clickedLocation.lng(),
                                address: formattedAddress
                            };
                            
                            // Atualizar campo de pesquisa
                            document.getElementById('locationSearch').value = formattedAddress;
                            
                            document.querySelector('.location-info').style.border = '2px solid #2ecc71';
                } else {
                            document.getElementById('locationText').textContent = `Localização (${clickedLocation.lat().toFixed(6)}, ${clickedLocation.lng().toFixed(6)})`;
                            document.getElementById('latitude').value = clickedLocation.lat();
                            document.getElementById('longitude').value = clickedLocation.lng();
                            
                            lastValidLocation = {
                                lat: clickedLocation.lat(),
                                lng: clickedLocation.lng(),
                                address: `Localização (${clickedLocation.lat().toFixed(6)}, ${clickedLocation.lng().toFixed(6)})`
                            };
                            
                            document.querySelector('.location-info').style.border = '2px solid #f39c12';
                        }
                    });
                });
                
                console.log('Mapa inicializado com sucesso');
            } catch (error) {
                console.error('Erro ao inicializar o mapa:', error);
                mapElement.innerHTML = '<div style="padding:30px;text-align:center;color:#e74c3c;">Erro ao carregar o mapa. Por favor, recarregue a página.</div>';
            }
        }

        // Configurar campo de pesquisa de localização depois que o mapa estiver pronto
        function setupLocationSearch() {
            const locationInput = document.getElementById('locationSearch');
            if (locationInput) {
                locationInput.addEventListener('input', function() {
                    searchLocation(this.value);
                });
            }
        }
        
        function searchLocation(query) {
            if (searchTimeout) clearTimeout(searchTimeout);
            const suggestionsContainer = document.getElementById('locationSuggestions');
            
            if (query.length < 3) {
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.style.display = 'none';
                        return;
                    }
                    
            searchTimeout = setTimeout(() => {
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ 'address': query }, function(results, status) {
                    if (status === google.maps.GeocoderStatus.OK && results.length > 0) {
                    suggestionsContainer.innerHTML = '';
                        
                        results.slice(0, 5).forEach(result => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                            div.innerHTML = result.formatted_address;
                        div.addEventListener('click', function() {
                                document.getElementById('locationSearch').value = result.formatted_address;
                            
                                // Armazenar o endereço formatado
                                document.getElementById('locationText').textContent = result.formatted_address;
                            
                                // Obter e armazenar as coordenadas completas para garantir precisão
                                const lat = result.geometry.location.lat();
                                const lng = result.geometry.location.lng();
                            document.getElementById('latitude').value = lat;
                            document.getElementById('longitude').value = lng;
                                
                                lastValidLocation = {
                                    lat: lat,
                                    lng: lng,
                                    address: result.formatted_address
                                };
                            
                                // Mover o mapa para a localização e adicionar marcador
                                if (map) {
                                    map.setCenter(result.geometry.location);
                                    map.setZoom(16);
                                    
                                    if (marker) marker.setMap(null);
                                    marker = new google.maps.Marker({
                                        position: result.geometry.location,
                                        map: map,
                                        title: result.formatted_address,
                                        animation: google.maps.Animation.DROP
                                    });
                                }
                                
                                document.querySelector('.location-info').style.border = '2px solid #2ecc71';
                            
                                suggestionsContainer.style.display = 'none';
                        });
                        suggestionsContainer.appendChild(div);
                    });
                        
                        suggestionsContainer.style.display = 'block';
                    } else {
                        suggestionsContainer.innerHTML = '<div class="suggestion-item">Nenhum resultado encontrado</div>';
                        suggestionsContainer.style.display = 'block';
                    }
                });
            }, 500);
        }

        function useMyLocation() {
            if (navigator.geolocation) {
                const locationButton = document.querySelector('.use-my-location');
                locationButton.disabled = true;
                locationButton.textContent = 'A obter localização...';
                
                // Mostrar indicador de carregamento
                document.getElementById('locationText').textContent = 'Obtendo sua localização...';
                document.querySelector('.location-info').style.border = '2px solid #3498db';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Salvar as coordenadas de qualquer forma para garantir que temos uma localização
                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = lng;
                        
                        // Geocodificar as coordenadas para obter o endereço da rua
                        const geocoder = new google.maps.Geocoder();
                        geocoder.geocode({ 
                            'location': { lat, lng },
                            'language': 'pt-PT' // Forçar resultados em português
                        }, function(results, status) {
                            if (status === google.maps.GeocoderStatus.OK && results.length > 0) {
                                // Tentar encontrar o resultado mais detalhado com um endereço de rua
                                let bestResult = results[0]; // Padrão para o primeiro resultado
                                
                                // Procurar pelo resultado mais detalhado com endereço de rua
                                for (let i = 0; i < results.length; i++) {
                                    const result = results[i];
                                    // Verificar se contém componentes de endereço de rua
                                    const hasStreetComponents = result.address_components.some(comp => 
                                        comp.types.includes('route') || 
                                        comp.types.includes('street_address') ||
                                        comp.types.includes('premise') ||
                                        comp.types.includes('subpremise')
                                    );
                                    
                                    if (hasStreetComponents) {
                                        bestResult = result;
                                        break; // Encontramos um bom resultado com detalhe de rua
                                    }
                                }
                                
                                // Sempre usar o melhor resultado disponível, mesmo que não seja perfeito
                                const formattedAddress = bestResult.formatted_address;
                                document.getElementById('locationSearch').value = formattedAddress;
                                document.getElementById('locationText').textContent = formattedAddress;
                                
                                // Atualizar mapa
                                map.setCenter({lat, lng});
                                map.setZoom(17); // Zoom mais próximo para mostrar detalhes da rua
                                
                                if (marker) marker.setMap(null);
                                marker = new google.maps.Marker({
                                    position: {lat, lng},
                                    map: map,
                                    animation: google.maps.Animation.DROP
                                });
                                
                                // Feedback visual positivo
                                document.querySelector('.location-info').style.border = '2px solid #2ecc71';
                                
                                console.log('Endereço encontrado:', formattedAddress);
                            } else {
                                // Mesmo sem um endereço, usamos as coordenadas
                                console.error('Geocodificação falhou:', status);
                                const coords = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                                document.getElementById('locationText').textContent = `Localização atual (${coords})`;
                                
                                // Atualizar mapa
                                map.setCenter({lat, lng});
                                
                                if (marker) marker.setMap(null);
                                marker = new google.maps.Marker({
                                    position: {lat, lng},
                                    map: map,
                                    animation: google.maps.Animation.DROP
                                });
                                
                                // Feedback visual neutro
                                document.querySelector('.location-info').style.border = '2px solid #f39c12';
                            }
                            
                        locationButton.disabled = false;
                        locationButton.innerHTML = '<i class="fas fa-location-arrow"></i> Usar a minha localização atual';
                        });
                    },
                    (error) => {
                        console.error('Erro ao obter localização:', error);
                        let errorMsg = 'Não foi possível obter sua localização.';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg += ' Você negou a permissão de localização.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg += ' Informações de localização indisponíveis.';
                                break;
                            case error.TIMEOUT:
                                errorMsg += ' O tempo para obter a localização expirou.';
                                break;
                            case error.UNKNOWN_ERROR:
                                errorMsg += ' Ocorreu um erro desconhecido.';
                                break;
                        }
                        
                        alert(errorMsg + ' Por favor, selecione manualmente no mapa ou use a pesquisa de endereço.');
                        document.getElementById('locationText').textContent = 'Clique no mapa ou pesquise um endereço';
                        document.querySelector('.location-info').style.border = '';
                        
                        locationButton.disabled = false;
                        locationButton.innerHTML = '<i class="fas fa-location-arrow"></i> Usar a minha localização atual';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                alert('Seu navegador não suporta geolocalização.');
            }
        }

        function setupBreedSearch() {
            const breedInput = document.getElementById('breedSearch');
            const suggestionsContainer = document.getElementById('breedSuggestions');
            
            breedInput.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                
                // Clear previous timeout
                if (breedSearchTimeout) {
                    clearTimeout(breedSearchTimeout);
                }
                
                // Show suggestions if the query is at least 2 characters
                if (query.length >= 2) {
                    breedSearchTimeout = setTimeout(() => {
                        // Filter breeds that match the query
                        const matchedBreeds = commonBreeds.filter(breed => 
                            breed.toLowerCase().includes(query)
                        );
                        
                        // Display matched breeds
                        if (matchedBreeds.length > 0) {
                            suggestionsContainer.innerHTML = '';
                            matchedBreeds.forEach(breed => {
                                const div = document.createElement('div');
                                div.className = 'suggestion-item';
                                div.textContent = breed;
                                div.addEventListener('click', function() {
                                    breedInput.value = breed;
                                    suggestionsContainer.style.display = 'none';
                                });
                                suggestionsContainer.appendChild(div);
                            });
                            suggestionsContainer.style.display = 'block';
                        } else {
                            suggestionsContainer.innerHTML = '<div class="suggestion-item">Nenhuma raça encontrada</div>';
                            suggestionsContainer.style.display = 'block';
                        }
                    }, 200); // Shorter timeout as it's a local search
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target !== breedInput && e.target !== suggestionsContainer) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }

        function previewImage(input) {
            const preview = document.getElementById('photoPreview');
            const photoUpload = document.querySelector('.photo-upload');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('A imagem deve ter no máximo 5MB');
                    input.value = '';
                    return;
                }

                // Validate file type
                if (!file.type.match('image.*')) {
                    alert('Por favor, selecione apenas ficheiros de imagem');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    photoUpload.classList.add('has-image');
                }
                
                reader.readAsDataURL(file);
            }
        }

        document.getElementById('addDogForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Check for required fields first
            const requiredFields = ["estado", "idade", "sexo", "castrado", "agressivo", "porte"];
            let hasErrors = false;
            
            // Verificar o campo de contato primeiro
            const contactInput = document.getElementById('contact');
            const contactError = document.getElementById('contactError');
            
            if (!contactInput.value.match(/^[2-9][0-9]{8}$/)) {
                contactError.style.display = 'block';
                contactInput.focus();
                hasErrors = true;
            } else {
                contactError.style.display = 'none';
            }
            
            requiredFields.forEach(field => {
                const radioButtons = document.querySelectorAll(`input[name="${field}"]`);
                let isChecked = false;
                radioButtons.forEach(radio => {
                    if (radio.checked) isChecked = true;
                });
                
                if (!isChecked) {
                    // Display error for radio button group
                    const label = document.querySelector(`label.option-label[for="${field}"]`) || 
                                  document.querySelector(`.options-group:has(input[name="${field}"]) .option-label`);
                    
                    if (label) {
                        label.style.color = '#e74c3c';
                        setTimeout(() => {
                            label.style.color = '';
                        }, 3000);
                    }
                    hasErrors = true;
                }
            });
            
            // Check location - verificação para garantir que temos pelo menos uma localização
            if (!document.getElementById('latitude').value || !document.getElementById('longitude').value) {
                document.querySelector('.location-info').style.border = '2px solid #e74c3c';
                document.querySelector('.location-info').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Por favor, selecione uma localização no mapa ou use o campo de busca.';
                
                // Adicionar botão para tentar usar localização atual
                const retryButton = document.createElement('button');
                retryButton.type = 'button';
                retryButton.className = 'use-my-location';
                retryButton.style.marginTop = '10px';
                retryButton.innerHTML = '<i class="fas fa-location-arrow"></i> Usar a minha localização atual';
                retryButton.onclick = function() {
                    useMyLocation();
                };
                document.querySelector('.location-info').appendChild(retryButton);
                
                setTimeout(() => {
                    document.querySelector('.location-info').style.border = '';
                    document.querySelector('.location-info').innerHTML = '<i class="fas fa-map-marker-alt"></i><span id="locationText">Clique no mapa ou pesquise um endereço</span>';
                }, 5000);
                hasErrors = true;
                
                // Scroll para a seção do mapa
                document.querySelector('.map-container').scrollIntoView({ behavior: 'smooth' });
            }
            
            if (hasErrors) {
                return;
            }
            
            const formData = new FormData(this);
            const imageFile = document.getElementById('photoInput').files[0];
            
            // Get breed value (might be empty now)
            const breedValue = document.getElementById('breedSearch').value.trim();
            
            // Preparar os dados de localização
            const locationData = {
                lat: parseFloat(document.getElementById('latitude').value),
                lng: parseFloat(document.getElementById('longitude').value)
            };
            
            // Obter o endereço completo
            const endereco = document.getElementById('locationText').textContent;

            try {
                let imageData = null;
                // Process image only if one was selected
                if (imageFile) {
                const compressedImage = await compressImage(imageFile);
                    imageData = await blobToBase64(compressedImage);
                }
                
                const dog = {
                    id: generateUniqueId(),
                    userId: localStorage.getItem('currentUserId'),
                    image: imageData || null,
                    estado: formData.get('estado'),
                    location: locationData,
                    endereco: endereco, // Armazenar o endereço como string separada
                    raca: breedValue || "Não especificada",
                    idade: formData.get('idade'),
                    sexo: formData.get('sexo'),
                    castrado: formData.get('castrado'),
                    agressivo: formData.get('agressivo'),
                    porte: formData.get('porte'),
                    contacto: document.getElementById('contact').value,
                    dataAdicao: new Date().toISOString(),
                    userName: localStorage.getItem('userName') || 'Utilizador'
                };

                let allDogs = JSON.parse(localStorage.getItem('allDogs') || '[]');
                allDogs.push(dog);
                
                try {
                    localStorage.setItem('allDogs', JSON.stringify(allDogs));
                    alert('Animal adicionado com sucesso!');
                    window.location.href = 'home.html';
                } catch (error) {
                    if (error.name === 'QuotaExceededError') {
                        alert('Não foi possível guardar. Armazenamento cheio. Por favor, remova alguns itens antigos.');
                    } else {
                        alert('Erro ao guardar. Por favor, tente novamente.');
                    }
                }
            } catch (error) {
                console.error('Erro ao processar imagem:', error);
                alert('Erro ao processar a imagem. Por favor, tente novamente.');
            }
        });

        // Função para comprimir imagem
        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Redimensionar se a imagem for muito grande
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        
                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob(resolve, 'image/jpeg', 0.7);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Função para converter Blob para Base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function() {
                    resolve(reader.result);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // Modificar a inicialização do mapa para garantir que todos os elementos do DOM estejam carregados
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM totalmente carregado');
            
            // Configurar a pesquisa de raças
            setupBreedSearch();
            
            // Configurar a pesquisa de localização
            setupLocationSearch();
            
            // Função para verificar se o Google Maps já foi carregado
            function checkGoogleMapsLoaded() {
                if (window.google && window.google.maps) {
                    // Google Maps está carregado, inicializar o mapa
                    initializeMap();
                } else {
                    // Verificar novamente em 100ms
                    setTimeout(checkGoogleMapsLoaded, 100);
                }
            }
            
            // Iniciar verificação do carregamento do Google Maps
            checkGoogleMapsLoaded();
            
            // Função para inicializar o mapa quando o Google Maps estiver carregado
            function initializeMap() {
                // Verificar se o elemento do mapa existe
                if (document.getElementById('map')) {
                    // Tentar obter a localização do usuário
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                initMap(position.coords.latitude, position.coords.longitude);
                            },
                            (error) => {
                                console.error('Erro ao obter localização:', error);
                                initMap(); // Will use default Lisbon coordinates
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 5000,
                                maximumAge: 0
                            }
                        );
                    } else {
                        console.log('Geolocalização não suportada');
                        initMap(); // Will use default Lisbon coordinates
                    }
                } else {
                    console.error('Elemento do mapa não encontrado no DOM');
                }
            }

            // Preencher automaticamente o campo de contato com o número do usuário
            const userPhone = localStorage.getItem('userPhone');
            if (userPhone) {
                const contactInput = document.getElementById('contact');
                if (contactInput) {
                    contactInput.value = userPhone;
                }
            } else {
                // Se não houver telefone do utilizador, mostrar um alerta
                alert('Por favor, atualize o seu perfil com um número de telefone para adicionar animais.');
                // Redirecionar para a página de conta
                window.location.href = 'home.html';
            }
        });

        // Função para gerar um ID único
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
    </script>
</body>
</html>