<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DogList - Adicionar Animal</title>
    <link rel="icon" href="Images/DogList-Logo.png" type="image/png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Google Maps Script -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYiAXh7HwQgCEudiSzPR3bUuYQ1mnS3b4&libraries=geometry" async defer></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Inicializar o cliente Supabase corretamente
        const supabaseUrl = 'https://jwyzbfbzxbedjskumgli.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3eXpiZmJ6eGJlZGpza3VtZ2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3NjA4MDksImV4cCI6MjA2MzMzNjgwOX0.8GEehgGUF-9zv1WwneYZBs1K3VLEZtxB9v0R6An0GIc';
        
        // Inicializar o cliente Supabase de forma correta e explícita
        const { createClient } = supabase;
        window.supabase = createClient(supabaseUrl, supabaseKey);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background-color: #FFE4D6;
            min-height: 100vh;
            color: #333;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #FFE4D6;
        }

        .header {
            background-color: #FFFFFF;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            margin: 0 20px;
            border-radius: 0 0 20px 20px;
            height: 60px;
            box-sizing: border-box;
        }

        .back-button {
            font-size: 24px;
            text-decoration: none;
            color: #FF7F50;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            background-color: #FFFFFF;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1001;
        }

        .back-button:hover {
            background-color: #FFFFFF;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            letter-spacing: 0.5px;
            text-align: center;
            margin: 0 auto;
            cursor: pointer;
            transition: color 0.3s ease;
            position: relative;
            display: inline-block;
        }

        .title:hover {
            color: #333;
            text-shadow: 0 0 10px rgba(255, 127, 80, 0.3);
        }

        .title:after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 2px;
            background-color: #FF7F50;
            border-radius: 2px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .title:hover:after {
            width: 120px;
            background-color: #FF6347;
        }

        .content {
            flex: 1;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 25px 0 15px;
            color: #FF7F50;
            border-left: 4px solid #FF7F50;
            padding-left: 10px;
        }

        .photo-upload {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: 20px;
            margin: 20px auto;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px dashed #ddd;
        }

        .photo-upload:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .photo-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-upload i {
            position: absolute;
            color: #888;
            display: block;
            transition: all 0.3s ease;
        }

        .photo-upload:hover i {
            transform: scale(1.1);
            color: #FF7F50;
        }

        .photo-upload.has-image {
            border: none;
        }

        .photo-upload.has-image i {
            display: none;
        }

        .photo-hint {
            text-align: center;
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 20px;
        }

        .options-group {
            background: white;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .option-label {
            font-weight: 600;
            margin-bottom: 15px;
            display: block;
            color: #333;
        }

        .option-item {
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-item input[type="radio"] {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 50%;
            outline: none;
            transition: all 0.3s ease;
        }

        .option-item input[type="radio"]:checked {
            border: 6px solid #FF7F50;
        }

        .option-item label {
            cursor: pointer;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 15px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
            margin-bottom: 5px;
        }

        .input-field:focus {
            outline: none;
            border-color: #FF7F50;
            box-shadow: 0 0 0 3px rgba(255, 127, 80, 0.2);
        }
        
        /* Estilo para campos readonly como o contato */
        .input-field[readonly] {
            background-color: #f0f0f0;
            color: #666;
            cursor: not-allowed;
            border-color: #ddd;
        }
        
        .input-field[readonly]:focus {
            box-shadow: none;
            border-color: #ddd;
        }

        .map-container {
            width: 100%;
            height: 300px;
            border-radius: 20px;
            overflow: hidden;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid white;
        }

        .location-info {
            margin-top: 15px;
            padding: 12px;
            background-color: white;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .location-info i {
            color: #FF7F50;
            font-size: 18px;
        }

        .use-my-location {
            background-color: #FF7F50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            justify-content: center;
        }

        .use-my-location:hover {
            background-color: #ff6b3d;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .save-button {
            width: 100%;
            padding: 15px;
            background-color: #FF7F50;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            margin-bottom: 40px;
        }

        .save-button:hover {
            background-color: #ff6b3d;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .location-search {
            margin-bottom: 15px;
            position: relative;
        }

        .location-search input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .location-search input:focus {
            outline: none;
            border-color: #FF7F50;
            box-shadow: 0 0 0 3px rgba(255, 127, 80, 0.2);
        }

        .location-suggestions, .breed-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 15px 15px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            transition: all 0.2s ease;
        }

        .suggestion-item:hover {
            background-color: #f5f5f5;
        }

        .breed-search {
            position: relative;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 5px;
            display: block;
        }

        .required-field::after {
            content: "*";
            color: #e74c3c;
            margin-left: 4px;
        }

        /* Responsiveness */
        @media (max-width: 768px) {
            .header {
                padding: 0 20px;
                margin: 0 10px;
                height: 60px;
            }
            
            .title {
                font-size: 20px;
            }
            
            .back-button {
                left: 15px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0 15px;
                margin: 0 8px;
                height: 50px;
            }
            
            .title {
                font-size: 18px;
            }
            
            .back-button {
                font-size: 22px;
                width: 35px;
                height: 35px;
                left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="home.html" class="back-button">←</a>
            <span class="title">Adicionar Animal</span>
        </div>

        <div class="content">
            <form id="addDogForm">
                <h2 class="section-title">Foto do Animal</h2>
                <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                    <img id="photoPreview" alt="Preview">
                    <i class="fas fa-camera fa-2x"></i>
                    <input type="file" id="photoInput" style="display: none" accept="image/*" onchange="previewImage(this)">
                </div>
                <p class="photo-hint">Toque para adicionar uma foto (opcional)</p>

                <h2 class="section-title">Informações Básicas</h2>
                <div class="options-group">
                    <label class="option-label required-field">Estado</label>
                    <div class="option-item">
                        <input type="radio" name="estado" id="encontrado" value="encontrado" required>
                        <label for="encontrado">Encontrado</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="estado" id="procurado" value="procurado">
                        <label for="procurado">Procurado</label>
                    </div>
                </div>

                <h2 class="section-title">Localização</h2>
                <div class="input-group">
                    <div class="location-search">
                        <input type="text" id="locationSearch" placeholder="Pesquisar morada..." autocomplete="off">
                        <div id="locationSuggestions" class="location-suggestions"></div>
                    </div>
                    <div class="map-container" id="map"></div>
                    <div class="location-info">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="locationText">Clique no mapa ou pesquise uma morada</span>
                    </div>
                    <button type="button" class="use-my-location" onclick="useMyLocation()">
                        <i class="fas fa-location-arrow"></i>
                        Usar a minha localização atual
                    </button>
                    <input type="hidden" id="latitude" required>
                    <input type="hidden" id="longitude" required>
                </div>

                <h2 class="section-title">Características</h2>
                <div class="input-group breed-search">
                    <input type="text" class="input-field" name="raca" id="breedSearch" placeholder="Raça (opcional)" minlength="2" maxlength="50" pattern="[A-Za-zÀ-ÿ\s\-]+" title="Por favor, insira uma raça válida (apenas letras, espaços e hífens)">
                    <div id="breedSuggestions" class="breed-suggestions"></div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Idade</label>
                    <div class="option-item">
                        <input type="radio" name="idade" id="idade1" value="0-5" required>
                        <label for="idade1">0-5 anos</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="idade" id="idade2" value="5-10">
                        <label for="idade2">5-10 anos</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="idade" id="idade3" value="10+">
                        <label for="idade3">+10 anos</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="idade" id="idade4" value="unknown">
                        <label for="idade4">Não sei</label>
                    </div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Sexo</label>
                    <div class="option-item">
                        <input type="radio" name="sexo" id="sexo1" value="male" required>
                        <label for="sexo1">Macho</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="sexo" id="sexo2" value="female">
                        <label for="sexo2">Fêmea</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="sexo" id="sexo3" value="unknown">
                        <label for="sexo3">Não sei</label>
                    </div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Castrado</label>
                    <div class="option-item">
                        <input type="radio" name="castrado" id="castrado1" value="yes" required>
                        <label for="castrado1">Sim</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="castrado" id="castrado2" value="no">
                        <label for="castrado2">Não</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="castrado" id="castrado3" value="unknown">
                        <label for="castrado3">Não sei</label>
                    </div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Agressividade</label>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo1" value="none" required>
                        <label for="agressivo1">Não é agressivo</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo2" value="humans">
                        <label for="agressivo2">Agressivo com pessoas</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo3" value="animals">
                        <label for="agressivo3">Agressivo com outros animais</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo4" value="both">
                        <label for="agressivo4">Agressivo com pessoas e animais</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo5" value="unknown">
                        <label for="agressivo5">Não sei</label>
                    </div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Porte</label>
                    <div class="option-item">
                        <input type="radio" name="porte" id="porte1" value="small" required>
                        <label for="porte1">Pequeno</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="porte" id="porte2" value="medium">
                        <label for="porte2">Médio</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="porte" id="porte3" value="large">
                        <label for="porte3">Grande</label>
                    </div>
                </div>

                <h2 class="section-title">Contato</h2>
                <div class="input-group">
                    <label for="contact" class="option-label">Contato</label>
                    <input type="tel" id="contact" name="contact" class="input-field" 
                        placeholder="O seu número de contato" 
                        required
                        readonly
                        pattern="[2-9][0-9]{8}"
                        title="Número de telefone deve ter 9 dígitos">
                    <span id="contactError" style="color: red; display: none; font-size: 14px; margin-top: 5px;">Número de telefone deve ter exatamente 9 dígitos</span>
                </div>

                <button type="submit" class="save-button">Adicionar Animal</button>
            </form>
        </div>
    </div>

    <script>
        // Verificar se está logado
        if (!localStorage.getItem('loggedIn')) {
            window.location.href = 'index.html';
        }
        
        let map, marker;
        let lastValidLocation;
        let searchTimeout;
        let breedSearchTimeout;
        
        // Lista de raças comuns de cães em Portugal
        const commonBreeds = [
            // Raças portuguesas
            "Rafeiro Alentejano", "Cão da Serra da Estrela", "Cão de Água Português", "Podengo Português",
            "Castro Laboreiro", "Cão de Fila de São Miguel", "Barbado da Terceira", "Perdigueiro Português",
            "Cão de Gado Transmontano", "Cão do Barrocal Algarvio", "Cão de Serra de Aires",
            
            // Raças internacionais populares
            "Affenpinscher", "Airedale Terrier", "Akita", "Akita Americano", "Akita Japonês", "Alapaha Blue Blood Bulldog",
            "American Bully", "American Staffordshire Terrier", "Antigo Cão de Pastor Inglês", "Basenji",
            "Basset Hound", "Beagle", "Bearded Collie", "Beauceron", "Bedlington Terrier", "Bichon Frisé",
            "Bloodhound", "Boerboel", "Boiadeiro Australiano", "Boiadeiro Bernês", "Border Collie", "Border Terrier",
            "Boston Terrier", "Boxer", "Braco Alemão", "Braco Húngaro de Pelo Curto", "Braco Italiano", "Briard",
            "Brittany", "Buldogue Americano", "Buldogue Francês", "Buldogue Inglês", "Bull Terrier", "Bull Terrier Miniatura",
            "Bulldog Americano", "Bullmastiff", "Cairn Terrier", "Cane Corso", "Cão Chinês de Crista", "Cão de Montanha dos Pirenéus",
            "Cão de Pastor Alemão", "Cão de Pastor Australiano", "Cão de Pastor Belga", "Cão de Pastor Branco Suíço",
            "Cão de Pastor Catalão", "Cão de Pastor de Beauce", "Cão de Pastor de Brie", "Cão de Pastor de Shetland",
            "Cão de Santo Humberto", "Cão d'Água Espanhol", "Cão d'Água Português", "Cão Lobo Checoslovaco",
            "Cavalier King Charles Spaniel", "Chesapeake Bay Retriever", "Chihuahua", "Chin Japonês", "Chow Chow",
            "Cirneco do Etna", "Clumber Spaniel", "Cocker Spaniel Americano", "Cocker Spaniel Inglês", "Collie",
            "Coonhound", "Corgi Galês Cardigan", "Corgi Galês Pembroke", "Curly-Coated Retriever", "Dachshund",
            "Dálmata", "Dandie Dinmont Terrier", "Deerhound", "Dobermann", "Dogo Argentino", "Dogo Canário",
            "Dogue Alemão", "Dogue de Bordeaux", "Dogue do Tibete", "Drever", "Elkhound Norueguês", "Épagneul Bretão",
            "Eurasier", "Fila Brasileiro", "Flat-Coated Retriever", "Fox Terrier", "Foxhound Americano", "Foxhound Inglês",
            "Galgo Espanhol", "Galgo Italiano", "Galgo Persa", "Golden Retriever", "Grande Boiadeiro Suíço",
            "Grande Münsterländer", "Greyhound", "Griffon Bruxelois", "Griffon de Pelo Duro", "Harrier", "Havanese",
            "Hokkaido", "Husky Siberiano", "Irish Terrier", "Jack Russell Terrier", "Keeshond", "Kelpie Australiano",
            "Kerry Blue Terrier", "King Charles Spaniel", "Komondor", "Kuvasz", "Labradoodle", "Labrador Retriever",
            "Lagotto Romagnolo", "Lakeland Terrier", "Lancashire Heeler", "Leonberger", "Lhasa Apso", "Lulu da Pomerânia",
            "Malamute do Alasca", "Maltês", "Manchester Terrier", "Mastiff", "Mastim Espanhol", "Mastim Napolitano",
            "Mastim Tibetano", "Norwich Terrier", "Nova Scotia Duck Tolling Retriever", "Old English Sheepdog",
            "Otterhound", "Papillon", "Pastor Alemão", "Pastor Australiano", "Pastor Belga Malinois", 
            "Pastor Belga Tervuren", "Pastor Bergamasco", "Pastor Branco Suíço", "Pastor Cáucaso", 
            "Pastor da Ásia Central", "Pastor de Beauce", "Pastor dos Pirinéus", "Pequeno Cão Leão", 
            "Pequinês", "Perdigueiro Português", "Pharaoh Hound", "Pinscher Alemão", "Pinscher Miniatura",
            "Pit Bull Terrier Americano", "Podenco Ibicenco", "Podengo Português", "Pointer Inglês", "Poodle",
            "Poodle Miniatura", "Poodle Toy", "Pug", "Puli", "Pumi", "Racka", "Rottweiler", "Saluki",
            "Samoieda", "São Bernardo", "Schipperke", "Schnauzer", "Schnauzer Gigante", "Schnauzer Miniatura",
            "Scottish Terrier", "Sealyham Terrier", "Setter Gordon", "Setter Inglês", "Setter Irlandês",
            "Shar Pei", "Shiba Inu", "Shih Tzu", "Skye Terrier", "Sloughi", "Spaniel Bretão", "Spaniel do Campo",
            "Spaniel dos Campos", "Spaniel Francês", "Spaniel Japonês", "Spaniel Tibetano", "Spitz Alemão",
            "Spitz Finlandês", "Spitz Japonês", "Springer Spaniel Inglês", "Stabyhoun", "Staffordshire Bull Terrier",
            "Swedish Vallhund", "Teckel", "Terra Nova", "Terrier Brasileiro", "Terrier Checo", "Terrier Escocês",
            "Terrier Irlandês", "Terrier Japonês", "Terrier Norfolk", "Terrier Norwich", "Terrier Preto da Rússia",
            "Terrier Tibetano", "Tosa Inu", "Vizsla", "Vulpino Italiano", "Weimaraner", "Welsh Springer Spaniel",
            "Welsh Terrier", "West Highland White Terrier", "Whippet", "Xoloitzcuintle", "Yorkshire Terrier",
            
            // Cães de raça mista comuns
            "Labradoodle", "Goldendoodle", "Cockapoo", "Maltipoo", "Puggle", "Schnoodle", "Cavachon", "Pomsky", 
            "Cavapoo", "Chorkie", "Chiweenie", "Morkie", "Poochon", "Sheepadoodle", "Bernedoodle", "Aussiepoo",
            "Cão de raça mista", "SRD (Sem Raça Definida)", "Rafeiro"
        ];

        function initMap(userLat, userLng) {
            // Define uma localização padrão (Lisboa) caso não haja localização do usuário
            const defaultLocation = { lat: 38.7223, lng: -9.1393 };
            const initialLocation = userLat && userLng ? 
                { lat: userLat, lng: userLng } : defaultLocation;
            
            // Garantir que o elemento do mapa existe no DOM
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('Elemento do mapa não encontrado!');
                return;
            }
            
            // Configuração do mapa
            try {
                map = new google.maps.Map(mapElement, {
                    center: initialLocation,
                    zoom: 13,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    mapTypeControl: true,
                    zoomControl: true,
                    streetViewControl: false,
                    fullscreenControl: false
            });

                // Forçar o layout para garantir que o mapa seja renderizado corretamente
                google.maps.event.addListenerOnce(map, 'idle', function() {
                    google.maps.event.trigger(map, 'resize');
                    map.setCenter(initialLocation);
            });

                // Adicionar marcador na localização inicial se tivermos coordenadas do usuário
                if (userLat && userLng) {
                    if (marker) marker.setMap(null);
                    marker = new google.maps.Marker({
                        position: initialLocation,
                        map: map,
                        animation: google.maps.Animation.DROP
                    });
                    
                    // Preencher os campos ocultos com a localização
                    document.getElementById('latitude').value = userLat;
                    document.getElementById('longitude').value = userLng;
                    
                    // Geocodificar para obter o endereço
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ 'location': initialLocation }, function(results, status) {
                        if (status === google.maps.GeocoderStatus.OK && results[0]) {
                            document.getElementById('locationText').textContent = results[0].formatted_address;
                            document.querySelector('.location-info').style.border = '2px solid #2ecc71';
                        }
                    });
                }
                
                // Adicionar evento de clique no mapa
                map.addListener('click', function(e) {
                    const clickedLocation = e.latLng;
                
                    // Remover marcador anterior, se existir
                    if (marker) marker.setMap(null);
                    
                    // Adicionar novo marcador
                    marker = new google.maps.Marker({
                        position: clickedLocation,
                        map: map,
                        animation: google.maps.Animation.DROP
                    });
                    
                    // Geocodificar coordenadas para obter endereço
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ 'location': clickedLocation }, function(results, status) {
                        if (status === google.maps.GeocoderStatus.OK && results[0]) {
                            // Guardar endereço
                            const formattedAddress = results[0].formatted_address;
                            document.getElementById('locationText').textContent = formattedAddress;
                            
                            // Guardar coordenadas precisas
                            document.getElementById('latitude').value = clickedLocation.lat();
                            document.getElementById('longitude').value = clickedLocation.lng();
                            
                            lastValidLocation = {
                                lat: clickedLocation.lat(),
                                lng: clickedLocation.lng(),
                                address: formattedAddress
                            };
                            
                            // Atualizar campo de pesquisa
                            document.getElementById('locationSearch').value = formattedAddress;
                            
                            document.querySelector('.location-info').style.border = '2px solid #2ecc71';
                } else {
                            document.getElementById('locationText').textContent = `Localização (${clickedLocation.lat().toFixed(6)}, ${clickedLocation.lng().toFixed(6)})`;
                            document.getElementById('latitude').value = clickedLocation.lat();
                            document.getElementById('longitude').value = clickedLocation.lng();
                            
                            lastValidLocation = {
                                lat: clickedLocation.lat(),
                                lng: clickedLocation.lng(),
                                address: `Localização (${clickedLocation.lat().toFixed(6)}, ${clickedLocation.lng().toFixed(6)})`
                            };
                            
                            document.querySelector('.location-info').style.border = '2px solid #f39c12';
                        }
                    });
                });
                
                console.log('Mapa inicializado com sucesso');
            } catch (error) {
                console.error('Erro ao inicializar o mapa:', error);
                mapElement.innerHTML = '<div style="padding:30px;text-align:center;color:#e74c3c;">Erro ao carregar o mapa. Por favor, recarregue a página.</div>';
            }
        }

        // Configurar campo de pesquisa de localização depois que o mapa estiver pronto
        function setupLocationSearch() {
            const locationInput = document.getElementById('locationSearch');
            if (locationInput) {
                locationInput.addEventListener('input', function() {
                    searchLocation(this.value);
                });
            }
        }
        
        // Função para pesquisar localizações usando o Google Maps Geocoding
        // Recebe como parâmetro o texto que o utilizador escreveu
        function searchLocation(query) {
            // Cancelar pesquisa anterior se ainda estiver a decorrer (evita pesquisas desnecessárias)
            if (searchTimeout) clearTimeout(searchTimeout);
            const suggestionsContainer = document.getElementById('locationSuggestions');
            
            // Só pesquisar se o utilizador inseriu pelo menos 3 caracteres
            if (query.length < 3) {
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.style.display = 'none';
                return;
            }
                    
            // Aguardar 500ms antes de pesquisar para evitar muitas pesquisas enquanto o utilizador escreve
            searchTimeout = setTimeout(() => {
                // Usar o serviço de geocodificação do Google Maps para converter texto em coordenadas
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ 'address': query }, function(results, status) {
                    // Se encontrou resultados válidos
                    if (status === google.maps.GeocoderStatus.OK && results.length > 0) {
                        // Limpar sugestões anteriores
                        suggestionsContainer.innerHTML = '';
                        
                        // Mostrar apenas os primeiros 5 resultados para não sobrecarregar a interface
                        results.slice(0, 5).forEach(result => {
                            // Criar elemento HTML para cada sugestão
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.innerHTML = result.formatted_address;
                            
                            // Quando o utilizador clica numa sugestão
                            div.addEventListener('click', function() {
                                // Preencher o campo de pesquisa com o endereço selecionado
                                document.getElementById('locationSearch').value = result.formatted_address;
                            
                                // Mostrar o endereço selecionado na interface do utilizador
                                document.getElementById('locationText').textContent = result.formatted_address;
                            
                                // Extrair e guardar as coordenadas para usar quando submeter o formulário
                                const lat = result.geometry.location.lat();
                                const lng = result.geometry.location.lng();
                                document.getElementById('latitude').value = lat;
                                document.getElementById('longitude').value = lng;
                                
                                // Guardar a localização válida numa variável global para referência futura
                                lastValidLocation = {
                                    lat: lat,
                                    lng: lng,
                                    address: result.formatted_address
                                };
                            
                                // Atualizar o mapa para mostrar a localização selecionada
                                if (map) {
                                    map.setCenter(result.geometry.location); // Centrar mapa na localização
                                    map.setZoom(16); // Fazer zoom para ver melhor a área
                                    
                                    // Remover marcador anterior se existir
                                    if (marker) marker.setMap(null);
                                    // Criar novo marcador na localização selecionada
                                    marker = new google.maps.Marker({
                                        position: result.geometry.location,
                                        map: map,
                                        title: result.formatted_address,
                                        animation: google.maps.Animation.DROP // Animação de queda
                                    });
                                }
                                
                                // Feedback visual: borda verde indica que a localização foi selecionada com sucesso
                                document.querySelector('.location-info').style.border = '2px solid #2ecc71';
                            
                                // Esconder as sugestões após selecção
                                suggestionsContainer.style.display = 'none';
                            });
                            // Adicionar a sugestão ao contentor de sugestões
                            suggestionsContainer.appendChild(div);
                        });
                        
                        // Mostrar o contentor de sugestões
                        suggestionsContainer.style.display = 'block';
                    } else {
                        // Se não encontrou resultados, mostrar mensagem informativa
                        suggestionsContainer.innerHTML = '<div class="suggestion-item">Nenhum resultado encontrado</div>';
                        suggestionsContainer.style.display = 'block';
                    }
                });
            }, 500);
        }

        // Função para obter a localização actual do utilizador usando GPS/Wi-Fi
        function useMyLocation() {
            // Verificar se o navegador suporta geolocalização
            if (navigator.geolocation) {
                // Obter referência do botão e desactivá-lo durante o processo
                const locationButton = document.querySelector('.use-my-location');
                locationButton.disabled = true;
                locationButton.textContent = 'A obter localização...';
                
                // Mostrar feedback visual ao utilizador de que está a processar
                document.getElementById('locationText').textContent = 'A obter a sua localização...';
                document.querySelector('.location-info').style.border = '2px solid #3498db'; // Borda azul = a processar

                // Pedir a localização actual do utilizador
                navigator.geolocation.getCurrentPosition(
                    // Função executada quando consegue obter a localização
                    (position) => {
                        // Extrair coordenadas da resposta
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Guardar as coordenadas imediatamente para garantir que temos uma localização válida
                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = lng;
                        
                        // Converter coordenadas em endereço legível (geocodificação reversa)
                        const geocoder = new google.maps.Geocoder();
                        geocoder.geocode({ 
                            'location': { lat, lng },
                            'language': 'pt-PT' // Forçar resultados em português de Portugal
                        }, function(results, status) {
                            if (status === google.maps.GeocoderStatus.OK && results.length > 0) {
                                // Tentar encontrar o resultado mais detalhado com endereço de rua
                                let bestResult = results[0]; // Por defeito, usar o primeiro resultado
                                
                                // Procurar um resultado que tenha informação de rua detalhada
                                for (let i = 0; i < results.length; i++) {
                                    const result = results[i];
                                    // Verificar se contém componentes específicos de endereço de rua
                                    const hasStreetComponents = result.address_components.some(comp => 
                                        comp.types.includes('route') ||           // Nome da rua
                                        comp.types.includes('street_address') ||  // Endereço completo
                                        comp.types.includes('premise') ||         // Edifício específico
                                        comp.types.includes('subpremise')         // Apartamento/loja
                                    );
                                    
                                    if (hasStreetComponents) {
                                        bestResult = result;
                                        break; // Encontrámos um bom resultado, parar a procura
                                    }
                                }
                                
                                // Usar o melhor resultado disponível
                                const formattedAddress = bestResult.formatted_address;
                                document.getElementById('locationSearch').value = formattedAddress;
                                document.getElementById('locationText').textContent = formattedAddress;
                                
                                // Atualizar o mapa para mostrar a localização
                                map.setCenter({lat, lng});
                                map.setZoom(17); // Zoom próximo para mostrar detalhes da rua
                                
                                // Remover marcador anterior e criar novo
                                if (marker) marker.setMap(null);
                                marker = new google.maps.Marker({
                                    position: {lat, lng},
                                    map: map,
                                    animation: google.maps.Animation.DROP // Animação de queda
                                });
                                
                                // Feedback visual positivo: borda verde = sucesso
                                document.querySelector('.location-info').style.border = '2px solid #2ecc71';
                                
                                console.log('Endereço encontrado:', formattedAddress);
                            } else {
                                // Se não conseguiu obter endereço, usar apenas as coordenadas
                                console.error('Geocodificação falhou:', status);
                                const coords = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                                document.getElementById('locationText').textContent = `Localização actual (${coords})`;
                                
                                // Atualizar mapa mesmo sem endereço
                                map.setCenter({lat, lng});
                                
                                if (marker) marker.setMap(null);
                                marker = new google.maps.Marker({
                                    position: {lat, lng},
                                    map: map,
                                    animation: google.maps.Animation.DROP
                                });
                                
                                // Feedback visual neutro: borda laranja = parcialmente bem-sucedido
                                document.querySelector('.location-info').style.border = '2px solid #f39c12';
                            }
                            
                            // Restaurar o botão ao estado normal
                            locationButton.disabled = false;
                            locationButton.innerHTML = '<i class="fas fa-location-arrow"></i> Usar a minha localização atual';
                        });
                    },
                    // Função executada quando há erro ao obter a localização
                    (error) => {
                        console.error('Erro ao obter localização:', error);
                        let errorMsg = 'Não foi possível obter a sua localização.';
                        
                        // Personalizar mensagem de erro baseada no tipo de erro
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMsg += ' Negou a permissão de localização.';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMsg += ' Informações de localização indisponíveis.';
                        } else if (error.code === error.TIMEOUT) {
                            errorMsg += ' O tempo para obter a localização expirou.';
                        }
                        
                        console.error('Erro de geolocalização:', error);
                        
                        // Mostrar mensagem de erro ao utilizador e sugerir alternativas
                        alert(errorMsg + ' Por favor, selecione manualmente no mapa ou use a pesquisa de morada.');
                        document.getElementById('locationText').textContent = 'Clique no mapa ou pesquise uma morada';
                        document.querySelector('.location-info').style.border = ''; // Remover borda colorida
                        
                        // Restaurar o botão ao estado normal
                        locationButton.disabled = false;
                        locationButton.innerHTML = '<i class="fas fa-location-arrow"></i> Usar a minha localização atual';
                    },
                    // Opções para a geolocalização
                    {
                        enableHighAccuracy: true, // Usar GPS se disponível para maior precisão
                        timeout: 10000,           // Tempo limite de 10 segundos
                        maximumAge: 0             // Não aceitar localização em cache, obter sempre nova
                    }
                );
            } else {
                // Se o navegador não suporta geolocalização
                alert('O seu navegador não suporta geolocalização.');
            }
        }

        function setupBreedSearch() {
            const breedInput = document.getElementById('breedSearch');
            const suggestionsContainer = document.getElementById('breedSuggestions');
            
            breedInput.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                
                // Clear previous timeout
                if (breedSearchTimeout) {
                    clearTimeout(breedSearchTimeout);
                }
                
                // Show suggestions if the query is at least 2 characters
                if (query.length >= 2) {
                    breedSearchTimeout = setTimeout(() => {
                        // Filter breeds that match the query
                        const matchedBreeds = commonBreeds.filter(breed => 
                            breed.toLowerCase().includes(query)
                        );
                        
                        // Display matched breeds
                        if (matchedBreeds.length > 0) {
                            suggestionsContainer.innerHTML = '';
                            matchedBreeds.forEach(breed => {
                                const div = document.createElement('div');
                                div.className = 'suggestion-item';
                                div.textContent = breed;
                                div.addEventListener('click', function() {
                                    breedInput.value = breed;
                                    suggestionsContainer.style.display = 'none';
                                });
                                suggestionsContainer.appendChild(div);
                            });
                            suggestionsContainer.style.display = 'block';
                        } else {
                            suggestionsContainer.innerHTML = '<div class="suggestion-item">Nenhuma raça encontrada</div>';
                            suggestionsContainer.style.display = 'block';
                        }
                    }, 200); // Shorter timeout as it's a local search
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target !== breedInput && e.target !== suggestionsContainer) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }

        function previewImage(input) {
            const preview = document.getElementById('photoPreview');
            const photoUpload = document.querySelector('.photo-upload');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('A imagem deve ter no máximo 5MB');
                    input.value = '';
                    return;
                }

                // Validate file type
                if (!file.type.match('image.*')) {
                    alert('Por favor, selecione apenas ficheiros de imagem');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    photoUpload.classList.add('has-image');
                }
                
                reader.readAsDataURL(file);
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // SOLUÇÃO RADICAL: Verificar a tabela diretamente
                console.log("Verificando conexão com Supabase...");
                
                // Verificar se a tabela dogs existe e qual é seu esquema
                const { data: tablesData, error: tablesError } = await window.supabase
                    .from('information_schema.tables')
                    .select('table_name')
                    .eq('table_schema', 'public');
                    
                if (tablesError) {
                    console.error("Erro ao verificar tabelas:", tablesError);
                } else {
                    console.log("Tabelas disponíveis:", tablesData);
                    
                    // Verificar se a tabela dogs existe
                    const dogsTableExists = tablesData.some(t => t.table_name === 'dogs');
                    console.log("Tabela 'dogs' existe:", dogsTableExists);
                    
                    if (dogsTableExists) {
                        // Verificar o esquema da tabela dogs para ver as colunas reais
                        const { data: columnsData, error: columnsError } = await window.supabase
                            .from('information_schema.columns')
                            .select('column_name, data_type')
                            .eq('table_schema', 'public')
                            .eq('table_name', 'dogs');
                        
                        if (columnsError) {
                            console.error("Erro ao verificar colunas:", columnsError);
                        } else {
                            console.log("Colunas da tabela 'dogs':", columnsData);
                            
                            // Verificar se a coluna 'contato' existe
                                            const contatoExists = columnsData.some(c => c.column_name === 'contato');
                console.log("Coluna 'contato' existe:", contatoExists);
                            
                            // Verificar todas as variações possíveis do campo de contato
                            const contactVariations = ['contact', 'telefone', 'phone', 'telefono', 'phone_number'];
                            contactVariations.forEach(variation => {
                                const exists = columnsData.some(c => c.column_name === variation);
                                console.log(`Coluna '${variation}' existe:`, exists);
                            });
                            
                            // Armazenar o nome correto da coluna para uso posterior
                                            if (contatoExists) {
                    window.contactColumnName = 'contato';
                            } else {
                                // Verificar se alguma variação existe
                                for (const variation of contactVariations) {
                                    if (columnsData.some(c => c.column_name === variation)) {
                                        window.contactColumnName = variation;
                                        break;
                                    }
                                }
                            }
                            
                            console.log("Nome da coluna de contato a ser usado:", window.contactColumnName || "Não encontrado");
                        }
                    }
                }
            } catch (e) {
                console.error("Erro ao verificar esquema:", e);
            }
            
            // Resto do código de inicialização...
            // Configurar a pesquisa de raças
            setupBreedSearch();
            
            // Configurar a pesquisa de localização
            setupLocationSearch();
            
            // Função para verificar se o Google Maps já foi carregado
            function checkGoogleMapsLoaded() {
                if (window.google && window.google.maps) {
                    // Google Maps está carregado, inicializar o mapa
                    initializeMap();
                } else {
                    // Verificar novamente em 100ms
                    setTimeout(checkGoogleMapsLoaded, 100);
                }
            }
            
            // Iniciar verificação do carregamento do Google Maps
            checkGoogleMapsLoaded();
            
            // Função para inicializar o mapa quando o Google Maps estiver carregado
            function initializeMap() {
                // Verificar se o elemento do mapa existe
                if (document.getElementById('map')) {
                    // Tentar obter a localização do usuário
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                initMap(position.coords.latitude, position.coords.longitude);
                            },
                            (error) => {
                                console.error('Erro ao obter localização:', error);
                                initMap(); // Will use default Lisbon coordinates
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 5000,
                                maximumAge: 0
                            }
                        );
                    } else {
                        console.log('Geolocalização não suportada');
                        initMap(); // Will use default Lisbon coordinates
                    }
                } else {
                    console.error('Elemento do mapa não encontrado no DOM');
                }
            }

            // Preencher automaticamente o campo de contato com o número do usuário
            const userPhone = localStorage.getItem('userPhone');
            if (userPhone) {
                const contactInput = document.getElementById('contact');
                if (contactInput) {
                    contactInput.value = userPhone;
                }
            } else {
                // Se não houver telefone do utilizador, mostrar um alerta
                alert('Por favor, atualize o seu perfil com um número de telefone para adicionar animais.');
                // Redirecionar para a página de conta
                window.location.href = 'home.html';
            }
        });

        // Função para salvar no Supabase - adaptada para a estrutura real da tabela
        async function saveDog(dogData) {
            console.log("Tentando salvar com estrutura correta da tabela:", dogData);
            
            try {
                // Usar apenas os campos que realmente existem na tabela
                const { data, error } = await window.supabase
                    .from('dogs')
                    .insert([{
                        user_id: dogData.user_id,
                        nome: dogData.nome || null,
                        raca: dogData.raca || null,
                        idade: dogData.idade || null,
                        sexo: dogData.sexo || null,
                        porte: dogData.porte || null,
                        estado: dogData.estado,
                        descricao: dogData.descricao || null,
                        caracteristicas: dogData.caracteristicas || null,
                        castrado: dogData.castrado,
                        agressivo: dogData.agressivo || null,
                        endereco: dogData.endereco || null,
                        image: dogData.image,
                        location: dogData.location
                        // Não incluir contato pois não existe na tabela
                        // created_at é gerenciado automaticamente pelo banco de dados
                    }]);
                
                if (error) {
                    console.error("Erro ao salvar:", error);
                    throw error;
                }
                
                return data;
            } catch (error) {
                console.error("Erro completo:", error);
                throw error;
            }
        }

        // Event listener do formulário
        document.getElementById('addDogForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validações básicas
            const requiredFields = ["estado", "idade", "sexo", "castrado", "agressivo", "porte"];
            let hasErrors = false;
            
            // Validação de contato - vamos manter para fins de UX, mas não vamos salvar
            const contactInput = document.getElementById('contact');
            const contactError = document.getElementById('contactError');
            
            if (!contactInput.value.match(/^[2-9][0-9]{8}$/)) {
                contactError.style.display = 'block';
                contactInput.focus();
                hasErrors = true;
            } else {
                contactError.style.display = 'none';
            }
            
            // Validar outros campos obrigatórios
            requiredFields.forEach(field => {
                const radioButtons = document.querySelectorAll(`input[name="${field}"]`);
                let isChecked = false;
                radioButtons.forEach(radio => {
                    if (radio.checked) isChecked = true;
                });
                
                if (!isChecked) {
                    const label = document.querySelector(`label.option-label[for="${field}"]`) || 
                                  document.querySelector(`.options-group:has(input[name="${field}"]) .option-label`);
                    
                    if (label) {
                        label.style.color = '#e74c3c';
                        setTimeout(() => {
                            label.style.color = '';
                        }, 3000);
                    }
                    hasErrors = true;
                }
            });
            
            // Validar localização
            if (!document.getElementById('latitude').value || !document.getElementById('longitude').value) {
                document.querySelector('.location-info').style.border = '2px solid #e74c3c';
                document.getElementById('locationText').textContent = "Por favor, selecione uma localização no mapa";
                hasErrors = true;
                
                setTimeout(() => {
                    document.querySelector('.location-info').style.border = '';
                }, 3000);
            }
            
            if (hasErrors) {
                return;
            }
            
            // Mostrar indicador de carregamento
            const saveButton = document.querySelector('.save-button');
            saveButton.disabled = true;
            saveButton.textContent = 'Salvando...';
            saveButton.style.backgroundColor = '#ccc';
            
            try {
                // Preparar dados básicos
                const formData = new FormData(this);
                const imageFile = document.getElementById('photoInput').files[0];
                
                // Processar imagem
                let imageData = null;
                if (imageFile) {
                    const compressedImage = await compressImage(imageFile);
                    imageData = await blobToBase64(compressedImage);
                }
                
                // Obter ID do usuário
                const userId = localStorage.getItem('currentUserId');
                if (!userId) {
                    throw new Error('Utilizador não conectado');
                }
                
                // Obter número de contato para usar como nome ou descrição
                const contato = document.getElementById('contact').value;
                
                // Criar objeto de dados que corresponde EXATAMENTE à tabela do banco de dados
                const dogData = {
                    user_id: userId,
                    // Usar o número de contato como nome para fins de referência
                    nome: "Animal adicionado por: " + contato,
                    raca: document.getElementById('breedSearch').value || null,
                    idade: formData.get('idade') || null,
                    sexo: formData.get('sexo') || null,
                    porte: formData.get('porte') || null,
                    estado: formData.get('estado'),
                    // Adicionar o contato na descrição já que não temos campo específico
                    descricao: "Contato: " + contato,
                    caracteristicas: null,
                    castrado: formData.get('castrado') === 'yes',
                    agressivo: formData.get('agressivo') || null,
                    endereco: document.getElementById('locationText').textContent,
                    image: imageData,
                    location: {
                        lat: parseFloat(document.getElementById('latitude').value),
                        lng: parseFloat(document.getElementById('longitude').value)
                    }
                };
                
                console.log("Tentando salvar dados com estrutura correta:", dogData);
                
                // Usar a função adaptada
                await saveDog(dogData);
                
                alert('Animal adicionado com sucesso!');
                window.location.href = 'home.html';
            } catch (error) {
                console.error('Erro ao adicionar animal:', error);
                
                let errorMsg = 'Erro ao adicionar animal: ';
                if (error.message) {
                    errorMsg += error.message;
                } else {
                    errorMsg += 'Erro desconhecido';
                }
                
                alert(errorMsg);
                
                // Restaurar botão
                saveButton.disabled = false;
                saveButton.textContent = 'Adicionar Animal';
                saveButton.style.backgroundColor = '#FF7F50';
            }
        });

        // Função para comprimir imagem
        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Redimensionar se a imagem for muito grande
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        
                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob(resolve, 'image/jpeg', 0.7);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Função para converter Blob para Base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function() {
                    resolve(reader.result);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
    </script>
</body>
</html>