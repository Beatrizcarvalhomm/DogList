<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DogList - Adicionar Animal</title>
    <link rel="icon" href="Images/DogList-Logo.png" type="image/png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Google Maps Script -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYiAXh7HwQgCEudiSzPR3bUuYQ1mnS3b4&libraries=geometry" async defer></script>
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Inicializar o cliente Supabase corretamente
        const supabaseUrl = 'https://jwyzbfbzxbedjskumgli.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3eXpiZmJ6eGJlZGpza3VtZ2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3NjA4MDksImV4cCI6MjA2MzMzNjgwOX0.8GEehgGUF-9zv1WwneYZBs1K3VLEZtxB9v0R6An0GIc';
        
        // Inicializar o cliente Supabase de forma correta e expl√≠cita
        const { createClient } = supabase;
        window.supabase = createClient(supabaseUrl, supabaseKey);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background-color: #FFE4D6;
            min-height: 100vh;
            color: #333;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #FFE4D6;
        }

        .header {
            background-color: #FFFFFF;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            margin: 0 20px;
            border-radius: 0 0 20px 20px;
            height: 60px;
            box-sizing: border-box;
        }

        .back-button {
            font-size: 24px;
            text-decoration: none;
            color: #FF7F50;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            background-color: #FFFFFF;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1001;
        }

        .back-button:hover {
            background-color: #FFFFFF;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            letter-spacing: 0.5px;
            text-align: center;
            margin: 0 auto;
            cursor: pointer;
            transition: color 0.3s ease;
            position: relative;
            display: inline-block;
        }

        .title:hover {
            color: #333;
            text-shadow: 0 0 10px rgba(255, 127, 80, 0.3);
        }

        .title:after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 2px;
            background-color: #FF7F50;
            border-radius: 2px;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .title:hover:after {
            width: 120px;
            background-color: #FF6347;
        }

        .content {
            flex: 1;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 25px 0 15px;
            color: #FF7F50;
            border-left: 4px solid #FF7F50;
            padding-left: 10px;
        }

        .photo-upload {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: 20px;
            margin: 20px auto;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px dashed #ddd;
        }

        .photo-upload:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .photo-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-upload i {
            position: absolute;
            color: #888;
            display: block;
            transition: all 0.3s ease;
        }

        .photo-upload:hover i {
            transform: scale(1.1);
            color: #FF7F50;
        }

        .photo-upload.has-image {
            border: none;
        }

        .photo-upload.has-image i {
            display: none;
        }

        .photo-hint {
            text-align: center;
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 20px;
        }

        .options-group {
            background: white;
            padding: 20px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .option-label {
            font-weight: 600;
            margin-bottom: 15px;
            display: block;
            color: #333;
        }

        .option-item {
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option-item input[type="radio"] {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 50%;
            outline: none;
            transition: all 0.3s ease;
        }

        .option-item input[type="radio"]:checked {
            border: 6px solid #FF7F50;
        }

        .option-item label {
            cursor: pointer;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 15px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
            margin-bottom: 5px;
        }

        .input-field:focus {
            outline: none;
            border-color: #FF7F50;
            box-shadow: 0 0 0 3px rgba(255, 127, 80, 0.2);
        }
        
        /* Estilo para campos readonly como o contato */
        .input-field[readonly] {
            background-color: #f0f0f0;
            color: #666;
            cursor: not-allowed;
            border-color: #ddd;
        }
        
        .input-field[readonly]:focus {
            box-shadow: none;
            border-color: #ddd;
        }

        .map-container {
            width: 100%;
            height: 300px;
            border-radius: 20px;
            overflow: hidden;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid white;
        }

        .location-info {
            margin-top: 15px;
            padding: 12px;
            background-color: white;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .location-info i {
            color: #FF7F50;
            font-size: 18px;
        }

        .use-my-location {
            background-color: #FF7F50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            justify-content: center;
        }

        .use-my-location:hover {
            background-color: #ff6b3d;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .save-button {
            width: 100%;
            padding: 15px;
            background-color: #FF7F50;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            margin-bottom: 40px;
        }

        .save-button:hover {
            background-color: #ff6b3d;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .location-search {
            margin-bottom: 15px;
            position: relative;
        }

        .location-search input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 15px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .location-search input:focus {
            outline: none;
            border-color: #FF7F50;
            box-shadow: 0 0 0 3px rgba(255, 127, 80, 0.2);
        }

        .location-suggestions, .breed-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 15px 15px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
            transition: all 0.2s ease;
        }

        .suggestion-item:hover {
            background-color: #f5f5f5;
        }

        .breed-search {
            position: relative;
        }

        .error-message {
            color: #e74c3c;
            font-size: 0.9rem;
            margin-top: 5px;
            display: block;
        }

        .required-field::after {
            content: "*";
            color: #e74c3c;
            margin-left: 4px;
        }

        /* Responsiveness */
        @media (max-width: 768px) {
            .header {
                padding: 0 20px;
                margin: 0 10px;
                height: 60px;
            }
            
            .title {
                font-size: 20px;
            }
            
            .back-button {
                left: 15px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0 15px;
                margin: 0 8px;
                height: 50px;
            }
            
            .title {
                font-size: 18px;
            }
            
            .back-button {
                font-size: 22px;
                width: 35px;
                height: 35px;
                left: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="home.html" class="back-button">‚Üê</a>
            <span class="title">Adicionar Animal</span>
        </div>

        <div class="content">
            <form id="addDogForm">
                <h2 class="section-title">Foto do Animal</h2>
                <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                    <img id="photoPreview" alt="Preview">
                    <i class="fas fa-camera fa-2x"></i>
                    <input type="file" id="photoInput" style="display: none" accept="image/*" onchange="previewImage(this)">
                </div>
                <p class="photo-hint">Toque para adicionar uma foto (opcional)</p>

                <h2 class="section-title">Informa√ß√µes B√°sicas</h2>
                <div class="options-group">
                    <label class="option-label required-field">Estado</label>
                    <div class="option-item">
                        <input type="radio" name="estado" id="encontrado" value="encontrado" required>
                        <label for="encontrado">Encontrado</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="estado" id="procurado" value="procurado">
                        <label for="procurado">Procurado</label>
                    </div>
                </div>

                <h2 class="section-title">Localiza√ß√£o</h2>
                <div class="input-group">
                    <div class="location-search">
                        <input type="text" id="locationSearch" placeholder="Pesquisar morada..." autocomplete="off">
                        <div id="locationSuggestions" class="location-suggestions"></div>
                    </div>
                    <div class="map-container" id="map"></div>
                    <div class="location-info">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="locationText">Clique no mapa ou pesquise uma morada</span>
                    </div>
                    <button type="button" class="use-my-location" onclick="useMyLocation()">
                        <i class="fas fa-location-arrow"></i>
                        Usar a minha localiza√ß√£o atual
                    </button>
                    <input type="hidden" id="latitude" required>
                    <input type="hidden" id="longitude" required>
                </div>

                <h2 class="section-title">Caracter√≠sticas</h2>
                <div class="input-group breed-search">
                    <input type="text" class="input-field" name="raca" id="breedSearch" placeholder="Ra√ßa (opcional)" minlength="2" maxlength="50" pattern="[A-Za-z√Ä-√ø\s\-]+" title="Por favor, insira uma ra√ßa v√°lida (apenas letras, espa√ßos e h√≠fens)">
                    <div id="breedSuggestions" class="breed-suggestions"></div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Idade</label>
                    <div class="option-item">
                        <input type="radio" name="idade" id="idade1" value="0-5" required>
                        <label for="idade1">0-5 anos</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="idade" id="idade2" value="5-10">
                        <label for="idade2">5-10 anos</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="idade" id="idade3" value="10+">
                        <label for="idade3">+10 anos</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="idade" id="idade4" value="unknown">
                        <label for="idade4">N√£o sei</label>
                    </div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Sexo</label>
                    <div class="option-item">
                        <input type="radio" name="sexo" id="sexo1" value="male" required>
                        <label for="sexo1">Macho</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="sexo" id="sexo2" value="female">
                        <label for="sexo2">F√™mea</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="sexo" id="sexo3" value="unknown">
                        <label for="sexo3">N√£o sei</label>
                    </div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Castrado</label>
                    <div class="option-item">
                        <input type="radio" name="castrado" id="castrado1" value="yes" required>
                        <label for="castrado1">Sim</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="castrado" id="castrado2" value="no">
                        <label for="castrado2">N√£o</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="castrado" id="castrado3" value="unknown">
                        <label for="castrado3">N√£o sei</label>
                    </div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Agressividade</label>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo1" value="none" required>
                        <label for="agressivo1">N√£o √© agressivo</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo2" value="humans">
                        <label for="agressivo2">Agressivo com pessoas</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo3" value="animals">
                        <label for="agressivo3">Agressivo com outros animais</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo4" value="both">
                        <label for="agressivo4">Agressivo com pessoas e animais</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="agressivo" id="agressivo5" value="unknown">
                        <label for="agressivo5">N√£o sei</label>
                    </div>
                </div>

                <div class="options-group">
                    <label class="option-label required-field">Porte</label>
                    <div class="option-item">
                        <input type="radio" name="porte" id="porte1" value="small" required>
                        <label for="porte1">Pequeno</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="porte" id="porte2" value="medium">
                        <label for="porte2">M√©dio</label>
                    </div>
                    <div class="option-item">
                        <input type="radio" name="porte" id="porte3" value="large">
                        <label for="porte3">Grande</label>
                    </div>
                </div>

                <h2 class="section-title">Contato</h2>
                <div class="input-group">
                    <label for="contact" class="option-label">Contato</label>
                    <input type="tel" id="contact" name="contact" class="input-field" 
                        placeholder="O seu n√∫mero de contato" 
                        required
                        readonly
                        pattern="[2-9][0-9]{8}"
                        title="N√∫mero de telefone deve ter 9 d√≠gitos">
                    <span id="contactError" style="color: red; display: none; font-size: 14px; margin-top: 5px;">N√∫mero de telefone deve ter exatamente 9 d√≠gitos</span>
                </div>

                <button type="submit" class="save-button">Adicionar Animal</button>
            </form>
        </div>
    </div>

    <script>
        // Verificar se est√° logado
        if (!localStorage.getItem('loggedIn')) {
            window.location.href = 'index.html';
        }
        
        let map, marker;
        let lastValidLocation;
        let searchTimeout;
        let breedSearchTimeout;
        
        // Lista de ra√ßas comuns de c√£es em Portugal
        const commonBreeds = [
            // Ra√ßas portuguesas
            "Rafeiro Alentejano", "C√£o da Serra da Estrela", "C√£o de √Ågua Portugu√™s", "Podengo Portugu√™s",
            "Castro Laboreiro", "C√£o de Fila de S√£o Miguel", "Barbado da Terceira", "Perdigueiro Portugu√™s",
            "C√£o de Gado Transmontano", "C√£o do Barrocal Algarvio", "C√£o de Serra de Aires",
            
            // Ra√ßas internacionais populares
            "Affenpinscher", "Airedale Terrier", "Akita", "Akita Americano", "Akita Japon√™s", "Alapaha Blue Blood Bulldog",
            "American Bully", "American Staffordshire Terrier", "Antigo C√£o de Pastor Ingl√™s", "Basenji",
            "Basset Hound", "Beagle", "Bearded Collie", "Beauceron", "Bedlington Terrier", "Bichon Fris√©",
            "Bloodhound", "Boerboel", "Boiadeiro Australiano", "Boiadeiro Bern√™s", "Border Collie", "Border Terrier",
            "Boston Terrier", "Boxer", "Braco Alem√£o", "Braco H√∫ngaro de Pelo Curto", "Braco Italiano", "Briard",
            "Brittany", "Buldogue Americano", "Buldogue Franc√™s", "Buldogue Ingl√™s", "Bull Terrier", "Bull Terrier Miniatura",
            "Bulldog Americano", "Bullmastiff", "Cairn Terrier", "Cane Corso", "C√£o Chin√™s de Crista", "C√£o de Montanha dos Piren√©us",
            "C√£o de Pastor Alem√£o", "C√£o de Pastor Australiano", "C√£o de Pastor Belga", "C√£o de Pastor Branco Su√≠√ßo",
            "C√£o de Pastor Catal√£o", "C√£o de Pastor de Beauce", "C√£o de Pastor de Brie", "C√£o de Pastor de Shetland",
            "C√£o de Santo Humberto", "C√£o d'√Ågua Espanhol", "C√£o d'√Ågua Portugu√™s", "C√£o Lobo Checoslovaco",
            "Cavalier King Charles Spaniel", "Chesapeake Bay Retriever", "Chihuahua", "Chin Japon√™s", "Chow Chow",
            "Cirneco do Etna", "Clumber Spaniel", "Cocker Spaniel Americano", "Cocker Spaniel Ingl√™s", "Collie",
            "Coonhound", "Corgi Gal√™s Cardigan", "Corgi Gal√™s Pembroke", "Curly-Coated Retriever", "Dachshund",
            "D√°lmata", "Dandie Dinmont Terrier", "Deerhound", "Dobermann", "Dogo Argentino", "Dogo Can√°rio",
            "Dogue Alem√£o", "Dogue de Bordeaux", "Dogue do Tibete", "Drever", "Elkhound Noruegu√™s", "√âpagneul Bret√£o",
            "Eurasier", "Fila Brasileiro", "Flat-Coated Retriever", "Fox Terrier", "Foxhound Americano", "Foxhound Ingl√™s",
            "Galgo Espanhol", "Galgo Italiano", "Galgo Persa", "Golden Retriever", "Grande Boiadeiro Su√≠√ßo",
            "Grande M√ºnsterl√§nder", "Greyhound", "Griffon Bruxelois", "Griffon de Pelo Duro", "Harrier", "Havanese",
            "Hokkaido", "Husky Siberiano", "Irish Terrier", "Jack Russell Terrier", "Keeshond", "Kelpie Australiano",
            "Kerry Blue Terrier", "King Charles Spaniel", "Komondor", "Kuvasz", "Labradoodle", "Labrador Retriever",
            "Lagotto Romagnolo", "Lakeland Terrier", "Lancashire Heeler", "Leonberger", "Lhasa Apso", "Lulu da Pomer√¢nia",
            "Malamute do Alasca", "Malt√™s", "Manchester Terrier", "Mastiff", "Mastim Espanhol", "Mastim Napolitano",
            "Mastim Tibetano", "Norwich Terrier", "Nova Scotia Duck Tolling Retriever", "Old English Sheepdog",
            "Otterhound", "Papillon", "Pastor Alem√£o", "Pastor Australiano", "Pastor Belga Malinois", 
            "Pastor Belga Tervuren", "Pastor Bergamasco", "Pastor Branco Su√≠√ßo", "Pastor C√°ucaso", 
            "Pastor da √Åsia Central", "Pastor de Beauce", "Pastor dos Pirin√©us", "Pequeno C√£o Le√£o", 
            "Pequin√™s", "Perdigueiro Portugu√™s", "Pharaoh Hound", "Pinscher Alem√£o", "Pinscher Miniatura",
            "Pit Bull Terrier Americano", "Podenco Ibicenco", "Podengo Portugu√™s", "Pointer Ingl√™s", "Poodle",
            "Poodle Miniatura", "Poodle Toy", "Pug", "Puli", "Pumi", "Racka", "Rottweiler", "Saluki",
            "Samoieda", "S√£o Bernardo", "Schipperke", "Schnauzer", "Schnauzer Gigante", "Schnauzer Miniatura",
            "Scottish Terrier", "Sealyham Terrier", "Setter Gordon", "Setter Ingl√™s", "Setter Irland√™s",
            "Shar Pei", "Shiba Inu", "Shih Tzu", "Skye Terrier", "Sloughi", "Spaniel Bret√£o", "Spaniel do Campo",
            "Spaniel dos Campos", "Spaniel Franc√™s", "Spaniel Japon√™s", "Spaniel Tibetano", "Spitz Alem√£o",
            "Spitz Finland√™s", "Spitz Japon√™s", "Springer Spaniel Ingl√™s", "Stabyhoun", "Staffordshire Bull Terrier",
            "Swedish Vallhund", "Teckel", "Terra Nova", "Terrier Brasileiro", "Terrier Checo", "Terrier Escoc√™s",
            "Terrier Irland√™s", "Terrier Japon√™s", "Terrier Norfolk", "Terrier Norwich", "Terrier Preto da R√∫ssia",
            "Terrier Tibetano", "Tosa Inu", "Vizsla", "Vulpino Italiano", "Weimaraner", "Welsh Springer Spaniel",
            "Welsh Terrier", "West Highland White Terrier", "Whippet", "Xoloitzcuintle", "Yorkshire Terrier",
            
            // C√£es de ra√ßa mista comuns
            "Labradoodle", "Goldendoodle", "Cockapoo", "Maltipoo", "Puggle", "Schnoodle", "Cavachon", "Pomsky", 
            "Cavapoo", "Chorkie", "Chiweenie", "Morkie", "Poochon", "Sheepadoodle", "Bernedoodle", "Aussiepoo",
            "C√£o de ra√ßa mista", "SRD (Sem Ra√ßa Definida)", "Rafeiro"
        ];

        function initMap(userLat, userLng) {
            // Define uma localiza√ß√£o padr√£o (Lisboa) caso n√£o haja localiza√ß√£o do usu√°rio
            const defaultLocation = { lat: 38.7223, lng: -9.1393 };
            const initialLocation = userLat && userLng ? 
                { lat: userLat, lng: userLng } : defaultLocation;
            
            // Garantir que o elemento do mapa existe no DOM
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('Elemento do mapa n√£o encontrado!');
                return;
            }
            
            // Configura√ß√£o do mapa
            try {
                map = new google.maps.Map(mapElement, {
                    center: initialLocation,
                    zoom: 13,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    mapTypeControl: true,
                    zoomControl: true,
                    streetViewControl: false,
                    fullscreenControl: false
            });

                // For√ßar o layout para garantir que o mapa seja renderizado corretamente
                google.maps.event.addListenerOnce(map, 'idle', function() {
                    google.maps.event.trigger(map, 'resize');
                    map.setCenter(initialLocation);
            });

                // Adicionar marcador na localiza√ß√£o inicial se tivermos coordenadas do usu√°rio
                if (userLat && userLng) {
                    if (marker) marker.setMap(null);
                    marker = new google.maps.Marker({
                        position: initialLocation,
                        map: map,
                        animation: google.maps.Animation.DROP
                    });
                    
                    // Preencher os campos ocultos com a localiza√ß√£o
                    document.getElementById('latitude').value = userLat;
                    document.getElementById('longitude').value = userLng;
                    
                    // Geocodificar para obter o endere√ßo
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ 'location': initialLocation }, function(results, status) {
                        if (status === google.maps.GeocoderStatus.OK && results[0]) {
                            document.getElementById('locationText').textContent = results[0].formatted_address;
                            document.querySelector('.location-info').style.border = '2px solid #2ecc71';
                        }
                    });
                }
                
                // Adicionar evento de clique no mapa
                map.addListener('click', function(e) {
                    const clickedLocation = e.latLng;
                
                    // Remover marcador anterior, se existir
                    if (marker) marker.setMap(null);
                    
                    // Adicionar novo marcador
                    marker = new google.maps.Marker({
                        position: clickedLocation,
                        map: map,
                        animation: google.maps.Animation.DROP
                    });
                    
                    // Geocodificar coordenadas para obter endere√ßo
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ 'location': clickedLocation }, function(results, status) {
                        if (status === google.maps.GeocoderStatus.OK && results[0]) {
                            // Guardar endere√ßo
                            const formattedAddress = results[0].formatted_address;
                            document.getElementById('locationText').textContent = formattedAddress;
                            
                            // Guardar coordenadas precisas
                            document.getElementById('latitude').value = clickedLocation.lat();
                            document.getElementById('longitude').value = clickedLocation.lng();
                            
                            lastValidLocation = {
                                lat: clickedLocation.lat(),
                                lng: clickedLocation.lng(),
                                address: formattedAddress
                            };
                            
                            // Atualizar campo de pesquisa
                            document.getElementById('locationSearch').value = formattedAddress;
                            
                            document.querySelector('.location-info').style.border = '2px solid #2ecc71';
                } else {
                            document.getElementById('locationText').textContent = `Localiza√ß√£o (${clickedLocation.lat().toFixed(6)}, ${clickedLocation.lng().toFixed(6)})`;
                            document.getElementById('latitude').value = clickedLocation.lat();
                            document.getElementById('longitude').value = clickedLocation.lng();
                            
                            lastValidLocation = {
                                lat: clickedLocation.lat(),
                                lng: clickedLocation.lng(),
                                address: `Localiza√ß√£o (${clickedLocation.lat().toFixed(6)}, ${clickedLocation.lng().toFixed(6)})`
                            };
                            
                            document.querySelector('.location-info').style.border = '2px solid #f39c12';
                        }
                    });
                });
                
                console.log('Mapa inicializado com sucesso');
            } catch (error) {
                console.error('Erro ao inicializar o mapa:', error);
                mapElement.innerHTML = '<div style="padding:30px;text-align:center;color:#e74c3c;">Erro ao carregar o mapa. Por favor, recarregue a p√°gina.</div>';
            }
        }

        // Configurar campo de pesquisa de localiza√ß√£o depois que o mapa estiver pronto
        function setupLocationSearch() {
            const locationInput = document.getElementById('locationSearch');
            if (locationInput) {
                locationInput.addEventListener('input', function() {
                    searchLocation(this.value);
                });
            }
        }
        
        // Fun√ß√£o para pesquisar localiza√ß√µes usando o Google Maps Geocoding
        // Recebe como par√¢metro o texto que o utilizador escreveu
        function searchLocation(query) {
            // Cancelar pesquisa anterior se ainda estiver a decorrer (evita pesquisas desnecess√°rias)
            if (searchTimeout) clearTimeout(searchTimeout);
            const suggestionsContainer = document.getElementById('locationSuggestions');
            
            // S√≥ pesquisar se o utilizador inseriu pelo menos 3 caracteres
            if (query.length < 3) {
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.style.display = 'none';
                return;
            }
                    
            // Aguardar 500ms antes de pesquisar para evitar muitas pesquisas enquanto o utilizador escreve
            searchTimeout = setTimeout(() => {
                // Usar o servi√ßo de geocodifica√ß√£o do Google Maps para converter texto em coordenadas
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ 'address': query }, function(results, status) {
                    // Se encontrou resultados v√°lidos
                    if (status === google.maps.GeocoderStatus.OK && results.length > 0) {
                        // Limpar sugest√µes anteriores
                        suggestionsContainer.innerHTML = '';
                        
                        // Mostrar apenas os primeiros 5 resultados para n√£o sobrecarregar a interface
                        results.slice(0, 5).forEach(result => {
                            // Criar elemento HTML para cada sugest√£o
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.innerHTML = result.formatted_address;
                            
                            // Quando o utilizador clica numa sugest√£o
                            div.addEventListener('click', function() {
                                // Preencher o campo de pesquisa com o endere√ßo selecionado
                                document.getElementById('locationSearch').value = result.formatted_address;
                            
                                // Mostrar o endere√ßo selecionado na interface do utilizador
                                document.getElementById('locationText').textContent = result.formatted_address;
                            
                                // Extrair e guardar as coordenadas para usar quando submeter o formul√°rio
                                const lat = result.geometry.location.lat();
                                const lng = result.geometry.location.lng();
                                document.getElementById('latitude').value = lat;
                                document.getElementById('longitude').value = lng;
                                
                                // Guardar a localiza√ß√£o v√°lida numa vari√°vel global para refer√™ncia futura
                                lastValidLocation = {
                                    lat: lat,
                                    lng: lng,
                                    address: result.formatted_address
                                };
                            
                                // Atualizar o mapa para mostrar a localiza√ß√£o selecionada
                                if (map) {
                                    map.setCenter(result.geometry.location); // Centrar mapa na localiza√ß√£o
                                    map.setZoom(16); // Fazer zoom para ver melhor a √°rea
                                    
                                    // Remover marcador anterior se existir
                                    if (marker) marker.setMap(null);
                                    // Criar novo marcador na localiza√ß√£o selecionada
                                    marker = new google.maps.Marker({
                                        position: result.geometry.location,
                                        map: map,
                                        title: result.formatted_address,
                                        animation: google.maps.Animation.DROP // Anima√ß√£o de queda
                                    });
                                }
                                
                                // Feedback visual: borda verde indica que a localiza√ß√£o foi selecionada com sucesso
                                document.querySelector('.location-info').style.border = '2px solid #2ecc71';
                            
                                // Esconder as sugest√µes ap√≥s selec√ß√£o
                                suggestionsContainer.style.display = 'none';
                            });
                            // Adicionar a sugest√£o ao contentor de sugest√µes
                            suggestionsContainer.appendChild(div);
                        });
                        
                        // Mostrar o contentor de sugest√µes
                        suggestionsContainer.style.display = 'block';
                    } else {
                        // Se n√£o encontrou resultados, mostrar mensagem informativa
                        suggestionsContainer.innerHTML = '<div class="suggestion-item">Nenhum resultado encontrado</div>';
                        suggestionsContainer.style.display = 'block';
                    }
                });
            }, 500);
        }

        // Fun√ß√£o para obter a localiza√ß√£o actual do utilizador usando GPS/Wi-Fi
        function useMyLocation() {
            // Verificar se o navegador suporta geolocaliza√ß√£o
            if (navigator.geolocation) {
                // Obter refer√™ncia do bot√£o e desactiv√°-lo durante o processo
                const locationButton = document.querySelector('.use-my-location');
                locationButton.disabled = true;
                locationButton.textContent = 'A obter localiza√ß√£o...';
                
                // Mostrar feedback visual ao utilizador de que est√° a processar
                document.getElementById('locationText').textContent = 'A obter a sua localiza√ß√£o...';
                document.querySelector('.location-info').style.border = '2px solid #3498db'; // Borda azul = a processar

                // Pedir a localiza√ß√£o actual do utilizador
                navigator.geolocation.getCurrentPosition(
                    // Fun√ß√£o executada quando consegue obter a localiza√ß√£o
                    (position) => {
                        // Extrair coordenadas da resposta
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Guardar as coordenadas imediatamente para garantir que temos uma localiza√ß√£o v√°lida
                        document.getElementById('latitude').value = lat;
                        document.getElementById('longitude').value = lng;
                        
                        // Converter coordenadas em endere√ßo leg√≠vel (geocodifica√ß√£o reversa)
                        const geocoder = new google.maps.Geocoder();
                        geocoder.geocode({ 
                            'location': { lat, lng },
                            'language': 'pt-PT' // For√ßar resultados em portugu√™s de Portugal
                        }, function(results, status) {
                            if (status === google.maps.GeocoderStatus.OK && results.length > 0) {
                                // Tentar encontrar o resultado mais detalhado com endere√ßo de rua
                                let bestResult = results[0]; // Por defeito, usar o primeiro resultado
                                
                                // Procurar um resultado que tenha informa√ß√£o de rua detalhada
                                for (let i = 0; i < results.length; i++) {
                                    const result = results[i];
                                    // Verificar se cont√©m componentes espec√≠ficos de endere√ßo de rua
                                    const hasStreetComponents = result.address_components.some(comp => 
                                        comp.types.includes('route') ||           // Nome da rua
                                        comp.types.includes('street_address') ||  // Endere√ßo completo
                                        comp.types.includes('premise') ||         // Edif√≠cio espec√≠fico
                                        comp.types.includes('subpremise')         // Apartamento/loja
                                    );
                                    
                                    if (hasStreetComponents) {
                                        bestResult = result;
                                        break; // Encontr√°mos um bom resultado, parar a procura
                                    }
                                }
                                
                                // Usar o melhor resultado dispon√≠vel
                                const formattedAddress = bestResult.formatted_address;
                                document.getElementById('locationSearch').value = formattedAddress;
                                document.getElementById('locationText').textContent = formattedAddress;
                                
                                // Atualizar o mapa para mostrar a localiza√ß√£o
                                map.setCenter({lat, lng});
                                map.setZoom(17); // Zoom pr√≥ximo para mostrar detalhes da rua
                                
                                // Remover marcador anterior e criar novo
                                if (marker) marker.setMap(null);
                                marker = new google.maps.Marker({
                                    position: {lat, lng},
                                    map: map,
                                    animation: google.maps.Animation.DROP // Anima√ß√£o de queda
                                });
                                
                                // Feedback visual positivo: borda verde = sucesso
                                document.querySelector('.location-info').style.border = '2px solid #2ecc71';
                                
                                console.log('Endere√ßo encontrado:', formattedAddress);
                            } else {
                                // Se n√£o conseguiu obter endere√ßo, usar apenas as coordenadas
                                console.error('Geocodifica√ß√£o falhou:', status);
                                const coords = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                                document.getElementById('locationText').textContent = `Localiza√ß√£o actual (${coords})`;
                                
                                // Atualizar mapa mesmo sem endere√ßo
                                map.setCenter({lat, lng});
                                
                                if (marker) marker.setMap(null);
                                marker = new google.maps.Marker({
                                    position: {lat, lng},
                                    map: map,
                                    animation: google.maps.Animation.DROP
                                });
                                
                                // Feedback visual neutro: borda laranja = parcialmente bem-sucedido
                                document.querySelector('.location-info').style.border = '2px solid #f39c12';
                            }
                            
                            // Restaurar o bot√£o ao estado normal
                            locationButton.disabled = false;
                            locationButton.innerHTML = '<i class="fas fa-location-arrow"></i> Usar a minha localiza√ß√£o atual';
                        });
                    },
                    // Fun√ß√£o executada quando h√° erro ao obter a localiza√ß√£o
                    (error) => {
                        console.error('Erro ao obter localiza√ß√£o:', error);
                        let errorMsg = 'N√£o foi poss√≠vel obter a sua localiza√ß√£o.';
                        
                        // Personalizar mensagem de erro baseada no tipo de erro
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMsg += ' Negou a permiss√£o de localiza√ß√£o.';
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMsg += ' Informa√ß√µes de localiza√ß√£o indispon√≠veis.';
                        } else if (error.code === error.TIMEOUT) {
                            errorMsg += ' O tempo para obter a localiza√ß√£o expirou.';
                        }
                        
                        console.error('Erro de geolocaliza√ß√£o:', error);
                        
                        // Mostrar mensagem de erro ao utilizador e sugerir alternativas
                        alert(errorMsg + ' Por favor, selecione manualmente no mapa ou use a pesquisa de morada.');
                        document.getElementById('locationText').textContent = 'Clique no mapa ou pesquise uma morada';
                        document.querySelector('.location-info').style.border = ''; // Remover borda colorida
                        
                        // Restaurar o bot√£o ao estado normal
                        locationButton.disabled = false;
                        locationButton.innerHTML = '<i class="fas fa-location-arrow"></i> Usar a minha localiza√ß√£o atual';
                    },
                    // Op√ß√µes para a geolocaliza√ß√£o
                    {
                        enableHighAccuracy: true, // Usar GPS se dispon√≠vel para maior precis√£o
                        timeout: 10000,           // Tempo limite de 10 segundos
                        maximumAge: 0             // N√£o aceitar localiza√ß√£o em cache, obter sempre nova
                    }
                );
            } else {
                // Se o navegador n√£o suporta geolocaliza√ß√£o
                alert('O seu navegador n√£o suporta geolocaliza√ß√£o.');
            }
        }

        function setupBreedSearch() {
            const breedInput = document.getElementById('breedSearch');
            const suggestionsContainer = document.getElementById('breedSuggestions');
            
            breedInput.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                
                // Clear previous timeout
                if (breedSearchTimeout) {
                    clearTimeout(breedSearchTimeout);
                }
                
                // Show suggestions if the query is at least 2 characters
                if (query.length >= 2) {
                    breedSearchTimeout = setTimeout(() => {
                        // Filter breeds that match the query
                        const matchedBreeds = commonBreeds.filter(breed => 
                            breed.toLowerCase().includes(query)
                        );
                        
                        // Display matched breeds
                        if (matchedBreeds.length > 0) {
                            suggestionsContainer.innerHTML = '';
                            matchedBreeds.forEach(breed => {
                                const div = document.createElement('div');
                                div.className = 'suggestion-item';
                                div.textContent = breed;
                                div.addEventListener('click', function() {
                                    breedInput.value = breed;
                                    suggestionsContainer.style.display = 'none';
                                });
                                suggestionsContainer.appendChild(div);
                            });
                            suggestionsContainer.style.display = 'block';
                        } else {
                            suggestionsContainer.innerHTML = '<div class="suggestion-item">Nenhuma ra√ßa encontrada</div>';
                            suggestionsContainer.style.display = 'block';
                        }
                    }, 200); // Shorter timeout as it's a local search
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (e.target !== breedInput && e.target !== suggestionsContainer) {
                    suggestionsContainer.style.display = 'none';
                }
            });
        }

        function previewImage(input) {
            const preview = document.getElementById('photoPreview');
            const photoUpload = document.querySelector('.photo-upload');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('A imagem deve ter no m√°ximo 5MB');
                    input.value = '';
                    return;
                }

                // Validate file type
                if (!file.type.match('image.*')) {
                    alert('Por favor, selecione apenas ficheiros de imagem');
                    input.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    photoUpload.classList.add('has-image');
                }
                
                reader.readAsDataURL(file);
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // SOLU√á√ÉO RADICAL: Verificar a tabela diretamente
                console.log("Verificando conex√£o com Supabase...");
                
                // Verificar se a tabela dogs existe e qual √© seu esquema
                const { data: tablesData, error: tablesError } = await window.supabase
                    .from('information_schema.tables')
                    .select('table_name')
                    .eq('table_schema', 'public');
                    
                if (tablesError) {
                    console.error("Erro ao verificar tabelas:", tablesError);
                } else {
                    console.log("Tabelas dispon√≠veis:", tablesData);
                    
                    // Verificar se a tabela dogs existe
                    const dogsTableExists = tablesData.some(t => t.table_name === 'dogs');
                    console.log("Tabela 'dogs' existe:", dogsTableExists);
                    
                    if (dogsTableExists) {
                        // Verificar o esquema da tabela dogs para ver as colunas reais
                        const { data: columnsData, error: columnsError } = await window.supabase
                            .from('information_schema.columns')
                            .select('column_name, data_type')
                            .eq('table_schema', 'public')
                            .eq('table_name', 'dogs');
                        
                        if (columnsError) {
                            console.error("Erro ao verificar colunas:", columnsError);
                        } else {
                            console.log("Colunas da tabela 'dogs':", columnsData);
                            
                            // Verificar se a coluna 'contato' existe
                                            const contatoExists = columnsData.some(c => c.column_name === 'contato');
                console.log("Coluna 'contato' existe:", contatoExists);
                            
                            // Verificar todas as varia√ß√µes poss√≠veis do campo de contato
                            const contactVariations = ['contact', 'telefone', 'phone', 'telefono', 'phone_number'];
                            contactVariations.forEach(variation => {
                                const exists = columnsData.some(c => c.column_name === variation);
                                console.log(`Coluna '${variation}' existe:`, exists);
                            });
                            
                            // Armazenar o nome correto da coluna para uso posterior
                                            if (contatoExists) {
                    window.contactColumnName = 'contato';
                            } else {
                                // Verificar se alguma varia√ß√£o existe
                                for (const variation of contactVariations) {
                                    if (columnsData.some(c => c.column_name === variation)) {
                                        window.contactColumnName = variation;
                                        break;
                                    }
                                }
                            }
                            
                            console.log("Nome da coluna de contato a ser usado:", window.contactColumnName || "N√£o encontrado");
                        }
                    }
                }
            } catch (e) {
                console.error("Erro ao verificar esquema:", e);
            }
            
            // Resto do c√≥digo de inicializa√ß√£o...
            // Configurar a pesquisa de ra√ßas
            setupBreedSearch();
            
            // Configurar a pesquisa de localiza√ß√£o
            setupLocationSearch();
            
            // Fun√ß√£o para verificar se o Google Maps j√° foi carregado
            function checkGoogleMapsLoaded() {
                if (window.google && window.google.maps) {
                    // Google Maps est√° carregado, inicializar o mapa
                    initializeMap();
                } else {
                    // Verificar novamente em 100ms
                    setTimeout(checkGoogleMapsLoaded, 100);
                }
            }
            
            // Iniciar verifica√ß√£o do carregamento do Google Maps
            checkGoogleMapsLoaded();
            
            // Fun√ß√£o para inicializar o mapa quando o Google Maps estiver carregado
            function initializeMap() {
                // Verificar se o elemento do mapa existe
                if (document.getElementById('map')) {
                    // Tentar obter a localiza√ß√£o do usu√°rio
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                initMap(position.coords.latitude, position.coords.longitude);
                            },
                            (error) => {
                                console.error('Erro ao obter localiza√ß√£o:', error);
                                initMap(); // Will use default Lisbon coordinates
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 5000,
                                maximumAge: 0
                            }
                        );
                    } else {
                        console.log('Geolocaliza√ß√£o n√£o suportada');
                        initMap(); // Will use default Lisbon coordinates
                    }
                } else {
                    console.error('Elemento do mapa n√£o encontrado no DOM');
                }
            }

            // Preencher automaticamente o campo de contato com o n√∫mero do usu√°rio
            const userPhone = localStorage.getItem('userPhone');
            if (userPhone) {
                const contactInput = document.getElementById('contact');
                if (contactInput) {
                    contactInput.value = userPhone;
                }
            } else {
                // Se n√£o houver telefone do utilizador, mostrar um alerta
                alert('Por favor, atualize o seu perfil com um n√∫mero de telefone para adicionar animais.');
                // Redirecionar para a p√°gina de conta
                window.location.href = 'home.html';
            }
        });

        // Fun√ß√£o para salvar no Supabase - adaptada para a estrutura real da tabela
        async function saveDog(dogData) {
            console.log("Tentando salvar com estrutura correta da tabela:", dogData);
            
            try {
                // Usar apenas os campos que realmente existem na tabela
                const { data, error } = await window.supabase
                    .from('dogs')
                    .insert([{
                        user_id: dogData.user_id,
                        nome: dogData.nome || null,
                        raca: dogData.raca || null,
                        idade: dogData.idade || null,
                        sexo: dogData.sexo || null,
                        porte: dogData.porte || null,
                        estado: dogData.estado,
                        descricao: dogData.descricao || null,
                        caracteristicas: dogData.caracteristicas || null,
                        castrado: dogData.castrado,
                        agressivo: dogData.agressivo || null,
                        endereco: dogData.endereco || null,
                        image: dogData.image,
                        location: dogData.location
                        // N√£o incluir contato pois n√£o existe na tabela
                        // created_at √© gerenciado automaticamente pelo banco de dados
                    }]);
                
                if (error) {
                    console.error("Erro ao salvar:", error);
                    throw error;
                }
                
                return data;
            } catch (error) {
                console.error("Erro completo:", error);
                throw error;
            }
        }

        // Event listener do formul√°rio
        document.getElementById('addDogForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Valida√ß√µes b√°sicas
            const requiredFields = ["estado", "idade", "sexo", "castrado", "agressivo", "porte"];
            let hasErrors = false;
            
            // Valida√ß√£o de contato - vamos manter para fins de UX, mas n√£o vamos salvar
            const contactInput = document.getElementById('contact');
            const contactError = document.getElementById('contactError');
            
            if (!contactInput.value.match(/^[2-9][0-9]{8}$/)) {
                contactError.style.display = 'block';
                contactInput.focus();
                hasErrors = true;
            } else {
                contactError.style.display = 'none';
            }
            
            // Validar outros campos obrigat√≥rios
            requiredFields.forEach(field => {
                const radioButtons = document.querySelectorAll(`input[name="${field}"]`);
                let isChecked = false;
                radioButtons.forEach(radio => {
                    if (radio.checked) isChecked = true;
                });
                
                if (!isChecked) {
                    const label = document.querySelector(`label.option-label[for="${field}"]`) || 
                                  document.querySelector(`.options-group:has(input[name="${field}"]) .option-label`);
                    
                    if (label) {
                        label.style.color = '#e74c3c';
                        setTimeout(() => {
                            label.style.color = '';
                        }, 3000);
                    }
                    hasErrors = true;
                }
            });
            
            // Validar localiza√ß√£o
            if (!document.getElementById('latitude').value || !document.getElementById('longitude').value) {
                document.querySelector('.location-info').style.border = '2px solid #e74c3c';
                document.getElementById('locationText').textContent = "Por favor, selecione uma localiza√ß√£o no mapa";
                hasErrors = true;
                
                setTimeout(() => {
                    document.querySelector('.location-info').style.border = '';
                }, 3000);
            }
            
            if (hasErrors) {
                return;
            }
            
            // Mostrar indicador de carregamento
            const saveButton = document.querySelector('.save-button');
            saveButton.disabled = true;
            saveButton.textContent = 'Salvando...';
            saveButton.style.backgroundColor = '#ccc';
            
            try {
                // Preparar dados b√°sicos
                const formData = new FormData(this);
                const imageFile = document.getElementById('photoInput').files[0];
                
                // Processar imagem
                let imageData = null;
                if (imageFile) {
                    const compressedImage = await compressImage(imageFile);
                    imageData = await blobToBase64(compressedImage);
                }
                
                // Obter ID do usu√°rio
                const userId = localStorage.getItem('currentUserId');
                if (!userId) {
                    throw new Error('Utilizador n√£o conectado');
                }
                
                // Obter n√∫mero de contato para usar como nome ou descri√ß√£o
                const contato = document.getElementById('contact').value;
                
                // Criar objeto de dados que corresponde EXATAMENTE √† tabela do banco de dados
                const dogData = {
                    user_id: userId,
                    // Usar o n√∫mero de contato como nome para fins de refer√™ncia
                    nome: "Animal adicionado por: " + contato,
                    raca: document.getElementById('breedSearch').value || null,
                    idade: formData.get('idade') || null,
                    sexo: formData.get('sexo') || null,
                    porte: formData.get('porte') || null,
                    estado: formData.get('estado'),
                    // Adicionar o contato na descri√ß√£o j√° que n√£o temos campo espec√≠fico
                    descricao: "Contato: " + contato,
                    caracteristicas: null,
                    castrado: formData.get('castrado') === 'yes',
                    agressivo: formData.get('agressivo') || null,
                    endereco: document.getElementById('locationText').textContent,
                    image: imageData,
                    location: {
                        lat: parseFloat(document.getElementById('latitude').value),
                        lng: parseFloat(document.getElementById('longitude').value)
                    }
                };
                
                console.log("Tentando salvar dados com estrutura correta:", dogData);
                
                // Usar a fun√ß√£o adaptada
                await saveDog(dogData);
                
                alert('Animal adicionado com sucesso!');
                window.location.href = 'home.html';
            } catch (error) {
                console.error('Erro ao adicionar animal:', error);
                
                let errorMsg = 'Erro ao adicionar animal: ';
                if (error.message) {
                    errorMsg += error.message;
                } else {
                    errorMsg += 'Erro desconhecido';
                }
                
                alert(errorMsg);
                
                // Restaurar bot√£o
                saveButton.disabled = false;
                saveButton.textContent = 'Adicionar Animal';
                saveButton.style.backgroundColor = '#FF7F50';
            }
        });

        // Fun√ß√£o para comprimir imagem
        async function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Redimensionar se a imagem for muito grande
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        
                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob(resolve, 'image/jpeg', 0.7);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Fun√ß√£o para converter Blob para Base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function() {
                    resolve(reader.result);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
    </script>
</body>
</html>