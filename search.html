<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doglist - Pesquisa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="lib/supabase.js"></script>
    <script>
        // Verifica se está logado
        if (!localStorage.getItem('loggedIn')) {
            window.location.href = 'index.html';
        }

        // Função para calcular a distância entre dois pontos usando a fórmula de Haversine
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em quilômetros
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distância em quilômetros
        }

        // Função para obter a localização atual do usuário
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => resolve({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        }),
                        error => {
                            console.error('Erro ao obter localização:', error);
                            reject(error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 0
                        }
                    );
                } else {
                    reject(new Error('Geolocalização não suportada'));
                }
            });
        }

        // Função para geocodificar o endereço usando a API Nominatim do OpenStreetMap
        async function geocodeAddress(address) {
            try {
                const query = encodeURIComponent(address + ', Portugal');
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                throw new Error('Localização não encontrada');
            } catch (error) {
                console.error('Erro na geocodificação:', error);
                throw new Error('Não foi possível encontrar a localização especificada');
            }
        }

        // Função para obter a localização (atual ou por endereço)
        async function getLocation() {
            const locationInput = document.getElementById('location').value.trim();
            
            if (locationInput) {
                return await geocodeAddress(locationInput);
            }
            
            return await getCurrentLocation();
        }

        // Função modificada para buscar cães via Supabase
        async function loadDogs(filters = {}) {
            const results = document.querySelector('.results');
            results.innerHTML = '<div class="no-results">Carregando...</div>';
            
            try {
                // Obter localização (atual ou por endereço)
                const userLocation = await getLocation();
                const radius = parseFloat(document.getElementById('radius').value) || 5;
                
                // Montar filtros para o Supabase
                // Note que alguns filtros podem não precisar de tradução
                const supabaseFilters = {};
                
                if (filters.estado) {
                    supabaseFilters.estado = filters.estado.toLowerCase();
                }
                
                if (filters.raca) {
                    // Supabase não suporta LIKE nativamente via API, então fazemos isso após o fetch
                }
                
                if (filters.idade && filters.idade !== 'unknown') {
                    supabaseFilters.idade = filters.idade;
                }
                
                if (filters.sexo && filters.sexo !== 'unknown') {
                    supabaseFilters.sexo = filters.sexo;
                }
                
                if (filters.castrado && filters.castrado !== 'unknown') {
                    supabaseFilters.castrado = filters.castrado;
                }
                
                if (filters.agressivo && filters.agressivo !== 'unknown') {
                    supabaseFilters.agressivo = filters.agressivo;
                }
                
                if (filters.porte) {
                    supabaseFilters.porte = filters.porte;
                }
                
                // Buscar cães do Supabase
                const result = await window.supabaseServices.getDogs(supabaseFilters);
                
                if (!result.success) {
                    throw new Error(result.error || 'Erro ao buscar animais');
                }
                
                // Filtrar por raça e distância no cliente
                let filteredDogs = result.dogs.filter(dog => {
                    let matches = true;
                    
                    // Filtrar por raça (contains) se necessário
                    if (filters.raca && dog.raca) {
                        matches = matches && dog.raca.toLowerCase().includes(filters.raca.toLowerCase());
                    }
                    
                    // Filtrar por distância se o cão tem coordenadas
                    if (dog.location && dog.location.lat && dog.location.lng) {
                        const distance = calculateDistance(
                            userLocation.lat,
                            userLocation.lng,
                            parseFloat(dog.location.lat),
                            parseFloat(dog.location.lng)
                        );
                        matches = matches && (distance <= radius);
                    }
                    
                    return matches;
                });
                
                if (filteredDogs.length === 0) {
                    results.innerHTML = '<div class="no-results">Nenhum cão encontrado com estes filtros</div>';
                    return;
                }
                
                // Adicionar a distância a cada resultado
                const dogsWithDistance = filteredDogs.map(dog => {
                    let distance = 'Distância não disponível';
                    if (dog.location && dog.location.lat && dog.location.lng) {
                        const dist = calculateDistance(
                            userLocation.lat,
                            userLocation.lng,
                            parseFloat(dog.location.lat),
                            parseFloat(dog.location.lng)
                        );
                        distance = `${dist.toFixed(1)} km`;
                    }
                    return { ...dog, distance };
                });
                
                // Ordenar por distância
                dogsWithDistance.sort((a, b) => {
                    if (!a.location || !b.location) return 0;
                    const distA = calculateDistance(
                        userLocation.lat,
                        userLocation.lng,
                        parseFloat(a.location.lat),
                        parseFloat(a.location.lng)
                    );
                    const distB = calculateDistance(
                        userLocation.lat,
                        userLocation.lng,
                        parseFloat(b.location.lat),
                        parseFloat(b.location.lng)
                    );
                    return distA - distB;
                });
                
                // Renderizar os resultados
                results.innerHTML = dogsWithDistance.map(dog => `
                    <div class="result-card">
                    <img src="${dog.image_url || dog.image || 'Images/DogList-Logo.png'}" alt="Cachorro" class="result-image">
                    <div class="result-info">
                            <div class="result-status ${dog.estado?.toLowerCase()}">${dog.estado || 'Status não definido'}</div>
                            <div class="result-location">
                                <i class="fas fa-map-marker-alt"></i> 
                                <span>Distância: ${dog.distance}</span>
                            </div>
                            <div class="result-address">
                                <i class="fas fa-location-dot"></i>
                                <span>Local: ${dog.location?.address || dog.local || 'Local não especificado'}</span>
                            </div>
                            <div class="result-breed">
                                <i class="fas fa-dog"></i>
                                <span>Raça: ${dog.raca || 'Raça não especificada'}</span>
                            </div>
                            <div class="result-contact">
                                <i class="fas fa-phone"></i>
                                <span>Contato: ${dog.contacto || 'Não disponível'}</span>
                            </div>
                            <button onclick="showDetails('${dog.id}')" class="see-more">Ver mais detalhes</button>
                        </div>
                </div>
            `).join('');
            } catch (error) {
                console.error('Erro ao carregar os cães:', error);
                results.innerHTML = `<div class="no-results">${error.message || 'Erro ao obter localização. Por favor, verifique o endereço inserido ou permita o acesso à localização.'}</div>`;
            }
        }

        function handleSearch() {
            const filters = {
                estado: document.getElementById('estado').value,
                raca: document.getElementById('raca').value,
                idade: document.getElementById('idade').value,
                sexo: document.getElementById('sexo').value,
                castrado: document.getElementById('castrado').value,
                agressivo: document.getElementById('agressivo').value,
                porte: document.getElementById('porte').value
            };
            loadDogs(filters);
        }

        function showDetails(id) {
            window.location.href = `animal-details.html?id=${id}`;
        }

        // Inicializar a busca ao carregar a página
        document.addEventListener('DOMContentLoaded', async function() {
            // Carregar raças do Supabase
            try {
                const result = await window.supabaseServices.getBreeds();
                if (result.success && Array.isArray(result.breeds)) {
                    commonBreeds = result.breeds;
                    console.log('Raças carregadas do Supabase:', commonBreeds.length);
                }
            } catch (error) {
                console.error('Erro ao carregar raças:', error);
            }
            
            // Mostrar todos os animais inicialmente
            loadDogs();
            
            // Configurar o campo de raça com autocomplete
            setupBreedSearch();
        });
        
        // Lista de raças comuns de cães em Portugal
        const commonBreeds = [
            // Raças portuguesas
            "Rafeiro Alentejano", "Cão da Serra da Estrela", "Cão de Água Português", "Podengo Português",
            "Castro Laboreiro", "Cão de Fila de São Miguel", "Barbado da Terceira", "Perdigueiro Português",
            "Cão de Gado Transmontano", "Cão do Barrocal Algarvio", "Cão de Serra de Aires",
            
            // Raças mais populares em Portugal
            "Bulldog Francês", "Labrador Retriever", "Golden Retriever", "Pastor Alemão",
            "Yorkshire Terrier", "Beagle", "Chihuahua", "Boxer", "Jack Russell Terrier",
            "Poodle", "Cocker Spaniel", "Dachshund", "Pug", "Cavalier King Charles Spaniel",
            "Shih Tzu", "Border Collie", "Schnauzer Miniatura", "Rottweiler", "Pinscher Miniatura",
            
            // Adicione mais raças conforme necessário
            "Cão de raça mista", "SRD (Sem Raça Definida)", "Rafeiro"
        ];
        
        function setupBreedSearch() {
            const racaInput = document.getElementById('raca');
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.id = 'racaSuggestions';
            suggestionsDiv.className = 'breed-suggestions';
            suggestionsDiv.style.position = 'absolute';
            suggestionsDiv.style.backgroundColor = 'white';
            suggestionsDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
            suggestionsDiv.style.borderRadius = '8px';
            suggestionsDiv.style.width = 'calc(100% - 30px)';
            suggestionsDiv.style.maxHeight = '200px';
            suggestionsDiv.style.overflowY = 'auto';
            suggestionsDiv.style.zIndex = '1000';
            suggestionsDiv.style.display = 'none';
            
            racaInput.parentNode.style.position = 'relative';
            racaInput.parentNode.appendChild(suggestionsDiv);
            
            let searchTimeout;
            
            racaInput.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                if (query.length >= 2) {
                    searchTimeout = setTimeout(() => {
                        const matches = commonBreeds.filter(breed => 
                            breed.toLowerCase().includes(query)
                        );
                        
                        if (matches.length > 0) {
                            suggestionsDiv.innerHTML = '';
                            matches.forEach(breed => {
                                const item = document.createElement('div');
                                item.className = 'suggestion-item';
                                item.style.padding = '10px 15px';
                                item.style.cursor = 'pointer';
                                item.style.transition = 'background-color 0.2s';
                                item.textContent = breed;
                                
                                item.addEventListener('mouseover', function() {
                                    this.style.backgroundColor = '#f0f0f0';
                                });
                                
                                item.addEventListener('mouseout', function() {
                                    this.style.backgroundColor = '';
                                });
                                
                                item.addEventListener('click', function() {
                                    racaInput.value = breed;
                                    suggestionsDiv.style.display = 'none';
                                    // Acionar a pesquisa
                                    handleSearch();
                                });
                                
                                suggestionsDiv.appendChild(item);
                            });
                            
                            // Adicionar opção "Outro"
                            const outroItem = document.createElement('div');
                            outroItem.className = 'suggestion-item outro-option';
                            outroItem.style.padding = '10px 15px';
                            outroItem.style.cursor = 'pointer';
                            outroItem.style.transition = 'background-color 0.2s';
                            outroItem.style.borderTop = '1px solid #eee';
                            outroItem.style.fontWeight = 'bold';
                            outroItem.style.color = '#FF7F50';
                            outroItem.textContent = "Outro - Escrever raça";
                            
                            outroItem.addEventListener('mouseover', function() {
                                this.style.backgroundColor = '#f0f0f0';
                            });
                            
                            outroItem.addEventListener('mouseout', function() {
                                this.style.backgroundColor = '';
                            });
                            
                            outroItem.addEventListener('click', function() {
                                racaInput.value = '';
                                racaInput.placeholder = "Digite a raça do cão";
                                racaInput.focus();
                                suggestionsDiv.style.display = 'none';
                            });
                            
                            suggestionsDiv.appendChild(outroItem);
                            suggestionsDiv.style.display = 'block';
                        } else {
                            suggestionsDiv.innerHTML = '<div class="suggestion-item" style="padding: 10px 15px;">Nenhuma raça encontrada</div>';
                            
                            // Adicionar opção "Outro" quando não há resultados
                            const outroItem = document.createElement('div');
                            outroItem.className = 'suggestion-item outro-option';
                            outroItem.style.padding = '10px 15px';
                            outroItem.style.cursor = 'pointer';
                            outroItem.style.transition = 'background-color 0.2s';
                            outroItem.style.borderTop = '1px solid #eee';
                            outroItem.style.fontWeight = 'bold';
                            outroItem.style.color = '#FF7F50';
                            outroItem.textContent = "Outro - Escrever raça";
                            
                            outroItem.addEventListener('mouseover', function() {
                                this.style.backgroundColor = '#f0f0f0';
                            });
                            
                            outroItem.addEventListener('mouseout', function() {
                                this.style.backgroundColor = '';
                            });
                            
                            outroItem.addEventListener('click', function() {
                                racaInput.value = '';
                                racaInput.placeholder = "Digite a raça do cão";
                                racaInput.focus();
                                suggestionsDiv.style.display = 'none';
                            });
                            
                            suggestionsDiv.appendChild(outroItem);
                            suggestionsDiv.style.display = 'block';
                        }
                    }, 200);
                } else {
                    suggestionsDiv.style.display = 'none';
                }
            });
            
            // Esconder sugestões ao clicar fora
            document.addEventListener('click', function(e) {
                if (e.target !== racaInput && e.target !== suggestionsDiv) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #FFE4D6;
            min-height: 100vh;
            font-family: 'Segoe UI', Arial, sans-serif;
            color: #333;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #FFE4D6 0%, #fff 100%);
        }

        .header {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            margin: 0 20px 20px 20px;
        }

        .back-button {
            font-size: 28px;
            text-decoration: none;
            color: #FF7F50;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background-color: #FFE4D6;
            transform: translateX(-3px);
        }

        .header h1 {
            font-size: 24px;
            color: #333;
            margin: 0;
        }

        .search-container {
            flex: 1;
            padding: 25px;
            background: white;
            border-radius: 20px;
            margin: 0 20px 20px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group select,
        .form-group input {
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }

        .form-group select:focus,
        .form-group input:focus {
            border-color: #FF7F50;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 127, 80, 0.1);
        }

        .form-group small {
            color: #666;
            font-size: 12px;
            margin-top: 4px;
        }

        .search-button {
            background-color: #FF7F50;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 127, 80, 0.2);
        }

        .search-button:hover {
            background-color: #FF6B3D;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 127, 80, 0.3);
        }

        .results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            padding: 20px;
        }

        .result-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid #eee;
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .result-image {
            width: 100%;
            height: 220px;
            object-fit: cover;
            object-position: center;
            border-bottom: 1px solid #eee;
            display: block;
        }

        .result-info {
            padding: 20px;
        }

        .result-status {
            display: inline-block;
            padding: 6px 12px;
            color: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-status.encontrado {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .result-status.procurado {
            background: linear-gradient(135deg, #f44336, #e53935);
        }

        .result-location, .result-address, .result-breed, .result-contact {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }

        .result-location i, .result-address i, .result-breed i, .result-contact i {
            color: #FF7F50;
            width: 20px;
            text-align: center;
        }

        .result-address {
            margin: 8px 0;
            line-height: 1.4;
        }

        .result-address span {
            flex: 1;
        }

        .result-breed {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .result-contact {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            padding: 8px 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .result-contact i {
            color: #FF7F50;
        }

        .see-more {
            background-color: #FF7F50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            width: 100%;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 127, 80, 0.2);
        }

        .see-more:hover {
            background-color: #FF6B3D;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 127, 80, 0.3);
        }

        .no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 20px;
            color: #666;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px dashed #eee;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="home.html" class="back-button">←</a>
            <h1>Pesquisar Cães</h1>
        </div>

        <div class="search-container">
            <form class="search-form" onsubmit="event.preventDefault(); handleSearch()">
                <div class="form-group">
                    <label for="estado">Estado</label>
                    <select id="estado" name="estado">
                        <option value="">Todos</option>
                        <option value="encontrado">Encontrado</option>
                        <option value="procurado">Procurado</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="location">Localização</label>
                    <input 
                        type="text" 
                        id="location" 
                        name="location" 
                        placeholder="Ex: Lisboa, Odivelas, Porto..."
                    >
                    <small style="color: #666; font-size: 12px;">Deixe em branco para usar sua localização atual</small>
                </div>

                <div class="form-group">
                    <label for="radius">Raio de Busca</label>
                    <select id="radius" name="radius">
                        <option value="5">5 km</option>
                        <option value="10">10 km</option>
                        <option value="20">20 km</option>
                        <option value="50">50 km</option>
                        <option value="100">100 km</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="raca">Raça</label>
                    <input type="text" id="raca" name="raca">
                </div>

                <div class="form-group">
                    <label for="idade">Idade</label>
                    <select id="idade" name="idade">
                        <option value="">Todos</option>
                        <option value="0-5">0-5 anos</option>
                        <option value="5-10">5-10 anos</option>
                        <option value="10+">+10 anos</option>
                        <option value="unknown">Não sei</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sexo">Sexo</label>
                    <select id="sexo" name="sexo">
                        <option value="">Todos</option>
                        <option value="male">Macho</option>
                        <option value="female">Fêmea</option>
                        <option value="unknown">Não sei</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="castrado">Castrado</label>
                    <select id="castrado" name="castrado">
                        <option value="">Todos</option>
                        <option value="yes">Sim</option>
                        <option value="no">Não</option>
                        <option value="unknown">Não sei</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="agressivo">Agressividade</label>
                    <select id="agressivo" name="agressivo">
                        <option value="">Todos</option>
                        <option value="none">Não é agressivo</option>
                        <option value="humans">Agressivo com pessoas</option>
                        <option value="animals">Agressivo com outros animais</option>
                        <option value="both">Agressivo com pessoas e animais</option>
                        <option value="unknown">Não sei</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="porte">Porte</label>
                    <select id="porte" name="porte">
                        <option value="">Todos</option>
                        <option value="small">Pequeno</option>
                        <option value="medium">Médio</option>
                        <option value="large">Grande</option>
                    </select>
                </div>

                <button type="submit" class="search-button">Pesquisar</button>
            </form>

            <div class="results"></div>
        </div>
    </div>
</body>
</html>