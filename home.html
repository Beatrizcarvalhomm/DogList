<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doglist - Mapa</title>
    <!-- Favicon em vários tamanhos para melhor suporte -->
    <link rel="icon" href="Images/DogList-Logo.png" type="image/png" sizes="32x32">
    <link rel="icon" href="Images/DogList-Logo.png" type="image/png" sizes="96x96">
    <link rel="icon" href="Images/DogList-Logo.png" type="image/png" sizes="192x192">
    <link rel="apple-touch-icon" href="Images/DogList-Logo.png">
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Inicializar o cliente Supabase corretamente
        const supabaseUrl = 'https://jwyzbfbzxbedjskumgli.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3eXpiZmJ6eGJlZGpza3VtZ2xpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3NjA4MDksImV4cCI6MjA2MzMzNjgwOX0.8GEehgGUF-9zv1WwneYZBs1K3VLEZtxB9v0R6An0GIc';
        
        // Inicializar o cliente Supabase de forma correta e explícita
        const { createClient } = supabase;
        window.supabase = createClient(supabaseUrl, supabaseKey);
    </script>

    <style>
        /* Reset geral e estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background-color: #FFE4D6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #FFE4D6;
            position: relative;
        }

        /* Mapa */
        #map {
            flex: 1;
            width: 100%;
            background: #f0f0f0;
            z-index: 1;
            height: calc(100vh - 80px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.7);
            overflow: hidden;
            position: relative;
        }

        /* Indicador de carregamento */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px 25px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        .loading-indicator i {
            color: #FF7F50;
            animation: spin 1s linear infinite;
            font-size: 22px;
        }
        
        .loading-indicator span {
            font-weight: 500;
            color: #333;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Botão de adicionar cão */
        .add-dog-btn {
            position: absolute;
            right: 60px;
            bottom: 160px;
            background: linear-gradient(135deg, #FF7F50, #FF6347);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 127, 80, 0.4);
            border: none;
            font-size: 20px;
            transition: all 0.3s ease;
            z-index: 1000;
            text-decoration: none;
        }
        
        .add-dog-btn:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 127, 80, 0.5);
        }
        
        .add-dog-btn:active {
            transform: scale(0.95);
        }

        /* Legenda do mapa */
        .map-legend {
            position: absolute;
            bottom: 120px;
            left: 20px;
            padding: 15px;
            border-radius: 15px;
            background-color: rgba(255, 255, 255, 0.92);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 230px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        /* Reduzir z-index da legenda quando popup está aberto */
        .map-legend.popup-open {
            z-index: 100 !important;
        }

        /* Garantir que InfoWindows ficam acima da legenda */
        .gm-style-iw-c {
            z-index: 2000 !important;
        }
        
        .gm-style-iw {
            z-index: 2000 !important;
        }
        
        .gm-style-iw-d {
            z-index: 2000 !important;
        }
        
        .gm-style-iw-tc {
            z-index: 2000 !important;
        }

        .map-legend:hover {
            background-color: rgba(255, 255, 255, 0.98);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        /* Media query para desktop - posiciona a legenda */
        @media (min-width: 992px) {
            .map-legend {
                bottom: 120px;
                left: 40px;
            }
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 15px;
            color: #333;
            padding: 8px 12px;
            transition: all 0.3s ease;
            border-radius: 8px;
            border-left: 3px solid transparent;
            background-color: transparent;
        }
        
        .legend-item.clickable {
            cursor: pointer;
        }
        
        .legend-item.clickable:hover {
            background-color: rgba(255, 228, 214, 0.7);
            transform: translateX(3px);
            border-left: 3px solid #FF7F50;
        }

        .legend-color {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            margin-right: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .legend-item.clickable:hover .legend-color {
            transform: scale(1.1);
        }

        .legend-text {
            font-weight: 500;
            font-size: 15px;
        }

        #legendVoceEstaAqui {
            cursor: pointer;
        }

        #legendVoceEstaAqui:hover {
            background-color: rgba(255, 127, 80, 0.1);
        }
        
        .refresh-location {
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            margin-top: 10px;
            padding-top: 8px;
        }

        /* Navegação */
        .navigation {
            position: fixed;
            bottom: 20px;
            padding: 15px;
            background-color: #FFFFFF;
            border-radius: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            margin: 0 20px 20px;
            width: calc(100% - 40px);
            border-radius: 30px;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .nav-item {
            color: #FF7F50;
            text-decoration: none;
            font-size: 26px;
            padding: 18px;
            border-radius: 22px;
            transition: all 0.3s ease;
            width: 75px;
            height: 75px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            position: relative;
            z-index: 10000;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .nav-item:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FF7F50, #FF6347);
            opacity: 0;
            border-radius: 22px;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .nav-item:hover:before, .nav-item:active:before {
            opacity: 0.15;
        }

        .nav-item:hover, .nav-item:active {
            color: #FF6347;
            background-color: #fff;
            box-shadow: 0 8px 20px rgba(255, 127, 80, 0.25);
            transform: translateY(-5px);
        }

        .nav-item.active {
            color: white;
            background: linear-gradient(135deg, #FF7F50, #FF6347);
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(255, 127, 80, 0.3);
        }

        .nav-item i {
            transition: all 0.3s ease;
        }

        .nav-item:hover i {
            color: #FF6347;
        }
        
        /* Estilos específicos para desktop */
        @media (min-width: 1024px) {
            #map {
                height: 100vh;
                margin: 0;
                width: 100%;
                border-radius: 0;
                border: none;
            }
            
            .map-legend {
                bottom: 120px;
                left: 40px;
                background-color: rgba(255, 255, 255, 0.92);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                padding: 12px;
                border-radius: 15px;
                min-width: 200px;
                border: 1px solid rgba(255, 255, 255, 0.8);
            }
            
            .map-legend:hover {
                background-color: rgba(255, 255, 255, 0.98);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            }
            
            .legend-item {
                display: flex;
                align-items: center;
                margin: 8px 0;
                font-size: 14px;
                color: #333;
                padding: 6px 10px;
                transition: all 0.3s ease;
                border-radius: 8px;
                border-left: 3px solid transparent;
            }
            
            .legend-item.clickable:hover {
                background-color: rgba(255, 228, 214, 0.7);
                transform: translateX(3px);
                border-left: 3px solid #FF7F50;
            }
            
            .legend-text {
                font-size: 14px;
                font-weight: 500;
            }
            
            .legend-color {
                width: 24px;
                height: 24px;
                margin-right: 12px;
            }
            
            .legend-item.clickable:hover .legend-color {
                transform: scale(1.1);
            }
            
            .navigation {
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                width: auto;
                min-width: 350px;
                max-width: 450px;
                padding: 12px 25px;
                justify-content: center;
                gap: 40px;
                background-color: rgba(255, 255, 255, 0.95);
                box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
                border-radius: 35px;
            }
            
            .nav-item {
                width: 65px;
                height: 65px;
                font-size: 24px;
                border-radius: 25px;
            }
            
            .add-dog-btn {
                right: 40px;
                bottom: 110px;
                width: 60px;
                height: 60px;
                font-size: 24px;
                box-shadow: 0 5px 20px rgba(255, 127, 80, 0.5);
            }
            
            .add-dog-btn:hover {
                transform: scale(1.08);
                box-shadow: 0 8px 30px rgba(255, 127, 80, 0.6);
            }
        }
        
        /* Ajustes para tablets */
        @media (min-width: 768px) and (max-width: 1023px) {
            #map {
                height: calc(100vh - 20px);
                margin: 10px;
                width: calc(100% - 20px);
                border-radius: 15px;
            }
            
            .map-legend {
                bottom: 120px;
                left: 25px;
                min-width: 230px;
                padding: 18px;
                backdrop-filter: blur(5px);
            }
            
            .navigation {
                width: auto;
                left: 50%;
                transform: translateX(-50%);
                max-width: 500px;
                bottom: 25px;
                padding: 12px 20px;
            }
            
            .nav-item {
                width: 70px;
                height: 70px;
            }
            
            .add-dog-btn {
                right: 30px;
                bottom: 130px;
                width: 55px;
                height: 55px;
            }
        }
        
        /* Ajustes para telas pequenas */
        @media (max-width: 767px) {
            #map {
                height: calc(100vh - 40px);
                margin: 0;
                width: 100%;
                border-radius: 0;
            }
            
            .map-legend {
                bottom: 120px;
                left: 15px;
                padding: 12px;
                min-width: 220px;
            }
            
            /* Garantir que InfoWindows ficam acima de tudo em mobile */
            .gm-style-iw-c {
                z-index: 9999 !important;
            }
            
            .gm-style-iw {
                z-index: 9999 !important;
            }
            
            .gm-style-iw-d {
                z-index: 9999 !important;
            }
            
            .gm-style-iw-tc {
                z-index: 9999 !important;
            }
            
            /* Tornar legenda mais transparente quando popup está aberto em mobile */
            .map-legend.popup-open {
                opacity: 0.3 !important;
                z-index: 50 !important;
            }
            
            .legend-item {
                margin: 8px 0;
                padding: 7px 10px;
                font-size: 15px;
            }
            
            .legend-color {
                width: 26px;
                height: 26px;
                margin-right: 12px;
            }
            
            .legend-text {
                font-size: 15px;
            }
            
            .navigation {
                padding: 12px;
                margin: 0 15px 15px;
                bottom: 15px;
            }
            
            .nav-item {
                width: 65px;
                height: 65px;
                font-size: 22px;
                padding: 15px;
            }
            
            .add-dog-btn {
                right: 20px;
                bottom: 120px;
                width: 50px;
                height: 50px;
                font-size: 18px;
            }
        }
        
        @media (max-width: 480px) {
            .map-legend {
                bottom: 110px;
                left: 12px;
                padding: 10px;
                min-width: 210px;
            }
            
            .legend-item {
                margin: 7px 0;
                font-size: 14px;
                padding: 6px 10px;
            }
            
            .legend-color {
                width: 24px;
                height: 24px;
                margin-right: 12px;
            }
            
            .legend-text {
                font-size: 14px;
            }
            
            .navigation {
                padding: 10px;
                margin: 0 10px 10px;
            }
            
            .nav-item {
                width: 55px;
                height: 55px;
                font-size: 20px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="map"></div>
        <div class="loading-indicator" id="loadingIndicator">
            <i class="fas fa-spinner"></i>
            <span>Carregando...</span>
        </div>

        <a href="add-dog.html" class="add-dog-btn">
            <i class="fas fa-plus"></i>
        </a>

        <div class="map-legend">
            <div class="legend-item clickable" id="legendVoceEstaAqui" onclick="centerMapOnUserLocation()">
                <div class="legend-color" style="background-color: #007bff;"></div>
                <span class="legend-text">Está aqui</span>
            </div>
            <div class="legend-item clickable" id="legendProcurados" onclick="showAnimalsOnly('procurado')">
                <div class="legend-color" style="background-color: #e74c3c;"></div>
                <span class="legend-text">Procurados</span>
            </div>
            <div class="legend-item clickable" id="legendEncontrados" onclick="showAnimalsOnly('encontrado')">
                <div class="legend-color" style="background-color: #27ae60;"></div>
                <span class="legend-text">Encontrados</span>
            </div>
            <div class="legend-item clickable" id="legendAbrigos" onclick="toggleSheltersVisibility()">
                <div class="legend-color" style="background-color: #ff9800;"></div>
                <span class="legend-text">Abrigos Temporários</span>
            </div>
            <div class="legend-item clickable refresh-location" onclick="refreshUserLocation()">
                <div class="legend-color" style="background-color: #ffffff; display: flex; justify-content: center; align-items: center;">
                    <i class="fas fa-sync-alt" style="color: #FF7F50;"></i>
                </div>
                <span class="legend-text">Atualizar localização</span>
            </div>
        </div>

        <nav class="navigation">
            <a href="search.html" class="nav-item"><i class="fas fa-search"></i></a>
            <a href="account.html" class="nav-item"><i class="fas fa-user"></i></a>
            <a href="clinics.html" class="nav-item"><i class="fas fa-hospital"></i></a>
        </nav>
    </div>

    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <script>
        // Verificar se o utilizador está autenticado (logado)
        // Se não estiver, redireciona para a página de login
        if (!localStorage.getItem('loggedIn')) {
            window.location.href = 'index.html';
        }
        
        // Declaração das variáveis globais que vão ser usadas em toda a aplicação
        let map; // Objecto do mapa do Google Maps
        let userMarker; // Marcador que mostra onde o utilizador está localizado
        let petMarkers = []; // Array que guarda todos os marcadores dos animais (cães)
        let shelterMarkers = []; // Array que guarda todos os marcadores dos abrigos temporários
        let infoWindow; // Janela de informação que aparece quando clicamos num marcador
        let geocoder; // Serviço do Google Maps para converter endereços em coordenadas
        let currentOpenInfoWindow = null; // Guarda referência da janela de informação que está aberta
        
        // Variáveis para controlar quais tipos de marcadores estão visíveis no mapa
        // Estas preferências são guardadas no localStorage para persistir entre sessões
        let procuradosVisible = localStorage.getItem('procuradosVisible') !== 'false'; // Animais procurados visíveis por defeito
        let encontradosVisible = localStorage.getItem('encontradosVisible') !== 'false'; // Animais encontrados visíveis por defeito
        let abrigosVisible = localStorage.getItem('abrigosVisible') !== 'false'; // Abrigos temporários visíveis por defeito
        
        // Mostrar no console o estado inicial das preferências de visibilidade
        console.log('Estado inicial carregado - Procurados:', procuradosVisible, 'Encontrados:', encontradosVisible, 'Abrigos:', abrigosVisible);
        
        // Função principal que inicializa o mapa do Google Maps
        function initMap() {
            try {
                console.log("Iniciando função initMap");
                // Mostrar o indicador de carregamento enquanto o mapa está a ser preparado
                document.getElementById('loadingIndicator').style.display = 'flex';
                
                // Verificar se o elemento HTML onde o mapa vai ser colocado existe na página
                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    console.error("Elemento 'map' não encontrado no DOM!");
                    return;
                }
                
                // Mostrar as dimensões do elemento do mapa no console para ajudar no debug
                console.log("Dimensões do mapa:", mapElement.offsetWidth, "x", mapElement.offsetHeight);
            
                // Criar o objecto do mapa do Google Maps com as configurações iniciais
                map = new google.maps.Map(mapElement, {
                    center: { lat: -23.550520, lng: -46.633308 }, // Coordenadas de São Paulo como centro inicial
                    zoom: 12, // Nível de zoom inicial (12 é um bom nível para ver uma cidade)
                    mapTypeId: google.maps.MapTypeId.ROADMAP, // Tipo de mapa (estrada/normal)
                    
                    // Controlo para mudar o tipo de mapa (estrada, satélite, etc.)
                    mapTypeControl: true,
                    mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.DROPDOWN_MENU, // Estilo dropdown
                        position: google.maps.ControlPosition.TOP_RIGHT // Posição no canto superior direito
                    },
                    
                    // Controlo para ver o mapa em ecrã completo
                    fullscreenControl: true,
                    fullscreenControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP
                    },
                    
                    // Controlo do Street View (vista de rua)
                    streetViewControl: true,
                    streetViewControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP
                    },
                    
                    // Controlos de zoom (+ e -)
                    zoomControl: true,
                    zoomControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP
                    }
                });
                
                // Verificar se o mapa foi criado com sucesso
                if (!map) {
                    console.error("Falha ao inicializar o mapa. O objeto do mapa é indefinido.");
                    return;
                }
                
                console.log("Mapa inicializado com sucesso!");
                
                // Criar uma janela de informação global que será reutilizada para todos os marcadores
                infoWindow = new google.maps.InfoWindow({
                    maxWidth: 300, // Largura máxima da janela
                    disableAutoPan: false // Permite que o mapa se mova automaticamente para mostrar a janela
                });
                
                // Carregar o tipo de mapa preferido pelo utilizador (guardado anteriormente)
                const savedMapType = localStorage.getItem('mapType') || 'roadmap'; // Por defeito usa 'roadmap'
                map.setMapTypeId(savedMapType);
                
                // Tentar obter a localização do utilizador que foi guardada anteriormente
                const savedLocation = getSavedLocation();
                if (savedLocation) {
                    console.log("Localização salva encontrada:", savedLocation);
                    // Centrar o mapa na localização guardada
                    map.setCenter(savedLocation);
                    
                    // Colocar um marcador a mostrar onde o utilizador está
                    addUserMarker(savedLocation);
                } else {
                    console.log("Nenhuma localização salva, tentando obter localização atual");
                    // Se não há localização guardada, pedir permissão para obter a localização actual
                    requestUserLocation();
                }
                
                // Evento que é executado quando o mapa termina de carregar completamente
                // 'idle' significa que o mapa parou de se mover e está pronto para uso
                google.maps.event.addListenerOnce(map, 'idle', function() {
                    console.log("Mapa carregado e pronto");
                    // Esconder o indicador de carregamento
                    document.getElementById('loadingIndicator').style.display = 'none';
                    
                    // Limpar dados de imagens que possam estar corrompidos no localStorage
                    cleanupCorruptedImages();
                    
                    // Carregar todos os animais e abrigos da base de dados e colocá-los no mapa
                    loadAllDogs(); // Carregar cães procurados e encontrados
                    loadTemporaryShelters(); // Carregar abrigos temporários
                    
                    // Aplicar as preferências de visibilidade que o utilizador tinha guardadas
                    // Usar setTimeout para garantir que os marcadores foram criados primeiro
                    setTimeout(() => {
                        applyVisibilityState();
                    }, 500);
                });
                
                console.log("Função initMap concluída com sucesso");
            } catch (error) {
                // Se algo correr mal, mostrar o erro e avisar o utilizador
                console.error("ERRO ao inicializar o mapa:", error);
                alert("Ocorreu um erro ao inicializar o mapa. Por favor, tente recarregar a página.");
            }
        }
        
        // Função para obter a localização do utilizador que foi guardada anteriormente
        function getSavedLocation() {
            // Tentar obter as coordenadas guardadas no localStorage
            const savedLat = localStorage.getItem('userLocationLat');
            const savedLng = localStorage.getItem('userLocationLng');
            
            // Se ambas as coordenadas existem, devolver um objecto com lat e lng
            if (savedLat && savedLng) {
                return {
                    lat: parseFloat(savedLat), // Converter string para número decimal
                    lng: parseFloat(savedLng)  // Converter string para número decimal
                };
            }
            
            // Se não há localização guardada, devolver null
            return null;
        }
        
        // Função para guardar a localização do utilizador no localStorage
        function saveUserLocation(location) {
            // Guardar latitude e longitude separadamente
            localStorage.setItem('userLocationLat', location.lat);
            localStorage.setItem('userLocationLng', location.lng);
        }
        
        // Função para adicionar um marcador que mostra onde o utilizador está localizado
        function addUserMarker(location) {
            // Se já existe um marcador do utilizador, removê-lo primeiro
            if (userMarker) {
                userMarker.setMap(null);
            }
            
            // Criar um novo marcador para mostrar a localização do utilizador
            userMarker = new google.maps.Marker({
                position: location, // Coordenadas onde colocar o marcador
                map: map, // Mapa onde colocar o marcador
                title: 'Está aqui', // Texto que aparece quando passamos o rato por cima
                icon: {
                    // Usar um círculo azul como ícone
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: '#4285F4', // Cor azul do Google
                    fillOpacity: 1, // Totalmente opaco
                    strokeWeight: 2, // Espessura da borda
                    strokeColor: '#FFFFFF', // Cor branca da borda
                    scale: 12 // Tamanho do círculo
                },
                zIndex: 1 // Valor baixo para que este marcador fique atrás dos outros
            });

            // Adicionar um evento para quando o utilizador clica no marcador da sua localização
            userMarker.addListener('click', () => {
                showLocationPopup(userMarker); // Mostrar popup a confirmar que é a localização do utilizador
            });

            return userMarker; // Devolver o marcador criado
        }
        
        // Função para adicionar marcadores de todos os animais (cães) no mapa
        function addPetMarkers() {
            // Primeiro, limpar todos os marcadores de animais que já estão no mapa
            clearPetMarkers();
            
            // Obter a lista de todos os cães guardada no localStorage
            const allDogs = JSON.parse(localStorage.getItem('allDogs') || '[]');
            console.log(`Carregando ${allDogs.length} cães:`, allDogs);
            
            // Se não há cães para mostrar, sair da função
            if (allDogs.length === 0) {
                console.log('Nenhum cão cadastrado para exibir no mapa');
                return;
            }
            
            // Para cada cão na lista, verificar se tem localização e criar um marcador
            allDogs.forEach((dog) => {
                // Só criar marcador se o cão tem coordenadas válidas
                if (dog.location && dog.location.lat && dog.location.lng) {
                    addDogMarker(dog); // Criar marcador individual para este cão
                }
            });
            
            // Também recarregar os abrigos temporários
            loadTemporaryShelters();
        }
        
        // Função para criar um marcador individual para um cão no mapa
        function addDogMarker(dog) {
            try {
                // Mostrar informações detalhadas no console para ajudar no debug
                console.log('Tentando adicionar marcador para:', dog);
                
                // Declarar variáveis para guardar as coordenadas do cão
                // Vamos tentar extrair lat/lng de diferentes formatos possíveis
                let lat, lng;
                
                // Tentar extrair coordenadas de diferentes formatos possíveis
                if (dog.location) {
                    // Verificar se location é um objecto (formato mais comum)
                    if (typeof dog.location === 'object') {
                        if (dog.location.lat !== undefined && dog.location.lng !== undefined) {
                            // Formato padrão: {lat: X, lng: Y}
                            lat = parseFloat(dog.location.lat);
                            lng = parseFloat(dog.location.lng);
                        } else if (dog.location.latitude !== undefined && dog.location.longitude !== undefined) {
                            // Formato alternativo: {latitude: X, longitude: Y}
                            lat = parseFloat(dog.location.latitude);
                            lng = parseFloat(dog.location.longitude);
                        }
                    } else if (typeof dog.location === 'string') {
                        // Se location é uma string, tentar converter para objecto JSON
                        try {
                            const locationObj = JSON.parse(dog.location);
                            lat = parseFloat(locationObj.lat || locationObj.latitude);
                            lng = parseFloat(locationObj.lng || locationObj.longitude);
                        } catch (e) {
                            console.error('Falha ao converter location string para objeto:', e);
                        }
                    }
                } else if (dog.lat !== undefined && dog.lng !== undefined) {
                    // Coordenadas guardadas directamente no objecto do cão
                    lat = parseFloat(dog.lat);
                    lng = parseFloat(dog.lng);
                } else if (dog.latitude !== undefined && dog.longitude !== undefined) {
                    // Formato alternativo guardado directamente no objecto do cão
                    lat = parseFloat(dog.latitude);
                    lng = parseFloat(dog.longitude);
                }
                
                // Verificar se conseguimos obter coordenadas válidas
                if (isNaN(lat) || isNaN(lng)) {
                    console.error('Coordenadas inválidas após tentativa de normalização:', {lat, lng, dog});
                    return null; // Sair da função se as coordenadas não são válidas
                }
                
                // Verificar se o animal está muito próximo da localização do utilizador
                // Se estiver, vamos afastar um pouco para evitar sobreposição de marcadores
                if (userMarker) {
                    const userPosition = userMarker.getPosition();
                    const userLat = userPosition.lat();
                    const userLng = userPosition.lng();
                    
                    // Calcular a distância entre o animal e o utilizador
                    const distance = calculateDistance(lat, lng, userLat, userLng);
                    
                    // Se a distância for muito pequena (menos de 5 metros), afastar o marcador
                    if (distance < 0.005) { // 0.005 km = 5 metros
                        console.log('Animal muito próximo da localização do usuário. Adicionando deslocamento.');
                        
                        // Criar um deslocamento aleatório de 20-30 metros
                        // Usar valores aleatórios para que vários marcadores não fiquem no mesmo sítio
                        const offsetLat = (Math.random() * 0.0003 + 0.0002) * (Math.random() > 0.5 ? 1 : -1);
                        const offsetLng = (Math.random() * 0.0003 + 0.0002) * (Math.random() > 0.5 ? 1 : -1);
                        
                        // Aplicar o deslocamento às coordenadas
                        lat += offsetLat;
                        lng += offsetLng;
                        
                        console.log(`Posição ajustada para ${lat}, ${lng}`);
                    }
                }
                
                console.log(`Criando marcador em ${lat}, ${lng} para ${dog.nome || dog.raca || 'Sem nome'}`);
                
                // Definir a cor do marcador baseada no estado do animal
                // Vermelho para procurados, verde para encontrados
                const statusColor = dog.estado === 'procurado' ? '#ff6b6b' : '#4ecdc4';
                const statusText = dog.estado === 'procurado' ? 'Procurado' : 'Encontrado';
                
                // Definir o ícone SVG baseado no estado do animal (não usado actualmente)
                const pawIconPath = dog.estado === 'procurado' ? 
                    'M12,4C7.58,4 4,7.58 4,12C4,16.42 7.58,20 12,20C16.42,20 20,16.42 20,12C20,7.58 16.42,4 12,4M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M10,17L5,12L6.41,10.59L10,14.17L17.59,6.58L19,8L10,17Z' : 
                    'M12,4C7.58,4 4,7.58 4,12C4,16.42 7.58,20 12,20C16.42,20 20,16.42 20,12C20,7.58 16.42,4 12,4M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M10,17L5,12L6.41,10.59L10,14.17L17.59,6.58L19,8L10,17Z';
                
                // Escolher a cor do marcador: vermelho para procurados, verde para encontrados
                const pawColor = dog.estado === 'procurado' ? '#ff0000' : '#00ff00';
                
                // Criar o ícone do marcador como um círculo colorido
                const svgMarker = {
                    path: google.maps.SymbolPath.CIRCLE, // Usar um círculo simples
                    fillColor: pawColor, // Cor de preenchimento
                    fillOpacity: 1, // Totalmente opaco
                    strokeWeight: 1, // Espessura da borda
                    strokeColor: '#ffffff', // Cor branca da borda
                    scale: 12 // Tamanho do círculo
                };
                
                // Verificar se este tipo de marcador deve estar visível
                // Baseado nas preferências do utilizador guardadas
                const shouldShowMarker = dog.estado === 'procurado' ? procuradosVisible : encontradosVisible;
                
                // Criar o marcador no mapa com todas as propriedades definidas
                const marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng }, // Coordenadas onde colocar o marcador
                    map: shouldShowMarker ? map : null, // Só mostrar se o tipo estiver visível
                    icon: svgMarker, // Usar o ícone circular que criámos
                    title: dog.nome || dog.raca || 'Cachorro sem nome', // Texto ao passar o rato
                    animation: google.maps.Animation.DROP, // Animação de queda quando aparece
                    zIndex: 2 // Valor alto para ficar à frente do marcador do utilizador
                });
                        
                // Guardar os dados do cão dentro do marcador para usar mais tarde
                // Isto permite filtrar e manipular marcadores por tipo
                marker.dogData = dog;
                        
                // Criar o conteúdo HTML da janela de informação (popup) que aparece ao clicar no marcador
                // Este HTML inclui toda a informação do animal e botões de acção
                const contentString = `
                    <div style="width: 220px; background: white; padding: 0; margin: 0; overflow: hidden; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.12); position: relative; border: 2px solid ${dog.estado === 'procurado' ? '#e74c3c' : '#27ae60'};">
                        <!-- Cabeçalho com o estado do animal (Procurado/Encontrado) -->
                        <div style="background: white; padding: 8px 0; text-align: center; margin: 0; border-radius: 12px 12px 0 0; position: relative;">
                            <span style="color: ${dog.estado === 'procurado' ? '#e74c3c' : '#27ae60'}; font-size: 12px; font-weight: 600; text-transform: uppercase;">
                                    ${dog.estado === 'procurado' ? 'Procurado' : 'Encontrado'}
                                </span>
                                                            <!-- Botão X para fechar o popup -->
                                <button onclick="closeCurrentInfoWindow()" onmouseover="this.style.background='rgba(0,0,0,0.1)'" onmouseout="this.style.background='none'" style="position: absolute; top: 5px; right: 8px; background: none !important; border: none !important; outline: none !important; box-shadow: none !important; color: #999; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; transition: background 0.2s; padding: 0; margin: 0;">
                                    ×
                                </button>
                            </div>
                        <!-- Container principal para todo o conteúdo do popup -->
                        <div style="background: white; margin: 0; padding: 0; border-radius: 0 0 12px 12px;">
                        
                        <!-- Secção da imagem do animal -->
                            ${dog.image ? 
                        // Se o animal tem foto, mostrar a imagem real
                        `<div style="text-align: center; margin: 0; padding: 10px 0 8px 0;">
                            <img src="${dog.image}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);" onerror="this.src='Images/dog-placeholder.jpg'">
                        </div>` : 
                        // Se não tem foto, mostrar um ícone de cão
                        `<div style="text-align: center; margin: 0; padding: 10px 0 8px 0;">
                            <div style="width: 100px; height: 100px; margin: 0 auto; background: #f0f0f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <i class="fas fa-dog" style="font-size: 30px; color: #999;"></i>
                            </div>
                        </div>`}
                        
                        <!-- Secção do nome e raça do animal -->
                        <div style="text-align: center; margin: 0; padding: 0 15px 10px 15px;">
                            <h3 style="margin: 0; font-size: 16px; color: #333; font-weight: 600;">
                                ${(() => {
                                    // Lógica para decidir que nome mostrar
                                    // Se o nome contém "Animal adicionado por", mostrar apenas a raça ou "Animal"
                                    if (dog.nome && dog.nome.includes('Animal adicionado por')) {
                                        return dog.raca || 'Animal';
                                    }
                                    // Caso contrário, mostrar o nome, raça, ou "Animal" por defeito
                                    return dog.nome || dog.raca || 'Animal';
                                })()}
                            </h3>
                            ${(() => {
                                // Mostrar a raça como subtítulo apenas se:
                                // - O nome não contém "Animal adicionado por"
                                // - Existe raça definida
                                // - O nome e raça são diferentes
                                if (dog.nome && !dog.nome.includes('Animal adicionado por') && dog.raca && dog.nome !== dog.raca) {
                                    return `<p style="margin: 3px 0 0 0; font-size: 13px; color: #666;">${dog.raca}</p>`;
                                }
                                return '';
                            })()}
                            </div>
                        
                        <!-- Secção da localização/endereço onde o animal foi visto -->
                        <div style="margin: 0 15px 12px 15px; padding: 8px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #ff7f50;">
                            <div style="display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-map-marker-alt" style="color: #ff7f50; margin-right: 6px; font-size: 12px;"></i>
                                <span style="font-size: 12px; color: #555; text-align: center;">${dog.endereco || 'Localização não especificada'}</span>
                            </div>
                        </div>
                        
                        <!-- Secção de contacto (só aparece se existir número de telefone) -->
                        ${dog.users && dog.users.phone ? `
                        <div style="margin: 0 15px 12px 15px; padding: 8px; background: #e8f5e8; border-radius: 8px; border-left: 3px solid #4CAF50;">
                            <div style="display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-user" style="color: #4CAF50; margin-right: 6px; font-size: 12px;"></i>
                                <span style="font-size: 12px; color: #555; text-align: center;">${dog.users.name || 'Contacto'}: ${dog.users.phone}</span>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Secção dos botões de acção -->
                        <div style="padding: 0 15px 15px; display: flex; flex-direction: column; gap: 8px;">
                            <!-- Botão para ver detalhes completos do animal -->
                            <button onclick="location.href='animal-details.html?id=${dog.id}'" style="background: #ff7f50; color: white; padding: 10px 0; border: none; border-radius: 20px; cursor: pointer; width: 100%; text-align: center; font-size: 13px; font-weight: 500;">
                                    <span style="display: inline-flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-info-circle" style="margin-right: 6px; font-size: 13px;"></i>Ver Detalhes
                                    </span>
                                </button>
                            <!-- Botão para abrir direcções no Google Maps -->
                            <button onclick="openDirections(${lat}, ${lng})" style="background: #4CAF50; color: white; padding: 10px 0; border: none; border-radius: 20px; cursor: pointer; width: 100%; text-align: center; font-size: 13px; font-weight: 500;">
                                <span style="display: inline-flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-route" style="margin-right: 6px; font-size: 13px;"></i>Como chegar
                                </span>
                            </button>
                            <!-- Botão para ligar (só aparece se existir número de telefone) -->
                            ${dog.users && dog.users.phone ? `
                            <button onclick="window.open('tel:${dog.users.phone}', '_self')" style="background: #2196F3; color: white; padding: 10px 0; border: none; border-radius: 20px; cursor: pointer; width: 100%; text-align: center; font-size: 13px; font-weight: 500;">
                                <span style="display: inline-flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-phone" style="margin-right: 6px; font-size: 13px;"></i>Ligar
                                </span>
                            </button>
                            ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                            
                // Usar configurações adicionais para evitar problemas com o InfoWindow
                const infoWindow = new google.maps.InfoWindow({
                    content: contentString,
                    maxWidth: 240,
                    pixelOffset: new google.maps.Size(0, -50),
                    disableAutoPan: false
                });
                
                // Adicionar evento para aplicar estilos após abrir
                google.maps.event.addListener(infoWindow, 'domready', function() {
                    styleInfoWindow();
                });
                
                // Adicionar evento para quando InfoWindow é fechado
                google.maps.event.addListener(infoWindow, 'closeclick', function() {
                    const legend = document.querySelector('.map-legend');
                    if (legend) {
                        legend.classList.remove('popup-open');
                    }
                    currentOpenInfoWindow = null;
                });
                
                // Armazenar o infoWindow no marcador para referência futura
                marker.infoWindow = infoWindow;
                
                // Adicionar o marcador ao array
                        petMarkers.push(marker);
                
                // Adicionar evento de clique para abrir o InfoWindow
                marker.addListener('click', function() {
                    // Fechar qualquer InfoWindow aberto
                    if (currentOpenInfoWindow) {
                        currentOpenInfoWindow.close();
                    }
                    
                    // Adicionar classe para reduzir z-index da legenda
                    const legend = document.querySelector('.map-legend');
                    if (legend) {
                        legend.classList.add('popup-open');
                    }
                    
                    // Centralizar o mapa no marcador clicado
                    const markerPosition = marker.getPosition();
                    
                    // Calcular offset para que o popup apareça centralizado na tela
                    // Mover o mapa para CIMA para que o popup apareça mais alto na tela
                    const offsetLat = 0.035; // Offset muito grande para CIMA para posicionar o popup bem no topo da tela
                    const centerPosition = {
                        lat: markerPosition.lat() + offsetLat,
                        lng: markerPosition.lng()
                    };
                    
                    // Centralizar o mapa com animação suave
                    map.panTo(centerPosition);
                    
                    // Aguardar um pouco para a animação de pan terminar antes de abrir o popup
                    setTimeout(() => {
                    // Abrir o novo InfoWindow
                    infoWindow.open(map, marker);
                    currentOpenInfoWindow = infoWindow;
                        
                        // Estilizar o InfoWindow após abertura
                        setTimeout(styleInfoWindow, 10);
                    }, 300);
                    
                    // Animar o marcador quando clicado
                    if (marker.getAnimation() !== null) {
                        marker.setAnimation(null);
                    } else {
                        marker.setAnimation(google.maps.Animation.BOUNCE);
                    setTimeout(() => {
                            marker.setAnimation(null);
                        }, 750);
                    }
                });
                
                console.log('Marcador criado com sucesso:', marker);
                
                return marker;
            } catch (error) {
                console.error('Erro ao criar marcador para o cão:', error);
                return null;
            }
        }
        
        function styleInfoWindow() {
            setTimeout(() => {
                try {
                    // Remover a seta do InfoWindow
                    const arrows = document.querySelectorAll('.gm-style-iw-t::after');
                    arrows.forEach(arrow => {
                        if (arrow) arrow.style.display = 'none';
                    });
                    
                    // Estilizar o container principal
                    const containers = document.querySelectorAll('.gm-style-iw-c');
                    containers.forEach(container => {
                        container.style.padding = '0 !important';
                        container.style.margin = '0 !important';
                        container.style.borderRadius = '12px !important';
                        container.style.overflow = 'hidden !important';
                        container.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.12) !important';
                    });
                    
                    // Estilizar os containers internos
                    const innerContainers = document.querySelectorAll('.gm-style-iw-d');
                    innerContainers.forEach(innerContainer => {
                        innerContainer.style.overflow = 'hidden !important';
                        innerContainer.style.padding = '0 !important';
                        innerContainer.style.margin = '0 !important';
                    });

                    // Estilizar o wrapper principal do InfoWindow
                    const wrappers = document.querySelectorAll('.gm-style-iw');
                    wrappers.forEach(wrapper => {
                        wrapper.style.padding = '0 !important';
                        wrapper.style.margin = '0 !important';
                    });

                    // Estilizar elementos específicos do Google Maps
                    const iwContainers = document.querySelectorAll('.gm-style-iw-tc');
                    iwContainers.forEach(container => {
                        container.style.padding = '0 !important';
                        container.style.margin = '0 !important';
                    });

                    // Estilizar o botão de fechar
                    const closeButtons = document.querySelectorAll('button.gm-ui-hover-effect');
                    closeButtons.forEach(button => {
                        button.style.top = '0px !important';
                        button.style.right = '0px !important';
                    });

                    // Adicionar CSS para eliminar todos os espaços e forçar posicionamento correto
                    const style = document.createElement('style');
                    style.textContent = `
                        .gm-style-iw-d::-webkit-scrollbar { display: none; }
                        .gm-style-iw { padding: 0 !important; margin: 0 !important; top: 0 !important; }
                        .gm-style-iw-c { padding: 0 !important; margin: 0 !important; top: 0 !important; }
                        .gm-style-iw-d { padding: 0 !important; margin: 0 !important; top: 0 !important; }
                        .gm-style-iw-tc { padding: 0 !important; margin: 0 !important; top: 0 !important; }
                        .gm-style-iw-t { padding: 0 !important; margin: 0 !important; top: 0 !important; }
                        .gm-ui-hover-effect { opacity: 1 !important; }
                        .gm-ui-hover-effect img { opacity: 1 !important; }
                        .gm-style-iw-chr { display: none !important; }
                    `;
                    document.head.appendChild(style);
                } catch (error) {
                    console.error('Erro ao estilizar InfoWindow:', error);
                }
            }, 50);
        }

        function clearPetMarkers() {
            // Limpar todos os marcadores existentes
            petMarkers.forEach(marker => marker.setMap(null));
            petMarkers = [];
        }

        function clearShelterMarkers() {
            // Limpar marcadores de abrigos existentes
            shelterMarkers.forEach(marker => marker.setMap(null));
            shelterMarkers = [];
        }
        
        // Função para carregar todos os cães do Supabase
        // Função para verificar e corrigir imagens dos abrigos
        function validateShelterImage(photoUrl) {
            if (!photoUrl) return null;
            
            // Se for base64 direto da base de dados
            if (photoUrl.startsWith('data:image/')) {
                return photoUrl;
            }
            
            // Se for uma URL local (compatibilidade com versões antigas)
            if (photoUrl.startsWith('local:')) {
                const imageKey = photoUrl.replace('local:', '');
                const base64Data = localStorage.getItem(imageKey);
                
                if (!base64Data) {
                    console.warn(`Imagem local não encontrada para chave: ${imageKey}`);
                    return null;
                }
                
                // Verificar se é um base64 válido
                if (!base64Data.startsWith('data:image/')) {
                    console.warn(`Dados base64 inválidos para chave: ${imageKey}`);
                    // Remover dados corrompidos
                    localStorage.removeItem(imageKey);
                    return null;
                }
                
                return base64Data;
            }
            
            // URL remota normal
            return photoUrl;
        }

        // Função para limpar imagens corrompidas do localStorage
        function cleanupCorruptedImages() {
            const keysToRemove = [];
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('shelter-image-')) {
                    const data = localStorage.getItem(key);
                    if (!data || !data.startsWith('data:image/')) {
                        keysToRemove.push(key);
                    }
                }
            }
            
            keysToRemove.forEach(key => {
                console.log(`Removendo imagem corrompida: ${key}`);
                localStorage.removeItem(key);
            });
            
            if (keysToRemove.length > 0) {
                console.log(`Limpeza concluída: ${keysToRemove.length} imagens corrompidas removidas`);
            }
        }

        // Função de debug para verificar estado das imagens dos abrigos
        function debugShelterImages() {
            console.log('=== DEBUG: Estado das imagens dos abrigos ===');
            
            // Verificar localStorage
            let localImages = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('shelter-image-')) {
                    const data = localStorage.getItem(key);
                    console.log(`Local: ${key} - ${data ? 'OK' : 'VAZIO'} - ${data ? data.substring(0, 50) + '...' : 'N/A'}`);
                    localImages++;
                }
            }
            
            console.log(`Total de imagens locais: ${localImages}`);
            console.log('=== FIM DEBUG ===');
        }

        async function loadAllDogs() {
            try {
                // Buscar todos os cães do banco de dados com informações do usuário
                const { data, error } = await window.supabase
                    .from('dogs')
                    .select('*, users(name, phone)');
                
                if (error) throw error;
                
                console.log(`Carregando ${data.length} cães:`, data);
                
                // Limpar marcadores existentes
                clearPetMarkers();
                
                // Adicionar os cães ao mapa
                data.forEach(dog => {
                    if (dog.location && dog.location.lat && dog.location.lng) {
                        addDogMarker(dog);
                    }
                });
                
                // Também carregar abrigos temporários
                loadTemporaryShelters();
            } catch (error) {
                console.error('Erro ao carregar cães:', error);
            }
        }
        
        // Função para carregar os abrigos temporários do Supabase
        async function loadTemporaryShelters() {
            try {
                // Buscar todos os abrigos do banco de dados
                const { data, error } = await window.supabase
                    .from('shelters')
                    .select('*, users(name, phone)');
                
                if (error) throw error;
                
                console.log(`Carregando ${data.length} abrigos temporários`);
                
                // Formatar dados para compatibilidade com a função existente
                const formattedShelters = data.map(shelter => {
                    console.log(`Abrigo ${shelter.id}: photoUrl = ${shelter.photo_url}`);
                    
                    return {
                    id: shelter.id,
                    userId: shelter.user_id,
                    userName: shelter.users ? shelter.users.name : 'Anônimo',
                    contacto: shelter.users ? shelter.users.phone : '',
                    endereco: shelter.endereco,
                    location: shelter.location,
                    photoUrl: shelter.photo_url,
                    aceita: {
                        porte: shelter.aceita_porte || [],
                        idade: shelter.aceita_idade || [],
                        sexo: shelter.aceita_sexo || [],
                        castrado: shelter.aceita_castrado || [],
                        agressivo: shelter.aceita_agressivo || []
                    }
                    };
                });
                
                // Adicionar abrigos ao mapa
                addShelterMarkers(formattedShelters);
                
                // Debug das imagens após carregamento
                setTimeout(() => debugShelterImages(), 1000);
            } catch (error) {
                console.error('Erro ao carregar abrigos:', error);
            }
        }
        
        function addShelterMarkers(shelters) {
            // Limpar marcadores de abrigos existentes
            clearShelterMarkers();
            
            shelters.forEach(shelter => {
                if (shelter.location && shelter.location.lat && shelter.location.lng) {
                    // Obter e converter coordenadas
                    let lat = parseFloat(shelter.location.lat);
                    let lng = parseFloat(shelter.location.lng);
                    
                    // Verificar se a localização do abrigo está muito próxima da localização do usuário
                    // e adicionar um pequeno deslocamento se necessário
                    if (userMarker) {
                        const userPosition = userMarker.getPosition();
                        const userLat = userPosition.lat();
                        const userLng = userPosition.lng();
                        
                        // Calcular a distância aproximada entre os pontos
                        const distance = calculateDistance(lat, lng, userLat, userLng);
                        
                        // Se estiver muito próximo (menos de 5 metros), adicionar um pequeno deslocamento
                        if (distance < 0.005) { // 0.005 km = 5 metros
                            console.log('Abrigo muito próximo da localização do usuário. Adicionando deslocamento.');
                            
                            // Adicionar um deslocamento maior (aprox. 20-30 metros)
                            // Usando valores aleatórios para que múltiplos marcadores não fiquem sobrepostos
                            const offsetLat = (Math.random() * 0.0003 + 0.0002) * (Math.random() > 0.5 ? 1 : -1);
                            const offsetLng = (Math.random() * 0.0003 + 0.0002) * (Math.random() > 0.5 ? 1 : -1);
                            
                            lat += offsetLat;
                            lng += offsetLng;
                            
                            console.log(`Posição do abrigo ajustada para ${lat}, ${lng}`);
                        }
                    }
                    
                    // Criar marcador de abrigo
                    const marker = new google.maps.Marker({
                        position: { 
                            lat: lat, 
                            lng: lng 
                        },
                        map: abrigosVisible ? map : null,
                        title: 'Abrigo Temporário',
                        animation: google.maps.Animation.DROP,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: '#ff9800',
                            fillOpacity: 0.9,
                            strokeColor: '#FFFFFF',
                            strokeWeight: 2,
                            scale: 12
                        },
                        zIndex: 2 // Valor maior para ficar acima do marcador do usuário
                    });
                    
                    // Criar conteúdo inicial simples para infoWindow (apenas morada e contato)
                    const basicContent = `
                        <div style="width: 220px; background-color: white; padding: 0; overflow: hidden; border-radius: 10px; position: relative;">
                            <div style="text-align: center; margin: 5px 0 15px 0; position: relative;">
                                <span style="display: inline-block; padding: 3px 12px; background-color: #ff9800; color: white; border-radius: 20px; font-size: 12px; font-weight: bold;">
                                    Abrigo Temporário
                                </span>
                                <!-- Botão de fechar -->
                                <button onclick="closeCurrentInfoWindow()" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'" style="position: absolute; top: -2px; right: 8px; background: none !important; border: none !important; outline: none !important; box-shadow: none !important; color: #ff9800; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; transition: background 0.2s; padding: 0; margin: 0;">
                                    ×
                                </button>
                            </div>
                            ${(() => {
                                const validImageUrl = validateShelterImage(shelter.photoUrl);
                                if (validImageUrl) {
                                    return `
                                <div style="text-align: center; margin-bottom: 15px;">
                                            <img src="${validImageUrl}" 
                                                 style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #ff9800; background-color: transparent;" 
                                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9InRyYW5zcGFyZW50IiBzdHJva2U9IiNjY2MiIHN0cm9rZS13aWR0aD0iMiIvPgo8c3ZnIHg9IjE1IiB5PSIxNSIgd2lkdGg9IjMwIiBoZWlnaHQ9IjMwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9IiNjY2MiPgo8cGF0aCBkPSJNMTIgMTJjMS42NTQgMCAzLTEuMzQ2IDMtM3MtMS4zNDYtMy0zLTMtMyAxLjM0Ni0zIDMgMS4zNDYgMyAzIDN6bTAgMmMtMiAwLTYgMS02IDN2MWgxMnYtMWMwLTItNC0zLTYtM3oiLz4KPHN2Zz4KPC9zdmc+'">
                                </div>
                                    `;
                                } else {
                                    return `
                                        <div style="text-align: center; margin-bottom: 15px;">
                                            <div style="width: 60px; height: 60px; border-radius: 50%; background-color: transparent; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                                                <i class="fas fa-user" style="color: #ccc; font-size: 24px;"></i>
                                            </div>
                                        </div>
                                    `;
                                }
                            })()}
                            <div style="margin: 0 0 8px; font-size: 14px; color: #333; text-align: center; padding: 0 15px;">
                                <div style="margin-bottom: 10px;">
                                    <i class="fas fa-user" style="color: #ff9800; margin-right: 5px;"></i>
                                    <span style="font-size: 13px;">${shelter.userName || 'Anônimo'}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <i class="fas fa-map-marker-alt" style="color: #ff9800; margin-right: 5px;"></i>
                                    <span style="font-size: 13px;">${shelter.endereco || 'Morada não especificada'}</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <i class="fas fa-phone" style="color: #ff9800; margin-right: 5px;"></i>
                                    <span style="font-size: 13px;">${shelter.contacto || 'Contato não disponível'}</span>
                                </div>
                            </div>
                            <div style="padding: 0 15px 15px;">
                                <a href="shelter-details.html?id=${shelter.id}" class="view-shelter-btn" style="background: #ff9800; color: white; padding: 10px 0; border: none; border-radius: 20px; cursor: pointer; width: 100%; text-align: center; font-size: 14px; display: block; text-decoration: none;">
                                    <span style="display: inline-flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-info-circle" style="margin-right: 5px;"></i>Ver Detalhes
                                    </span>
                                </a>
                            </div>
                        </div>
                    `;
            
                    // Criar infoWindow com conteúdo básico inicial
                    const infoWindow = new google.maps.InfoWindow({
                        content: basicContent,
                        maxWidth: 220,
                        pixelOffset: new google.maps.Size(0, -50)
                    });
                    
                    // Adicionar evento para quando InfoWindow é fechado
                    google.maps.event.addListener(infoWindow, 'closeclick', function() {
                        const legend = document.querySelector('.map-legend');
                        if (legend) {
                            legend.classList.remove('popup-open');
                        }
                        currentOpenInfoWindow = null;
                    });
                    
                    // Guardar referência ao marcador e ao infoWindow
                    marker.infoWindow = infoWindow;
                    marker.shelterData = shelter;
                    shelterMarkers.push(marker);
                    
                    // Adicionar evento de clique para mostrar infoWindow
                    marker.addListener('click', function() {
                        // Fechar qualquer infoWindow aberto
                        if (currentOpenInfoWindow) {
                            currentOpenInfoWindow.close();
                        }
                        
                        // Adicionar classe para reduzir z-index da legenda quando popup abre
                        const legend = document.querySelector('.map-legend');
                        if (legend) {
                            legend.classList.add('popup-open');
                        }
                        
                        // Centralizar o mapa no marcador clicado
                        const markerPosition = marker.getPosition();
                        
                        // Calcular offset para que o popup apareça centralizado na tela
                        const offsetLat = 0.035; // Offset muito grande para CIMA para posicionar o popup bem no topo da tela
                        const centerPosition = {
                            lat: markerPosition.lat() + offsetLat,
                            lng: markerPosition.lng()
                        };
                        
                        // Centralizar o mapa com animação suave
                        map.panTo(centerPosition);
                        
                        // Aguardar um pouco para a animação de pan terminar antes de abrir o popup
                        setTimeout(() => {
                        // Abrir novo infoWindow com informações básicas
                        infoWindow.setContent(basicContent);
                        infoWindow.open(map, marker);
                        currentOpenInfoWindow = infoWindow;
                        
                        // Aplicar estilos ao infoWindow
                        setTimeout(styleInfoWindow, 10);
                        }, 300);
                    });
                }
            });
        }
        
        // Função para criar conteúdo detalhado do abrigo
        function createShelterDetailedContent(shelter) {
            // Criar listas de características aceitas
            const porteList = createListItems(shelter.aceita.porte, {
                'small': 'Pequeno',
                'medium': 'Médio',
                'large': 'Grande'
            });
            
            const idadeList = createListItems(shelter.aceita.idade, {
                '0-5': '0-5 anos',
                '5-10': '5-10 anos',
                '10+': '+10 anos'
            });
            
            const sexoList = createListItems(shelter.aceita.sexo, {
                'male': 'Macho',
                'female': 'Fêmea'
            });
            
            const castradoList = createListItems(shelter.aceita.castrado, {
                'yes': 'Sim',
                'no': 'Não'
            });
            
            const agresivoList = createListItems(shelter.aceita.agressivo, {
                'none': 'Não agressivo',
                'humans': 'Agressivo com pessoas',
                'animals': 'Agressivo com animais',
                'both': 'Agressivo com pessoas e animais'
            });
            
            return `
                <div style="width: 280px; background-color: white; padding: 0; overflow: hidden; border-radius: 10px; position: relative;">
                    <div style="text-align: center; margin: 5px 0 15px 0; position: relative;">
                        <span style="display: inline-block; padding: 3px 12px; background-color: #ff9800; color: white; border-radius: 20px; font-size: 12px; font-weight: bold;">
                            Abrigo Temporário
                        </span>
                        <!-- Botão de fechar -->
                        <button onclick="closeCurrentInfoWindow()" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'" style="position: absolute; top: -2px; right: 8px; background: none !important; border: none !important; outline: none !important; box-shadow: none !important; color: #ff9800; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; transition: background 0.2s; padding: 0; margin: 0;">
                            ×
                        </button>
                    </div>
                    
                    <div style="margin: 0 0 15px; font-size: 14px; color: #333; text-align: left; padding: 0 15px;">
                        <div style="margin-bottom: 10px;">
                            <i class="fas fa-user" style="color: #ff9800; margin-right: 5px;"></i>
                            <span style="font-size: 13px;">${shelter.userName || 'Anônimo'}</span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <i class="fas fa-map-marker-alt" style="color: #ff9800; margin-right: 5px;"></i>
                            <span style="font-size: 13px;">${shelter.endereco || 'Morada não especificada'}</span>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <i class="fas fa-phone" style="color: #ff9800; margin-right: 5px;"></i>
                            <span style="font-size: 13px;">${shelter.contacto || 'Contato não disponível'}</span>
                        </div>
                    </div>
                    
                    <div style="background-color: #fafafa; padding: 15px; border-top: 1px solid #eee;">
                        <h4 style="font-size: 14px; margin-bottom: 15px; color: #333; text-align: center;">Animais que aceita</h4>
                        
                        <div style="margin-bottom: 10px;">
                            <h5 style="font-size: 13px; margin-bottom: 5px; color: #ff9800;">Porte:</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">${porteList}</div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <h5 style="font-size: 13px; margin-bottom: 5px; color: #ff9800;">Idade:</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">${idadeList}</div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <h5 style="font-size: 13px; margin-bottom: 5px; color: #ff9800;">Sexo:</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">${sexoList}</div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <h5 style="font-size: 13px; margin-bottom: 5px; color: #ff9800;">Castrado:</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">${castradoList}</div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <h5 style="font-size: 13px; margin-bottom: 5px; color: #ff9800;">Agressividade:</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">${agresivoList}</div>
                        </div>
                    </div>
                    
                    <div style="padding: 15px;">
                        <button onclick="backToBasicInfo('${shelter.id}')" style="background: #ff9800; color: white; padding: 10px 0; border: none; border-radius: 20px; cursor: pointer; width: 100%; text-align: center; font-size: 14px;">
                            <span style="display: inline-flex; align-items: center; justify-content: center;">
                                <i class="fas fa-arrow-left" style="margin-right: 5px;"></i>Voltar
                            </span>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Função auxiliar para criar lista de opções estilizadas
        function createListItems(itemsArray, labels) {
            if (!itemsArray || itemsArray.length === 0) {
                return '<span style="font-size: 12px; color: #999; font-style: italic;">Nenhuma opção selecionada</span>';
            }
            
            return itemsArray.map(item => {
                const label = labels[item] || item;
                return `<span style="font-size: 12px; background-color: #fff3e0; color: #ff9800; padding: 3px 8px; border-radius: 10px; border: 1px solid #ffe0b2;">${label}</span>`;
            }).join('');
        }
        
        // Função para voltar à visualização básica do abrigo
        function backToBasicInfo(shelterId) {
            const marker = shelterMarkers.find(m => m.shelterData.id === shelterId);
            if (marker && marker.infoWindow) {
                // Fechar infowindow atual
                marker.infoWindow.close();
                
                // Reabrir com informações básicas
                if (marker.shelterData) {
                    const basicContent = `
                        <div style="width: 220px; background-color: white; padding: 0; overflow: hidden; border-radius: 10px; position: relative;">
                            <div style="text-align: center; margin: 5px 0 15px 0; position: relative;">
                                <span style="display: inline-block; padding: 3px 12px; background-color: #ff9800; color: white; border-radius: 20px; font-size: 12px; font-weight: bold;">
                                    Abrigo Temporário
                                </span>
                                <!-- Botão de fechar -->
                                <button onclick="closeCurrentInfoWindow()" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='none'" style="position: absolute; top: -2px; right: 8px; background: none !important; border: none !important; outline: none !important; box-shadow: none !important; color: #ff9800; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; transition: background 0.2s; padding: 0; margin: 0;">
                                    ×
                                </button>
                            </div>
                            ${marker.shelterData.photoUrl ? `
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <img src="${marker.shelterData.photoUrl.startsWith('local:') ? localStorage.getItem(marker.shelterData.photoUrl.replace('local:', '')) : marker.shelterData.photoUrl}" 
                                         style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #ff9800;" 
                                         onerror="this.style.display='none'">
                                </div>
                            ` : ''}
                            <div style="margin: 0 0 8px; font-size: 14px; color: #333; text-align: center; padding: 0 15px;">
                                <div style="margin-bottom: 10px;">
                                    <i class="fas fa-user" style="color: #ff9800; margin-right: 5px;"></i>
                                    <span style="font-size: 13px;">${marker.shelterData.userName || 'Anônimo'}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <i class="fas fa-map-marker-alt" style="color: #ff9800; margin-right: 5px;"></i>
                                    <span style="font-size: 13px;">${marker.shelterData.endereco || 'Morada não especificada'}</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <i class="fas fa-phone" style="color: #ff9800; margin-right: 5px;"></i>
                                    <span style="font-size: 13px;">${marker.shelterData.contacto || 'Contato não disponível'}</span>
                                </div>
                            </div>
                            <div style="padding: 0 15px 15px;">
                                <a href="shelter-details.html?id=${shelterId}" class="view-shelter-btn" style="background: #ff9800; color: white; padding: 10px 0; border: none; border-radius: 20px; cursor: pointer; width: 100%; text-align: center; font-size: 14px; display: block; text-decoration: none;">
                                    <span style="display: inline-flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-info-circle" style="margin-right: 5px;"></i>Ver Detalhes
                                    </span>
                                </a>
                            </div>
                        </div>
                    `;
                    
                    marker.infoWindow.setContent(basicContent);
                    marker.infoWindow.open(map, marker);
                    
                    // Configurar evento para o botão "Ver Detalhes"
                    google.maps.event.addListenerOnce(marker.infoWindow, 'domready', function() {
                        document.getElementById(`viewShelterDetails-${shelterId}`).addEventListener('click', function() {
                            // Atualizar para conteúdo detalhado
                            const detailedContent = createShelterDetailedContent(marker.shelterData);
                            marker.infoWindow.setContent(detailedContent);
                            styleInfoWindow();
                        });
                    });
                    
                    // Aplicar estilos
                    setTimeout(styleInfoWindow, 10);
                }
            }
        }
        
        // Função auxiliar para alternar visibilidade de animais por tipo
        // Esta função é chamada quando o utilizador clica nos itens da legenda
        function showAnimalsOnly(animalType) {
            if (animalType === 'procurado') {
                toggleProcurados(); // Alternar visibilidade dos animais procurados
            } else if (animalType === 'encontrado') {
                toggleEncontrados(); // Alternar visibilidade dos animais encontrados
            }
        }
        
        // Função para mostrar/esconder marcadores de animais procurados
        function toggleProcurados() {
            // Inverter o estado actual (se estava visível fica invisível e vice-versa)
            procuradosVisible = !procuradosVisible;
            // Guardar a nova preferência no localStorage para a próxima sessão
            localStorage.setItem('procuradosVisible', procuradosVisible);
            
            // Percorrer todos os marcadores de animais e mostrar/esconder os procurados
            petMarkers.forEach(marker => {
                if (marker.dogData && marker.dogData.estado === 'procurado') {
                    // Se deve estar visível, colocar no mapa; senão, remover do mapa
                    marker.setMap(procuradosVisible ? map : null);
                }
            });
            
            // Actualizar a aparência visual da legenda para reflectir o estado
            updateLegendAppearance();
            
            // Efeito visual temporário para mostrar que algo mudou
            const legendProcurados = document.getElementById('legendProcurados');
            legendProcurados.style.backgroundColor = 'rgba(255, 127, 80, 0.1)';
            setTimeout(() => {
                legendProcurados.style.backgroundColor = '';
            }, 300);
        }
        
        // Função para alternar visibilidade dos encontrados
        function toggleEncontrados() {
            encontradosVisible = !encontradosVisible;
            localStorage.setItem('encontradosVisible', encontradosVisible);
            
            // Atualizar marcadores
            petMarkers.forEach(marker => {
                if (marker.dogData && marker.dogData.estado === 'encontrado') {
                    marker.setMap(encontradosVisible ? map : null);
                }
            });
            
            // Atualizar aparência da legenda
            updateLegendAppearance();
            
            // Efeito visual
            const legendEncontrados = document.getElementById('legendEncontrados');
            legendEncontrados.style.backgroundColor = 'rgba(255, 127, 80, 0.1)';
            setTimeout(() => {
                legendEncontrados.style.backgroundColor = '';
            }, 300);
        }

        // Função para aplicar o estado de visibilidade salvo
        function applyVisibilityState() {
            // Aplicar visibilidade dos procurados
            petMarkers.forEach(marker => {
                if (marker.dogData && marker.dogData.estado === 'procurado') {
                    marker.setMap(procuradosVisible ? map : null);
                }
            });
            
            // Aplicar visibilidade dos encontrados
            petMarkers.forEach(marker => {
                if (marker.dogData && marker.dogData.estado === 'encontrado') {
                    marker.setMap(encontradosVisible ? map : null);
                }
            });
            
            // Aplicar visibilidade dos abrigos
            shelterMarkers.forEach(marker => {
                marker.setMap(abrigosVisible ? map : null);
            });
            
            // Atualizar aparência da legenda
            updateLegendAppearance();
            
            console.log('Estado aplicado - Procurados:', procuradosVisible, 'Encontrados:', encontradosVisible, 'Abrigos:', abrigosVisible);
        }
        
        // Função para atualizar aparência da legenda
        function updateLegendAppearance() {
            const legendProcurados = document.getElementById('legendProcurados');
            const legendEncontrados = document.getElementById('legendEncontrados');
            const legendAbrigos = document.getElementById('legendAbrigos');
            
            // Atualizar procurados
            if (procuradosVisible) {
                legendProcurados.style.opacity = '1';
                legendProcurados.querySelector('.legend-color').style.opacity = '1';
            } else {
                legendProcurados.style.opacity = '0.5';
                legendProcurados.querySelector('.legend-color').style.opacity = '0.3';
            }
            
            // Atualizar encontrados
            if (encontradosVisible) {
                legendEncontrados.style.opacity = '1';
                legendEncontrados.querySelector('.legend-color').style.opacity = '1';
            } else {
                legendEncontrados.style.opacity = '0.5';
                legendEncontrados.querySelector('.legend-color').style.opacity = '0.3';
            }
            
            // Atualizar abrigos
            if (abrigosVisible) {
                legendAbrigos.style.opacity = '1';
                legendAbrigos.querySelector('.legend-color').style.opacity = '1';
            } else {
                legendAbrigos.style.opacity = '0.5';
                legendAbrigos.querySelector('.legend-color').style.opacity = '0.3';
            }
        }
        
        // Função para alternar a visibilidade dos abrigos temporários
        function toggleSheltersVisibility() {
            abrigosVisible = !abrigosVisible;
            localStorage.setItem('abrigosVisible', abrigosVisible);
            
            // Atualizar marcadores
            shelterMarkers.forEach(marker => {
                marker.setMap(abrigosVisible ? map : null);
            });
            
            // Atualizar aparência da legenda
            updateLegendAppearance();
            
            // Efeito visual de feedback
            const legendAbrigos = document.getElementById('legendAbrigos');
            legendAbrigos.style.backgroundColor = 'rgba(255, 152, 0, 0.1)';
            setTimeout(() => {
                legendAbrigos.style.backgroundColor = '';
            }, 300);
        }

        // Função chamada quando o utilizador clica em "Está aqui" na legenda
        // Centra o mapa na localização do utilizador
        function centerMapOnUserLocation() {
            // Tentar obter a localização guardada anteriormente
            const savedLocation = getSavedLocation();
            
            if (savedLocation) {
                // Se temos localização guardada, centrar o mapa nela
                map.setCenter(savedLocation);
                
                // Verificar se já existe um marcador do utilizador
                if (!userMarker) {
                    // Se não existe, criar um novo
                    addUserMarker(savedLocation);
                } else {
                    // Se já existe, fazer uma animação para chamar atenção
                    userMarker.setAnimation(google.maps.Animation.BOUNCE);
                    setTimeout(() => {
                        userMarker.setAnimation(null); // Parar a animação após 1.4 segundos
                    }, 1400);
                }
                
                // Fazer zoom mais próximo para mostrar melhor a localização
                map.setZoom(18);
                
                // Mostrar um popup a confirmar que esta é a localização do utilizador
                showLocationPopup(userMarker);
            } else {
                // Se não há localização guardada, pedir permissão para obter a localização actual
                requestUserLocation();
            }
        }

        // Função para pedir permissão e obter a localização actual do utilizador
        function requestUserLocation() {
            // Verificar se o navegador suporta geolocalização
            if (navigator.geolocation) {
                // Pedir a localização actual do utilizador
                navigator.geolocation.getCurrentPosition(
                    // Função executada se conseguir obter a localização
                    (position) => {
                        // Extrair as coordenadas da resposta
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Guardar a localização para usar nas próximas vezes
                        saveUserLocation(userLocation);
                        
                        // Centrar o mapa na localização do utilizador
                        map.setCenter(userLocation);
                        map.setZoom(15); // Zoom adequado para ver a área envolvente
                        
                        // Criar um marcador para mostrar onde o utilizador está
                        addUserMarker(userLocation);
                    },
                    // Função executada se houver erro ao obter a localização
                    (error) => {
                        console.error('Não foi possível obter a sua localização. Verifique as permissões do seu navegador.', error);
                    },
                    // Opções para a geolocalização
                    { 
                        timeout: 10000,      // Tempo limite de 10 segundos
                        maximumAge: 600000   // Aceitar localização até 10 minutos antiga
                    }
                );
            } else {
                // Se o navegador não suporta geolocalização, avisar o utilizador
                alert('O seu navegador não suporta geolocalização.');
            }
        }
        
        function refreshUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const newLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Salvar localização para uso futuro
                        saveUserLocation(newLocation);
                        
                        // Centralizar mapa na nova localização
                        map.setCenter(newLocation);
                        map.setZoom(16);

                        // Adicionar marcador do usuário na nova localização
                        addUserMarker(newLocation);
                        
                        alert('Localização actualizada com sucesso!');
                    },
                    (error) => {
                        console.error('Erro ao actualizar localização:', error);
                        alert('Não foi possível actualizar a sua localização. Verifique as permissões do seu navegador.');
                    },
                    { timeout: 10000, maximumAge: 600000 }
                );
            } else {
                alert('O seu navegador não suporta geolocalização.');
            }
        }

        function showLocationPopup(marker) {
            // Fechar qualquer infowindow aberta anteriormente
            if (infoWindow) {
                infoWindow.close();
            }
            
            // Abordagem simples e confiável
            const tempPopup = document.createElement('div');
            tempPopup.style.cssText = `
                position: fixed;
                top: 45%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: white;
                padding: 10px 15px;
                border-radius: 20px;
                border: 2px solid rgba(0, 123, 255, 0.5);
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                display: flex;
                align-items: center;
                font-family: Arial, sans-serif;
                font-size: 13px;
                font-weight: 600;
                color: #333;
            `;
            
            tempPopup.innerHTML = `
                <i class="fas fa-location-arrow" style="color: #007bff; margin-right: 8px;"></i>
                Está aqui
            `;
            
            document.body.appendChild(tempPopup);
            
            // Remover após 3 segundos
            setTimeout(() => {
                if (document.body.contains(tempPopup)) {
                    document.body.removeChild(tempPopup);
                }
            }, 3000);
        }
        
        // Adicionar evento de clique em cada item da legenda
        document.addEventListener('DOMContentLoaded', function() {
            // Itens da legenda
            const legendItems = document.querySelectorAll('.legend-item');
            
            legendItems.forEach(item => {
                item.addEventListener('click', function() {
                    setTimeout(() => {
                        this.blur();
                    }, 100);
                });
            });
        });

        // Adicionar a função para calcular a distância entre dois pontos usando a fórmula de Haversine
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c; // Distância em km
            return distance;
        }

        // Função para fechar o InfoWindow atual
        function closeCurrentInfoWindow() {
            if (currentOpenInfoWindow) {
                currentOpenInfoWindow.close();
                currentOpenInfoWindow = null;
            }
            
            // Remover classe da legenda quando popup é fechado
            const legend = document.querySelector('.map-legend');
            if (legend) {
                legend.classList.remove('popup-open');
            }
        }

        // Função para abrir direcções no Google Maps quando o utilizador clica em "Como chegar"
        // Tenta usar a localização do utilizador como ponto de partida
        function openDirections(destinationLat, destinationLng) {
            // Primeiro, tentar usar a localização guardada do utilizador
            const savedLocation = getSavedLocation();
            
            if (savedLocation) {
                // Se temos localização guardada, usá-la como ponto de partida
                const directionsUrl = `https://www.google.com/maps/dir/?api=1&origin=${savedLocation.lat},${savedLocation.lng}&destination=${destinationLat},${destinationLng}&travelmode=driving`;
                window.open(directionsUrl, '_blank'); // Abrir numa nova aba
            } else if (userMarker) {
                // Se não há localização guardada mas existe marcador do utilizador, usar essa posição
                const userPosition = userMarker.getPosition();
                const directionsUrl = `https://www.google.com/maps/dir/?api=1&origin=${userPosition.lat()},${userPosition.lng()}&destination=${destinationLat},${destinationLng}&travelmode=driving`;
                window.open(directionsUrl, '_blank');
            } else {
                // Como último recurso, tentar obter a localização actual
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        // Se conseguir obter a localização, usar como ponto de partida
                        (position) => {
                            const directionsUrl = `https://www.google.com/maps/dir/?api=1&origin=${position.coords.latitude},${position.coords.longitude}&destination=${destinationLat},${destinationLng}&travelmode=driving`;
                            window.open(directionsUrl, '_blank');
                        },
                        // Se não conseguir obter localização, mostrar apenas o destino
                        (error) => {
                            console.error('Erro ao obter localização:', error);
                            // Abrir apenas o destino no Google Maps
                            const directionsUrl = `https://www.google.com/maps/search/${destinationLat},${destinationLng}`;
                            window.open(directionsUrl, '_blank');
                        }
                    );
                } else {
                    // Se o navegador não suporta geolocalização, mostrar apenas o destino
                    const directionsUrl = `https://www.google.com/maps/search/${destinationLat},${destinationLng}`;
                    window.open(directionsUrl, '_blank');
                }
            }
        }
    </script>
    
    <!-- Carregue o script do Google Maps depois da definição da função initMap -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYiAXh7HwQgCEudiSzPR3bUuYQ1mnS3b4&libraries=geometry&callback=initMap"></script>
</body>
</html>