<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doglist - Mapa</title>
    <!-- Favicon em vários tamanhos para melhor suporte -->
    <link rel="icon" href="Images/DogList-Logo.png" type="image/png" sizes="32x32">
    <link rel="icon" href="Images/DogList-Logo.png" type="image/png" sizes="96x96">
    <link rel="icon" href="Images/DogList-Logo.png" type="image/png" sizes="192x192">
    <link rel="apple-touch-icon" href="Images/DogList-Logo.png">
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset geral e estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background-color: #FFE4D6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #FFE4D6;
            position: relative;
        }

        /* Mapa */
        #map {
            flex: 1;
            width: 100%;
            background: #f0f0f0;
            z-index: 1;
            height: calc(100vh - 80px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.7);
            overflow: hidden;
            position: relative;
        }

        /* Indicador de carregamento */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px 25px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }
        
        .loading-indicator i {
            color: #FF7F50;
            animation: spin 1s linear infinite;
            font-size: 22px;
        }
        
        .loading-indicator span {
            font-weight: 500;
            color: #333;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Botão de adicionar cão */
        .add-dog-btn {
            position: absolute;
            right: 60px;
            bottom: 160px;
            background: linear-gradient(135deg, #FF7F50, #FF6347);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 127, 80, 0.4);
            border: none;
            font-size: 20px;
            transition: all 0.3s ease;
            z-index: 1000;
            text-decoration: none;
        }
        
        .add-dog-btn:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 127, 80, 0.5);
        }
        
        .add-dog-btn:active {
            transform: scale(0.95);
        }

        /* Legenda do mapa */
        .map-legend {
            position: absolute;
            bottom: 120px;
            left: 20px;
            padding: 15px;
            border-radius: 15px;
            background-color: rgba(255, 255, 255, 0.92);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 230px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .map-legend:hover {
            background-color: rgba(255, 255, 255, 0.98);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        /* Media query para desktop - posiciona a legenda */
        @media (min-width: 992px) {
            .map-legend {
                bottom: 120px;
                left: 40px;
            }
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 15px;
            color: #333;
            padding: 8px 12px;
            transition: all 0.3s ease;
            border-radius: 8px;
            border-left: 3px solid transparent;
            background-color: transparent;
        }
        
        .legend-item.clickable {
            cursor: pointer;
        }
        
        .legend-item.clickable:hover {
            background-color: rgba(255, 228, 214, 0.7);
            transform: translateX(3px);
            border-left: 3px solid #FF7F50;
        }

        .legend-color {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            margin-right: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .legend-item.clickable:hover .legend-color {
            transform: scale(1.1);
        }

        .legend-text {
            font-weight: 500;
            font-size: 15px;
        }

        #legendVoceEstaAqui {
            cursor: pointer;
        }

        #legendVoceEstaAqui:hover {
            background-color: rgba(255, 127, 80, 0.1);
        }
        
        .refresh-location {
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            margin-top: 10px;
            padding-top: 8px;
        }

        /* Navegação */
        .navigation {
            position: fixed;
            bottom: 20px;
            padding: 15px;
            background-color: #FFFFFF;
            border-radius: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -8px 30px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            margin: 0 20px 20px;
            width: calc(100% - 40px);
            border-radius: 30px;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .nav-item {
            color: #FF7F50;
            text-decoration: none;
            font-size: 26px;
            padding: 18px;
            border-radius: 22px;
            transition: all 0.3s ease;
            width: 75px;
            height: 75px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            position: relative;
            z-index: 10000;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .nav-item:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #FF7F50, #FF6347);
            opacity: 0;
            border-radius: 22px;
            transition: opacity 0.3s ease;
            z-index: -1;
        }

        .nav-item:hover:before, .nav-item:active:before {
            opacity: 0.15;
        }

        .nav-item:hover, .nav-item:active {
            color: #FF6347;
            background-color: #fff;
            box-shadow: 0 8px 20px rgba(255, 127, 80, 0.25);
            transform: translateY(-5px);
        }

        .nav-item.active {
            color: white;
            background: linear-gradient(135deg, #FF7F50, #FF6347);
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(255, 127, 80, 0.3);
        }

        .nav-item i {
            transition: all 0.3s ease;
        }

        .nav-item:hover i {
            color: #FF6347;
        }
        
        /* Estilos específicos para desktop */
        @media (min-width: 1024px) {
            #map {
                height: 100vh;
                margin: 0;
                width: 100%;
                border-radius: 0;
                border: none;
            }
            
            .map-legend {
                bottom: 120px;
                left: 40px;
                background-color: rgba(255, 255, 255, 0.92);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                padding: 12px;
                border-radius: 15px;
                min-width: 200px;
                border: 1px solid rgba(255, 255, 255, 0.8);
            }
            
            .map-legend:hover {
                background-color: rgba(255, 255, 255, 0.98);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            }
            
            .legend-item {
                display: flex;
                align-items: center;
                margin: 8px 0;
                font-size: 14px;
                color: #333;
                padding: 6px 10px;
                transition: all 0.3s ease;
                border-radius: 8px;
                border-left: 3px solid transparent;
            }
            
            .legend-item.clickable:hover {
                background-color: rgba(255, 228, 214, 0.7);
                transform: translateX(3px);
                border-left: 3px solid #FF7F50;
            }
            
            .legend-text {
                font-size: 14px;
                font-weight: 500;
            }
            
            .legend-color {
                width: 24px;
                height: 24px;
                margin-right: 12px;
            }
            
            .legend-item.clickable:hover .legend-color {
                transform: scale(1.1);
            }
            
            .navigation {
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                width: auto;
                min-width: 350px;
                max-width: 450px;
                padding: 12px 25px;
                justify-content: center;
                gap: 40px;
                background-color: rgba(255, 255, 255, 0.95);
                box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
                border-radius: 35px;
            }
            
            .nav-item {
                width: 65px;
                height: 65px;
                font-size: 24px;
                border-radius: 25px;
            }
            
            .add-dog-btn {
                right: 40px;
                bottom: 110px;
                width: 60px;
                height: 60px;
                font-size: 24px;
                box-shadow: 0 5px 20px rgba(255, 127, 80, 0.5);
            }
            
            .add-dog-btn:hover {
                transform: scale(1.08);
                box-shadow: 0 8px 30px rgba(255, 127, 80, 0.6);
            }
        }
        
        /* Ajustes para tablets */
        @media (min-width: 768px) and (max-width: 1023px) {
            #map {
                height: calc(100vh - 20px);
                margin: 10px;
                width: calc(100% - 20px);
                border-radius: 15px;
            }
            
            .map-legend {
                bottom: 120px;
                left: 25px;
                min-width: 230px;
                padding: 18px;
                backdrop-filter: blur(5px);
            }
            
            .navigation {
                width: auto;
                left: 50%;
                transform: translateX(-50%);
                max-width: 500px;
                bottom: 25px;
                padding: 12px 20px;
            }
            
            .nav-item {
                width: 70px;
                height: 70px;
            }
            
            .add-dog-btn {
                right: 30px;
                bottom: 130px;
                width: 55px;
                height: 55px;
            }
        }
        
        /* Ajustes para telas pequenas */
        @media (max-width: 767px) {
            #map {
                height: calc(100vh - 40px);
                margin: 0;
                width: 100%;
                border-radius: 0;
            }
            
            .map-legend {
                bottom: 120px;
                left: 15px;
                padding: 12px;
                min-width: 220px;
            }
            
            .legend-item {
                margin: 8px 0;
                padding: 7px 10px;
                font-size: 15px;
            }
            
            .legend-color {
                width: 26px;
                height: 26px;
                margin-right: 12px;
            }
            
            .legend-text {
                font-size: 15px;
            }
            
            .navigation {
                padding: 12px;
                margin: 0 15px 15px;
                bottom: 15px;
            }
            
            .nav-item {
                width: 65px;
                height: 65px;
                font-size: 22px;
                padding: 15px;
            }
            
            .add-dog-btn {
                right: 20px;
                bottom: 120px;
                width: 50px;
                height: 50px;
                font-size: 18px;
            }
        }
        
        @media (max-width: 480px) {
            .map-legend {
                bottom: 110px;
                left: 12px;
                padding: 10px;
                min-width: 210px;
            }
            
            .legend-item {
                margin: 7px 0;
                font-size: 14px;
                padding: 6px 10px;
            }
            
            .legend-color {
                width: 24px;
                height: 24px;
                margin-right: 12px;
            }
            
            .legend-text {
                font-size: 14px;
            }
            
            .navigation {
                padding: 10px;
                margin: 0 10px 10px;
            }
            
            .nav-item {
                width: 55px;
                height: 55px;
                font-size: 20px;
                padding: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="map"></div>
        <div class="loading-indicator" id="loadingIndicator">
            <i class="fas fa-spinner"></i>
            <span>Carregando...</span>
        </div>

        <a href="add-dog.html" class="add-dog-btn">
            <i class="fas fa-plus"></i>
        </a>

        <div class="map-legend">
            <div class="legend-item clickable" id="legendVoceEstaAqui" onclick="centerMapOnUserLocation()">
                <div class="legend-color" style="background-color: #007bff;"></div>
                <span class="legend-text">Você está aqui</span>
            </div>
            <div class="legend-item" id="legendProcurados">
                <div class="legend-color" style="background-color: #e74c3c;"></div>
                <span class="legend-text">Procurados</span>
            </div>
            <div class="legend-item" id="legendEncontrados">
                <div class="legend-color" style="background-color: #27ae60;"></div>
                <span class="legend-text">Encontrados</span>
            </div>
            <div class="legend-item clickable" id="legendAbrigos" onclick="toggleSheltersVisibility()">
                <div class="legend-color" style="background-color: #ff9800;"></div>
                <span class="legend-text">Abrigos Temporários</span>
            </div>
            <div class="legend-item clickable refresh-location" onclick="refreshUserLocation()">
                <div class="legend-color" style="background-color: #ffffff; display: flex; justify-content: center; align-items: center;">
                    <i class="fas fa-sync-alt" style="color: #FF7F50;"></i>
                </div>
                <span class="legend-text">Atualizar localização</span>
            </div>
        </div>

        <nav class="navigation">
            <a href="search.html" class="nav-item"><i class="fas fa-search"></i></a>
            <a href="account.html" class="nav-item"><i class="fas fa-user"></i></a>
            <a href="clinics.html" class="nav-item"><i class="fas fa-hospital"></i></a>
        </nav>
    </div>

    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <script>
        // Verificar se está logado
        if (!localStorage.getItem('loggedIn')) {
            window.location.href = 'index.html';
        }
        
        // Variáveis globais
        let map;
        let userMarker;
        let petMarkers = [];
        let shelterMarkers = [];
        let infoWindow;
        let geocoder;
        let currentOpenInfoWindow = null;
        
        // Variáveis para controlar visibilidade
        let showingOnlyShelters = false;
        let procuradosVisible = true;
        let encontradosVisible = true;
        
        function initMap() {
            try {
                console.log("Iniciando função initMap");
                document.getElementById('loadingIndicator').style.display = 'flex';
                
                // Verificar se o elemento map existe
                const mapElement = document.getElementById('map');
                if (!mapElement) {
                    console.error("Elemento 'map' não encontrado no DOM!");
                    return;
                }
                
                // Mostrar dimensões do mapa para debug
                console.log("Dimensões do mapa:", mapElement.offsetWidth, "x", mapElement.offsetHeight);
            
                // Carregar mapa
                map = new google.maps.Map(mapElement, {
                    center: { lat: -23.550520, lng: -46.633308 }, // São Paulo
                    zoom: 12,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControl: true,
                mapTypeControlOptions: {
                        style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                        position: google.maps.ControlPosition.TOP_RIGHT
                },
                fullscreenControl: true,
                    fullscreenControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP
                    },
                    streetViewControl: true,
                    streetViewControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP
                    },
                    zoomControl: true,
                    zoomControlOptions: {
                        position: google.maps.ControlPosition.RIGHT_TOP
                    }
                });
                
                // Verificar se o mapa foi inicializado corretamente
                if (!map) {
                    console.error("Falha ao inicializar o mapa. O objeto do mapa é indefinido.");
                    return;
                }
                
                console.log("Mapa inicializado com sucesso!");
                
                // Criar infowindow para uso global
                infoWindow = new google.maps.InfoWindow({
                    maxWidth: 300,
                    disableAutoPan: false
                });
                
                // Inicializar o tema de mapa padrão
                const savedMapType = localStorage.getItem('mapType') || 'roadmap';
                map.setMapTypeId(savedMapType);
                
                // Tentar obter localização salva
                const savedLocation = getSavedLocation();
                if (savedLocation) {
                    console.log("Localização salva encontrada:", savedLocation);
                    // Centralizar mapa na localização salva
                    map.setCenter(savedLocation);
                    
                    // Adicionar marcador do usuário
                    addUserMarker(savedLocation);
                } else {
                    console.log("Nenhuma localização salva, tentando obter localização atual");
                    // Tentar obter localização do usuário
                    requestUserLocation();
                }
                
                // Evento para marcar como finalizado o carregamento do mapa
                google.maps.event.addListenerOnce(map, 'idle', function() {
                    console.log("Mapa carregado e pronto");
                    document.getElementById('loadingIndicator').style.display = 'none';
                    
                    // Carregar todos os cães
                    loadAllDogs();
                });
                
                console.log("Função initMap concluída com sucesso");
            } catch (error) {
                console.error("ERRO ao inicializar o mapa:", error);
                alert("Ocorreu um erro ao inicializar o mapa. Por favor, tente recarregar a página.");
            }
        }
        
        function getSavedLocation() {
            const savedLat = localStorage.getItem('userLocationLat');
            const savedLng = localStorage.getItem('userLocationLng');
            
            if (savedLat && savedLng) {
                return {
                    lat: parseFloat(savedLat),
                    lng: parseFloat(savedLng)
                };
            }
            
            return null;
        }
        
        function saveUserLocation(location) {
            localStorage.setItem('userLocationLat', location.lat);
            localStorage.setItem('userLocationLng', location.lng);
        }
        
        function addUserMarker(location) {
            // Remover marcador existente, se houver
            if (userMarker) {
                userMarker.setMap(null);
            }
            
            // Criar novo marcador do usuário
            userMarker = new google.maps.Marker({
                position: location,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: '#007bff',
                    fillOpacity: 0.9,
                    strokeColor: '#FFFFFF',
                    strokeWeight: 2,
                    scale: 8
                },
                title: 'Sua localização',
                zIndex: 10
            });

            // Adicionar evento de clique ao marcador
            userMarker.addListener('click', () => {
                showLocationPopup(userMarker);
            });

            return userMarker;
        }
        
        function addPetMarkers() {
            // Limpar marcadores existentes
            clearPetMarkers();
            
            const allDogs = JSON.parse(localStorage.getItem('allDogs') || '[]');
            console.log(`Carregando ${allDogs.length} cães:`, allDogs);
            
            if (allDogs.length === 0) {
                console.log('Nenhum cão cadastrado para exibir no mapa');
                return;
            }
            
            allDogs.forEach((dog) => {
                    if (dog.location && dog.location.lat && dog.location.lng) {
                    addDogMarker(dog);
                }
            });
            
            // Também recarregar abrigos temporários
            loadTemporaryShelters();
        }
        
        function addDogMarker(dog) {
            try {
                // Log detalhado para diagnóstico
                console.log('Tentando adicionar marcador para:', dog);
                
                // Verificar e normalizar a localização
                let lat, lng;
                
                if (dog.location) {
                    // Verificar se location é um objeto com lat/lng
                    if (typeof dog.location === 'object') {
                        if (dog.location.lat !== undefined && dog.location.lng !== undefined) {
                            // Formatar lat/lng
                            lat = parseFloat(dog.location.lat);
                            lng = parseFloat(dog.location.lng);
                        } else if (dog.location.latitude !== undefined && dog.location.longitude !== undefined) {
                            // Formato alternativo com latitude/longitude
                            lat = parseFloat(dog.location.latitude);
                            lng = parseFloat(dog.location.longitude);
                        }
                    } else if (typeof dog.location === 'string') {
                        // Tentar extrair coordenadas de uma string
                        try {
                            const locationObj = JSON.parse(dog.location);
                            lat = parseFloat(locationObj.lat || locationObj.latitude);
                            lng = parseFloat(locationObj.lng || locationObj.longitude);
                        } catch (e) {
                            console.error('Falha ao converter location string para objeto:', e);
                        }
                    }
                } else if (dog.lat !== undefined && dog.lng !== undefined) {
                    // Coordenadas diretamente no objeto do cão
                    lat = parseFloat(dog.lat);
                    lng = parseFloat(dog.lng);
                } else if (dog.latitude !== undefined && dog.longitude !== undefined) {
                    // Formato alternativo diretamente no objeto do cão
                    lat = parseFloat(dog.latitude);
                    lng = parseFloat(dog.longitude);
                }
                
                if (isNaN(lat) || isNaN(lng)) {
                    console.error('Coordenadas inválidas após tentativa de normalização:', {lat, lng, dog});
                    return null;
                }
                
                console.log(`Criando marcador em ${lat}, ${lng} para ${dog.nome || dog.raca || 'Sem nome'}`);
                
                // Definir cor e texto de status com base no estado do cachorro
                const statusColor = dog.estado === 'procurado' ? '#ff6b6b' : '#4ecdc4';
                const statusText = dog.estado === 'procurado' ? 'Procurado' : 'Encontrado';
                
                // Define o ícone com base no estado do cachorro
                const pawIconPath = dog.estado === 'procurado' ? 
                    'M12,4C7.58,4 4,7.58 4,12C4,16.42 7.58,20 12,20C16.42,20 20,16.42 20,12C20,7.58 16.42,4 12,4M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M10,17L5,12L6.41,10.59L10,14.17L17.59,6.58L19,8L10,17Z' : 
                    'M12,4C7.58,4 4,7.58 4,12C4,16.42 7.58,20 12,20C16.42,20 20,16.42 20,12C20,7.58 16.42,4 12,4M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M10,17L5,12L6.41,10.59L10,14.17L17.59,6.58L19,8L10,17Z';
                
                // Criar um ícone SVG personalizado com base no estado
                const pawColor = dog.estado === 'procurado' ? '#ff0000' : '#00ff00';
                
                const svgMarker = {
                                path: google.maps.SymbolPath.CIRCLE,
                    fillColor: pawColor,
                    fillOpacity: 1,
                    strokeWeight: 1,
                    strokeColor: '#ffffff',
                                scale: 10
                };
                
                // Determinar se o marcador deve ser visível com base no tipo
                const isVisible = dog.estado === 'procurado' ? procuradosVisible : encontradosVisible;
                
                // Criar o marcador com o ícone customizado
                const marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: showingOnlyShelters ? null : map,
                    icon: svgMarker,
                    title: dog.nome || dog.raca || 'Cachorro sem nome',
                    animation: google.maps.Animation.DROP
                        });
                        
                // Armazenar os dados do cão no marcador para facilitar filtragem
                marker.dogData = dog;
                        
                // Criar o conteúdo da InfoWindow com estilo melhorado
                const contentString = `
                    <div style="width: 220px; background-color: white; padding: 0; overflow: hidden; border-radius: 10px;">
                        <div style="margin: 0; padding: 0;">
                            <div style="text-align: center; margin: 5px 0 25px 0;">
                                <span style="display: inline-block; padding: 3px 12px; background-color: ${dog.estado === 'procurado' ? '#ff0000' : '#27ae60'}; color: white; border-radius: 20px; font-size: 12px; font-weight: bold;">
                                    ${dog.estado === 'procurado' ? 'Procurado' : 'Encontrado'}
                                </span>
                            </div>
                            ${dog.image ? 
                            `<div style="text-align: center; margin: 0 0 8px 0;">
                                <img src="${dog.image}" style="width: 140px; height: 140px; object-fit: cover; border-radius: 0px;" onerror="this.src='Images/dog-placeholder.jpg'">
                            </div>` : ''}
                            <div style="text-align: center; margin: 0 0 8px 0;">
                                <span style="margin: 0; font-size: 16px; color: #333;">${dog.raca || 'Não especificada'}</span>
                            </div>
                            <div style="margin: 0 0 8px; font-size: 12px; color: #666; text-align: center;">
                                <div style="display: flex; align-items: center; justify-content: center; padding-left: 15px;">
                                    <i class="fas fa-map-marker-alt" style="color: #ff6b38; margin-right: 5px; font-size: 11px; position: relative; top: -1px;"></i>
                                    <span>${dog.endereco || 'Localização não especificada'}</span>
                            </div>
                            </div>
                            <div style="padding: 0 15px 15px;">
                                <button onclick="location.href='animal-details.html?id=${dog.id}'" style="background: #ff7f50; color: white; padding: 10px 0; border: none; border-radius: 20px; cursor: pointer; width: 100%; text-align: center; font-size: 14px;">
                                    <span style="display: inline-flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-paw" style="margin-right: 5px; font-size: 14px;"></i>Ver Detalhes
                                    </span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                            
                // Usar configurações adicionais para evitar problemas com o InfoWindow
                const infoWindow = new google.maps.InfoWindow({
                    content: contentString,
                    maxWidth: 220,
                    pixelOffset: new google.maps.Size(0, 0),
                    disableAutoPan: false
                });
                
                // Adicionar evento para aplicar estilos após abrir
                google.maps.event.addListener(infoWindow, 'domready', function() {
                    styleInfoWindow();
                });
                
                // Armazenar o infoWindow no marcador para referência futura
                marker.infoWindow = infoWindow;
                
                // Adicionar o marcador ao array
                        petMarkers.push(marker);
                
                // Adicionar evento de clique para abrir o InfoWindow
                marker.addListener('click', function() {
                    // Fechar qualquer InfoWindow aberto
                    if (currentOpenInfoWindow) {
                        currentOpenInfoWindow.close();
                    }
                    
                    // Abrir o novo InfoWindow
                    infoWindow.open(map, marker);
                    currentOpenInfoWindow = infoWindow;
                    
                    // Animar o marcador quando clicado
                    if (marker.getAnimation() !== null) {
                        marker.setAnimation(null);
                    } else {
                        marker.setAnimation(google.maps.Animation.BOUNCE);
                    setTimeout(() => {
                            marker.setAnimation(null);
                        }, 750);
                    }
                    
                    // Estilizar o InfoWindow após abertura
                    setTimeout(styleInfoWindow, 10);
                });
                
                console.log('Marcador criado com sucesso:', marker);
                
                return marker;
            } catch (error) {
                console.error('Erro ao criar marcador para o cão:', error);
                return null;
            }
        }
        
        function styleInfoWindow() {
            setTimeout(() => {
                try {
                    // Remover a seta do InfoWindow
                    const arrows = document.querySelectorAll('.gm-style-iw-t::after');
                    arrows.forEach(arrow => {
                        if (arrow) arrow.style.display = 'none';
                    });
                    
                    // Estilizar o container principal
                    const containers = document.querySelectorAll('.gm-style-iw-c');
                    containers.forEach(container => {
                        container.style.padding = '0 !important';
                        container.style.borderRadius = '10px !important';
                        container.style.overflow = 'hidden !important';
                        container.style.boxShadow = '0 2px 7px rgba(0, 0, 0, 0.15) !important';
                    });
                    
                    // Estilizar os containers internos
                    const innerContainers = document.querySelectorAll('.gm-style-iw-d');
                    innerContainers.forEach(innerContainer => {
                        innerContainer.style.overflow = 'hidden !important';
                        innerContainer.style.padding = '0 !important';
                    });

                    // Estilizar o botão de fechar
                    const closeButtons = document.querySelectorAll('button.gm-ui-hover-effect');
                    closeButtons.forEach(button => {
                        button.style.top = '0px !important';
                        button.style.right = '0px !important';
                    });

                    // Adicionar CSS para simplificar estilos
                    const style = document.createElement('style');
                    style.textContent = `
                        .gm-style-iw-d::-webkit-scrollbar { display: none; }
                        .gm-style-iw { padding: 0 !important; }
                        .gm-ui-hover-effect { opacity: 1 !important; }
                        .gm-ui-hover-effect img { opacity: 1 !important; }
                    `;
                    document.head.appendChild(style);
                } catch (error) {
                    console.error('Erro ao estilizar InfoWindow:', error);
                }
            }, 50);
        }

        function clearPetMarkers() {
            // Limpar todos os marcadores existentes
            petMarkers.forEach(marker => marker.setMap(null));
            petMarkers = [];
        }

        function clearShelterMarkers() {
            // Limpar marcadores de abrigos existentes
            shelterMarkers.forEach(marker => marker.setMap(null));
            shelterMarkers = [];
        }
        
        function loadAllDogs() {
            try {
                // Carregar todos os cães
                const allDogsData = localStorage.getItem('allDogs');
                if (!allDogsData) {
                    console.log('Nenhum dado de cães encontrado');
            return;
                }
                
                // Adicionar todos os cães ao mapa
                addPetMarkers();
            } catch (error) {
                console.error('Erro ao carregar cães:', error);
            }
        }
        
        function loadTemporaryShelters() {
            try {
                const sheltersData = localStorage.getItem('shelters');
                if (!sheltersData) {
                    console.log('Nenhum abrigo temporário encontrado');
                    return;
                }
                
                const shelters = JSON.parse(sheltersData);
                console.log(`Carregando ${shelters.length} abrigos temporários`);
                
                // Adicionar marcadores de abrigo ao mapa
                addShelterMarkers(shelters);
            } catch (error) {
                console.error('Erro ao carregar abrigos temporários:', error);
            }
        }
        
        function addShelterMarkers(shelters) {
            // Limpar marcadores de abrigos existentes
            clearShelterMarkers();
            
            shelters.forEach(shelter => {
                if (shelter.location && shelter.location.lat && shelter.location.lng) {
                    // Criar marcador de abrigo
                    const marker = new google.maps.Marker({
                        position: { 
                            lat: parseFloat(shelter.location.lat), 
                            lng: parseFloat(shelter.location.lng) 
                        },
                        map: showingOnlyShelters ? map : null, // Invisível inicialmente
                        title: 'Abrigo Temporário',
                        animation: google.maps.Animation.DROP,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            fillColor: '#ff9800',
                            fillOpacity: 0.9,
                            strokeColor: '#FFFFFF',
                            strokeWeight: 2,
                            scale: 10
                        }
                    });
                    
                    // Criar conteúdo inicial simples para infoWindow (apenas morada e contato)
                    const basicContent = `
                        <div style="width: 220px; background-color: white; padding: 0; overflow: hidden; border-radius: 10px;">
                            <div style="text-align: center; margin: 5px 0 25px 0;">
                                <span style="display: inline-block; padding: 3px 12px; background-color: #ff9800; color: white; border-radius: 20px; font-size: 12px; font-weight: bold;">
                                    Abrigo Temporário
                                </span>
                    </div>
                            <div style="margin: 0 0 8px; font-size: 14px; color: #333; text-align: center; padding: 0 15px;">
                                <div style="margin-bottom: 10px;">
                                    <i class="fas fa-user" style="color: #ff9800; margin-right: 5px;"></i>
                                    <span style="font-size: 13px;">${shelter.userName || 'Anônimo'}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <i class="fas fa-map-marker-alt" style="color: #ff9800; margin-right: 5px;"></i>
                                    <span style="font-size: 13px;">${shelter.endereco || 'Localização não especificada'}</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <i class="fas fa-phone" style="color: #ff9800; margin-right: 5px;"></i>
                                    <span style="font-size: 13px;">${shelter.contacto || 'Contato não disponível'}</span>
                                </div>
                            </div>
                            <div style="padding: 0 15px 15px;">
                                <a href="shelter-details.html?id=${shelter.id}" class="view-shelter-btn" style="background: #ff9800; color: white; padding: 10px 0; border: none; border-radius: 20px; cursor: pointer; width: 100%; text-align: center; font-size: 14px; display: block; text-decoration: none;">
                                    <span style="display: inline-flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-info-circle" style="margin-right: 5px;"></i>Ver Detalhes
                                    </span>
                        </a>
                    </div>
                </div>
            `;
            
                    // Criar infoWindow com conteúdo básico inicial
                    const infoWindow = new google.maps.InfoWindow({
                        content: basicContent,
                        maxWidth: 220
                    });
                    
                    // Guardar referência ao marcador e ao infoWindow
                    marker.infoWindow = infoWindow;
                    marker.shelterData = shelter;
                    shelterMarkers.push(marker);
                    
                    // Adicionar evento de clique para mostrar infoWindow
                    marker.addListener('click', function() {
                        // Fechar qualquer infoWindow aberto
                        if (currentOpenInfoWindow) {
                            currentOpenInfoWindow.close();
                        }
                        
                        // Abrir novo infoWindow com informações básicas
                        infoWindow.setContent(basicContent);
                        infoWindow.open(map, marker);
                        currentOpenInfoWindow = infoWindow;
                        
                        // Aplicar estilos ao infoWindow
                        setTimeout(styleInfoWindow, 10);
                    });
                }
            });
        }
        
        // Função para criar conteúdo detalhado do abrigo
        function createShelterDetailedContent(shelter) {
            // Criar listas de características aceitas
            const porteList = createListItems(shelter.aceita.porte, {
                'small': 'Pequeno',
                'medium': 'Médio',
                'large': 'Grande'
            });
            
            const idadeList = createListItems(shelter.aceita.idade, {
                '0-5': '0-5 anos',
                '5-10': '5-10 anos',
                '10+': '+10 anos'
            });
            
            const sexoList = createListItems(shelter.aceita.sexo, {
                'male': 'Macho',
                'female': 'Fêmea'
            });
            
            const castradoList = createListItems(shelter.aceita.castrado, {
                'yes': 'Sim',
                'no': 'Não'
            });
            
            const agresivoList = createListItems(shelter.aceita.agressivo, {
                'none': 'Não agressivo',
                'humans': 'Agressivo com pessoas',
                'animals': 'Agressivo com animais',
                'both': 'Agressivo com pessoas e animais'
            });
            
            return `
                <div style="width: 280px; background-color: white; padding: 0; overflow: hidden; border-radius: 10px;">
                    <div style="text-align: center; margin: 5px 0 15px 0;">
                        <span style="display: inline-block; padding: 3px 12px; background-color: #ff9800; color: white; border-radius: 20px; font-size: 12px; font-weight: bold;">
                            Abrigo Temporário
                        </span>
                    </div>
                    
                    <div style="margin: 0 0 15px; font-size: 14px; color: #333; text-align: left; padding: 0 15px;">
                        <div style="margin-bottom: 10px;">
                            <i class="fas fa-user" style="color: #ff9800; margin-right: 5px;"></i>
                            <span style="font-size: 13px;">${shelter.userName || 'Anônimo'}</span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <i class="fas fa-map-marker-alt" style="color: #ff9800; margin-right: 5px;"></i>
                            <span style="font-size: 13px;">${shelter.endereco || 'Localização não especificada'}</span>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <i class="fas fa-phone" style="color: #ff9800; margin-right: 5px;"></i>
                            <span style="font-size: 13px;">${shelter.contacto || 'Contato não disponível'}</span>
                        </div>
                    </div>
                    
                    <div style="background-color: #fafafa; padding: 15px; border-top: 1px solid #eee;">
                        <h4 style="font-size: 14px; margin-bottom: 15px; color: #333; text-align: center;">Animais que aceita</h4>
                        
                        <div style="margin-bottom: 10px;">
                            <h5 style="font-size: 13px; margin-bottom: 5px; color: #ff9800;">Porte:</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">${porteList}</div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <h5 style="font-size: 13px; margin-bottom: 5px; color: #ff9800;">Idade:</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">${idadeList}</div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <h5 style="font-size: 13px; margin-bottom: 5px; color: #ff9800;">Sexo:</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">${sexoList}</div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <h5 style="font-size: 13px; margin-bottom: 5px; color: #ff9800;">Castrado:</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">${castradoList}</div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <h5 style="font-size: 13px; margin-bottom: 5px; color: #ff9800;">Agressividade:</h5>
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">${agresivoList}</div>
                        </div>
                    </div>
                    
                    <div style="padding: 15px;">
                        <button onclick="backToBasicInfo('${shelter.id}')" style="background: #ff9800; color: white; padding: 10px 0; border: none; border-radius: 20px; cursor: pointer; width: 100%; text-align: center; font-size: 14px;">
                            <span style="display: inline-flex; align-items: center; justify-content: center;">
                                <i class="fas fa-arrow-left" style="margin-right: 5px;"></i>Voltar
                            </span>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Função auxiliar para criar lista de opções estilizadas
        function createListItems(itemsArray, labels) {
            if (!itemsArray || itemsArray.length === 0) {
                return '<span style="font-size: 12px; color: #999; font-style: italic;">Nenhuma opção selecionada</span>';
            }
            
            return itemsArray.map(item => {
                const label = labels[item] || item;
                return `<span style="font-size: 12px; background-color: #fff3e0; color: #ff9800; padding: 3px 8px; border-radius: 10px; border: 1px solid #ffe0b2;">${label}</span>`;
            }).join('');
        }
        
        // Função para voltar à visualização básica do abrigo
        function backToBasicInfo(shelterId) {
            const marker = shelterMarkers.find(m => m.shelterData.id === shelterId);
            if (marker && marker.infoWindow) {
                // Fechar infowindow atual
                marker.infoWindow.close();
                
                // Reabrir com informações básicas
                if (marker.shelterData) {
                    const basicContent = `
                        <div style="width: 220px; background-color: white; padding: 0; overflow: hidden; border-radius: 10px;">
                            <div style="text-align: center; margin: 5px 0 25px 0;">
                                <span style="display: inline-block; padding: 3px 12px; background-color: #ff9800; color: white; border-radius: 20px; font-size: 12px; font-weight: bold;">
                                    Abrigo Temporário
                                </span>
                            </div>
                            <div style="margin: 0 0 8px; font-size: 14px; color: #333; text-align: center; padding: 0 15px;">
                                <div style="margin-bottom: 10px;">
                                    <i class="fas fa-user" style="color: #ff9800; margin-right: 5px;"></i>
                                    <span style="font-size: 13px;">${marker.shelterData.userName || 'Anônimo'}</span>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <i class="fas fa-map-marker-alt" style="color: #ff9800; margin-right: 5px;"></i>
                                    <span style="font-size: 13px;">${marker.shelterData.endereco || 'Localização não especificada'}</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <i class="fas fa-phone" style="color: #ff9800; margin-right: 5px;"></i>
                                    <span style="font-size: 13px;">${marker.shelterData.contacto || 'Contato não disponível'}</span>
                                </div>
                            </div>
                            <div style="padding: 0 15px 15px;">
                                <a href="shelter-details.html?id=${shelterId}" class="view-shelter-btn" style="background: #ff9800; color: white; padding: 10px 0; border: none; border-radius: 20px; cursor: pointer; width: 100%; text-align: center; font-size: 14px; display: block; text-decoration: none;">
                                    <span style="display: inline-flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-info-circle" style="margin-right: 5px;"></i>Ver Detalhes
                                    </span>
                                </a>
                            </div>
                        </div>
                    `;
                    
                    marker.infoWindow.setContent(basicContent);
                    marker.infoWindow.open(map, marker);
                    
                    // Configurar evento para o botão "Ver Detalhes"
                    google.maps.event.addListenerOnce(marker.infoWindow, 'domready', function() {
                        document.getElementById(`viewShelterDetails-${shelterId}`).addEventListener('click', function() {
                            // Atualizar para conteúdo detalhado
                            const detailedContent = createShelterDetailedContent(marker.shelterData);
                            marker.infoWindow.setContent(detailedContent);
                            styleInfoWindow();
                        });
                    });
                    
                    // Aplicar estilos
                    setTimeout(styleInfoWindow, 10);
                }
            }
        }
        
        // Função para alternar a visibilidade dos abrigos temporários
        function toggleSheltersVisibility() {
            const legendItem = document.getElementById('legendAbrigos');
            const legendProcurados = document.getElementById('legendProcurados');
            const legendEncontrados = document.getElementById('legendEncontrados');
            
            if (!showingOnlyShelters) {
                // Mostrar apenas abrigos (esconder cães)
                shelterMarkers.forEach(marker => marker.setMap(map));
                petMarkers.forEach(marker => marker.setMap(null));
                
                // Atualizar aparência das legendas
                legendItem.style.opacity = '1';
                legendItem.querySelector('.legend-color').style.opacity = '1';
                legendProcurados.style.opacity = '0.5';
                legendProcurados.querySelector('.legend-color').style.opacity = '0.3';
                legendEncontrados.style.opacity = '0.5';
                legendEncontrados.querySelector('.legend-color').style.opacity = '0.3';
                
                showingOnlyShelters = true;
            } else {
                // Mostrar apenas cães (esconder abrigos)
                shelterMarkers.forEach(marker => marker.setMap(null));
                petMarkers.forEach(marker => marker.setMap(map));
                
                // Atualizar aparência das legendas
                legendItem.style.opacity = '0.5';
                legendItem.querySelector('.legend-color').style.opacity = '0.3';
                legendProcurados.style.opacity = '1';
                legendProcurados.querySelector('.legend-color').style.opacity = '1';
                legendEncontrados.style.opacity = '1';
                legendEncontrados.querySelector('.legend-color').style.opacity = '1';
                
                showingOnlyShelters = false;
            }
            
            // Efeito visual de feedback
            legendItem.style.backgroundColor = 'rgba(255, 152, 0, 0.1)';
            setTimeout(() => {
                legendItem.style.backgroundColor = '';
            }, 300);
        }

        function centerMapOnUserLocation() {
            const savedLocation = getSavedLocation();
            
            if (savedLocation) {
                // Centralizar mapa na localização salva
                map.setCenter(savedLocation);
                
                // Se não houver marcador, adicioná-lo
                if (!userMarker) {
                    addUserMarker(savedLocation);
                } else {
                    // Animar marcador existente
                    userMarker.setAnimation(google.maps.Animation.BOUNCE);
                    setTimeout(() => {
                        userMarker.setAnimation(null);
                    }, 1400);
                }
                
                // Animar a transição com zoom mais próximo
                map.setZoom(18);
                
                // Mostrar popup de localização
                showLocationPopup(userMarker);
            } else {
                // Se não tiver localização salva, solicitar
                requestUserLocation();
            }
        }

        function requestUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Salvar localização para uso futuro
                        saveUserLocation(userLocation);
                        
                        // Centralizar mapa na localização do usuário
                        map.setCenter(userLocation);
                        map.setZoom(15);
                        
                        // Adicionar marcador do usuário
                        addUserMarker(userLocation);
                    },
                    (error) => {
                        console.error('Erro ao obter localização:', error);
                        alert('Não foi possível obter sua localização. Verifique as permissões do seu navegador.');
                    },
                    { timeout: 10000, maximumAge: 600000 }
                );
            } else {
                alert('Seu navegador não suporta geolocalização.');
            }
        }
        
        function refreshUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const newLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        // Salvar localização para uso futuro
                        saveUserLocation(newLocation);
                        
                        // Centralizar mapa na nova localização
                        map.setCenter(newLocation);
                        map.setZoom(16);

                        // Adicionar marcador do usuário na nova localização
                        addUserMarker(newLocation);
                        
                        alert('Localização atualizada com sucesso!');
                    },
                    (error) => {
                        console.error('Erro ao atualizar localização:', error);
                        alert('Não foi possível atualizar sua localização. Verifique as permissões do seu navegador.');
                    }
                );
            } else {
                alert('Seu navegador não suporta geolocalização.');
            }
        }

        function showLocationPopup(marker) {
            // Fechar qualquer infowindow aberta anteriormente
            if (infoWindow) {
                infoWindow.close();
            }
            
            // Abordagem simples e confiável
            const tempPopup = document.createElement('div');
            tempPopup.style.cssText = `
                position: fixed;
                top: 45%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: white;
                padding: 10px 15px;
                border-radius: 20px;
                border: 2px solid rgba(0, 123, 255, 0.5);
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                display: flex;
                align-items: center;
                font-family: Arial, sans-serif;
                font-size: 13px;
                font-weight: 600;
                color: #333;
            `;
            
            tempPopup.innerHTML = `
                <i class="fas fa-location-arrow" style="color: #007bff; margin-right: 8px;"></i>
                Você está aqui
            `;
            
            document.body.appendChild(tempPopup);
            
            // Remover após 3 segundos
            setTimeout(() => {
                if (document.body.contains(tempPopup)) {
                    document.body.removeChild(tempPopup);
                }
            }, 3000);
        }
        
        // Adicionar evento de clique em cada item da legenda
        document.addEventListener('DOMContentLoaded', function() {
            // Itens da legenda
            const legendItems = document.querySelectorAll('.legend-item');
            
            legendItems.forEach(item => {
                item.addEventListener('click', function() {
                    setTimeout(() => {
                        this.blur();
                    }, 100);
                });
            });
        });
    </script>
    
    <!-- Carregue o script do Google Maps depois da definição da função initMap -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYiAXh7HwQgCEudiSzPR3bUuYQ1mnS3b4&libraries=geometry&callback=initMap"></script>
</body>
</html>